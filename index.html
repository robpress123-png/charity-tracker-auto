<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity Tracker - Clean Rebuild</title>
    <!-- Tailwind CSS CDN (for development only - consider PostCSS for production) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #7c3aed 50%, #059669 100%);
        }
        .card {
            @apply bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-100;
        }
        .card-header {
            @apply flex items-center justify-between mb-4 pb-4 border-b border-gray-200;
        }
        .btn-primary {
            @apply bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5 cursor-pointer;
        }
        .btn-success {
            @apply bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5 cursor-pointer;
        }
        .btn-hero {
            @apply bg-gradient-to-r from-green-500 to-emerald-500 text-white px-10 py-4 rounded-xl hover:from-green-600 hover:to-emerald-600 transition-all duration-300 font-bold text-lg shadow-xl hover:shadow-2xl transform hover:-translate-y-1 cursor-pointer border-0 min-w-48;
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4), 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-hero:hover {
            box-shadow: 0 15px 35px rgba(34, 197, 94, 0.6), 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        .btn-hero-secondary {
            @apply bg-gradient-to-r from-blue-500 to-purple-500 text-white px-10 py-4 rounded-xl hover:from-blue-600 hover:to-purple-600 transition-all duration-300 font-bold text-lg shadow-xl hover:shadow-2xl transform hover:-translate-y-1 cursor-pointer border-0 min-w-48;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4), 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-hero-secondary:hover {
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.6), 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            @apply bg-gradient-to-r from-gray-600 to-gray-700 text-white px-4 py-2 rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all duration-200 font-medium;
        }
        .status-badge {
            @apply px-3 py-1 rounded-full text-sm font-medium;
        }
        .status-online {
            @apply bg-green-100 text-green-800;
        }
        .status-verified {
            @apply bg-emerald-100 text-emerald-800;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors;
        }
        .section-title {
            @apply text-2xl font-bold text-gray-800 mb-2;
        }
        .section-subtitle {
            @apply text-gray-600 mb-6;
        }
        .metric-card {
            @apply bg-gradient-to-br p-4 rounded-lg text-white;
        }
        .metric-value {
            @apply text-2xl font-bold;
        }
        .metric-label {
            @apply text-sm opacity-90;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-xl">
        <div class="container mx-auto px-4 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-2">
                        <span class="text-yellow-300">üíù</span> Charity Tracker Pro <span class="text-sm text-yellow-300" id="frontend-version">v2.1.2</span>
                    </h1>
                    <p class="text-blue-100 text-lg">Complete Tax-Optimized Donation Management Platform - <span class="text-yellow-300 font-semibold">v2.1.2</span></p>
                    <p class="text-xs text-blue-200">
                        Frontend: <span id="frontend-build">Build 2025.01.17-02</span> |
                        Backend: <span id="backend-version">Checking...</span>
                    </p>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold">2025</div>
                        <div class="text-sm opacity-75">Tax Year</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold">üèÜ</div>
                        <div class="text-sm opacity-75">Pro Version</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-yellow-300" id="app-version">v2.1.2</div>
                        <div class="text-xs opacity-75">Build 2025.01.17</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Persistent Navigation Bar (for authenticated users) -->
    <div id="main-nav" class="bg-white shadow-md border-b" style="display: none;">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-3">
                <div class="flex space-x-6">
                    <button onclick="showDashboard()" class="flex items-center px-4 py-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                        <span class="mr-2">üè†</span>
                        Dashboard
                    </button>
                    <button onclick="showAddDonation()" class="flex items-center px-4 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors">
                        <span class="mr-2">üíù</span>
                        Add Donation
                    </button>
                    <button id="reports-nav-btn" class="flex items-center px-4 py-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors">
                        <span class="mr-2">üìä</span>
                        Reports
                    </button>
                    <button id="profile-nav-btn" class="flex items-center px-4 py-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                        <span class="mr-2">üë§</span>
                        Profile
                    </button>
                </div>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                    <span id="nav-user-name">User</span>
                    <div class="relative">
                        <button onclick="toggleTaxYearDropdown()" class="flex items-center px-3 py-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors border border-blue-200">
                            <span class="mr-1">üìÖ</span>
                            <span id="current-tax-year">2025</span> Tax Year
                            <span class="ml-1">‚ñº</span>
                        </button>
                        <div id="tax-year-dropdown" class="absolute right-0 mt-1 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-50" style="display: none;">
                            <button onclick="selectTaxYear(2025)" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-t-lg">2025 Tax Year</button>
                            <button onclick="selectTaxYear(2026)" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600">2026 Tax Year</button>
                            <button onclick="selectTaxYear(2027)" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-b-lg">2027 Tax Year</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">

        <!-- Authentication Section -->
        <div id="auth-section" class="card" style="display: none;">
            <div class="card-header">
                <h2 class="section-title">üîê Authentication</h2>
                <button onclick="showDashboard()" class="btn-secondary">‚Üê Back to Dashboard</button>
            </div>
            <div class="flex mb-4">
                <button id="login-tab" onclick="showLogin()" class="px-4 py-2 bg-blue-600 text-white rounded-l-lg">Login</button>
                <button id="register-tab" onclick="showRegister()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-r-lg">Register</button>
            </div>
            <div id="login-form">
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="login-email" class="input-field" placeholder="your@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="login-password" class="input-field" placeholder="Password" onkeypress="handleLoginEnter(event)">
                    </div>
                </div>
                <div class="mb-4 space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="remember-me" class="mr-2 rounded">
                        <span class="text-sm text-gray-600">Remember me (keep me logged in for 7 days)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="admin-login" class="mr-2 rounded">
                        <span class="text-sm text-gray-600">Login as Administrator</span>
                    </label>
                </div>
                <button onclick="handleLogin()" class="btn-primary">Login</button>
            </div>
            <div id="register-form" style="display: none;">
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Full Name</label>
                        <input type="text" id="register-name" class="input-field" placeholder="John Doe">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="register-email" class="input-field" placeholder="your@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="register-password" class="input-field" placeholder="8+ chars, mixed case, number" onkeypress="handleRegisterEnter(event)">
                    </div>
                </div>
                <button onclick="handleRegister()" class="btn-success">Create Account</button>
            </div>
            <div id="user-info" style="display: none;" class="bg-green-50 p-4 rounded-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-medium" id="user-name"></div>
                        <div class="text-sm text-gray-600" id="user-email"></div>
                        <div class="text-sm text-green-600" id="user-license"></div>
                    </div>
                    <button onclick="handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
                </div>
            </div>
            <div id="auth-message" class="mt-4"></div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="space-y-6">
            <!-- Landing Page for Non-Authenticated Users -->
            <div id="landing-page">
                <!-- Hero Section -->
                <div class="card text-center">
                    <div class="max-w-4xl mx-auto">
                        <div class="text-6xl mb-6">üíù</div>
                        <h2 class="text-4xl font-bold text-gray-800 mb-4">Maximize Your Tax Savings</h2>
                        <p class="text-xl text-gray-600 mb-8">Track all donation types, get accurate valuations, and generate tax-ready reports with our comprehensive charity tracking platform.</p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                            <button onclick="showRegister()" class="btn-hero">
                                üöÄ Get Started Free
                            </button>
                            <button onclick="showLogin()" class="btn-hero-secondary">
                                üë§ Sign In
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="card text-center">
                        <div class="text-4xl mb-4">üíµ</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">5 Donation Types</h3>
                        <p class="text-gray-600">Track money, items, mileage, stock, and crypto donations with automatic tax calculations and IRS compliance.</p>
                    </div>
                    <div class="card text-center">
                        <div class="text-4xl mb-4">üìä</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Tax-Ready Reports</h3>
                        <p class="text-gray-600">Generate consolidated summaries and detailed line-item reports. Export CSV files ready for your tax preparer.</p>
                    </div>
                    <div class="card text-center">
                        <div class="text-4xl mb-4">üéØ</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Smart Valuations</h3>
                        <p class="text-gray-600">Get accurate item valuations based on IRS guidelines and current mileage rates (14¬¢/mile for 2025).</p>
                    </div>
                </div>

                <!-- Platform Stats -->
                <div class="card">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Trusted by Generous Donors</h3>
                        <p class="text-gray-600">Join thousands who are maximizing their charitable impact</p>
                    </div>
                    <div class="grid md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-600">$2.5M+</div>
                            <div class="text-sm text-gray-600">Donations Tracked</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-600">15,000+</div>
                            <div class="text-sm text-gray-600">Transactions Recorded</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-purple-600">500+</div>
                            <div class="text-sm text-gray-600">Verified Charities</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-indigo-600">2025</div>
                            <div class="text-sm text-gray-600">Tax Year Ready</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Authenticated User Dashboard -->
            <div id="user-dashboard" style="display: none;">
                <!-- Welcome Header with User Info -->
                <div class="card">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">
                                Welcome back, <span id="dashboard-user-name">Demo User</span>! üëã
                            </h2>
                            <p class="text-gray-600" id="dashboard-user-status">Ready to track donations</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 mb-1">2025 Tax Year</div>
                            <button onclick="handleLogout()" class="text-sm text-red-600 hover:text-red-800 font-medium">Logout</button>
                        </div>
                    </div>
                </div>

                <!-- Key Statistics - Prominently Displayed -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold opacity-90 mb-1">Total Donations</h3>
                                <div class="text-3xl font-bold" id="total-donations">0</div>
                                <div class="text-sm opacity-80 mt-1">This year</div>
                            </div>
                            <div class="text-4xl opacity-80">üìä</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold opacity-90 mb-1">Amount Donated</h3>
                                <div class="text-3xl font-bold" id="tax-deductible">$0</div>
                                <div class="text-sm opacity-80 mt-1">Tax deductible</div>
                            </div>
                            <div class="text-4xl opacity-80">üí∞</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-pink-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold opacity-90 mb-1">Estimated Tax Savings</h3>
                                <div class="text-3xl font-bold" id="estimated-savings">$0</div>
                                <div class="text-sm opacity-80 mt-1" id="tax-bracket-display">At 24% bracket</div>
                            </div>
                            <div class="text-4xl opacity-80">üéØ</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <button onclick="showAddDonation()" class="flex items-center justify-center p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <span class="text-2xl mr-3">üíù</span>
                            <div class="text-left">
                                <div class="font-semibold">Add Donation</div>
                                <div class="text-sm opacity-90">Record new donation</div>
                            </div>
                        </button>

                        <button onclick="showReports()" class="flex items-center justify-center p-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <span class="text-2xl mr-3">üìä</span>
                            <div class="text-left">
                                <div class="font-semibold">View Reports</div>
                                <div class="text-sm opacity-90">Generate tax documents</div>
                            </div>
                        </button>

                        <button onclick="showProfile()" class="flex items-center justify-center p-4 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <span class="text-2xl mr-3">üë§</span>
                            <div class="text-left">
                                <div class="font-semibold">Profile</div>
                                <div class="text-sm opacity-90">Account settings</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Recent Activity Summary -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üéØ 2025 Progress</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Donations This Year</span>
                                <span class="font-semibold" id="donations-this-year">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Charities Supported</span>
                                <span class="font-semibold" id="charity-count-dash">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Average per Donation</span>
                                <span class="font-semibold" id="average-donation">$0</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìã Donation Types</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">üíµ Money</span>
                                <span class="font-semibold" id="money-count">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">üì¶ Items</span>
                                <span class="font-semibold" id="items-count">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">üöó Mileage</span>
                                <span class="font-semibold" id="mileage-count">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">üìà Stock/Crypto</span>
                                <span class="font-semibold" id="investments-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Donation Form -->
        <div id="donation-form-page" class="space-y-6" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="section-title" id="donation-form-title">Add New Donation</h2>
                </div>
            </div>

            <div class="card">
            <div class="card-header">
                <h2 class="section-title">üí∞ Donation Management Center</h2>
                <div class="flex space-x-2">
                    <span class="status-badge status-verified">‚úÖ Tax Optimized</span>
                    <span class="status-badge status-verified">üîí Secure</span>
                </div>
            </div>

            <!-- User's Donations List -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">üìä Your Donations</h3>
                    <div class="flex gap-2">
                        <button onclick="toggleDonationsList()" id="toggle-donations-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            üîº Show List
                        </button>
                        <button onclick="loadUserDonations()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            üîÑ Refresh List
                        </button>
                    </div>
                </div>
                <div id="user-donations" class="space-y-2" style="display: none;">
                    <div class="text-gray-500 text-center p-4">Click "Refresh List" to load your donations</div>
                </div>
            </div>

            <hr class="my-6">

            <!-- Create New Donation -->
            <h3 class="text-lg font-semibold mb-4">‚ûï Create New Donation</h3>
            <form id="donation-form" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium mb-2">Charity</label>
                        <input type="text" id="charity-search" class="input-field" placeholder="Type to search charities..." autocomplete="off" required>
                        <input type="hidden" id="charity-select" required>
                        <div id="charity-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto" style="display: none;"></div>
                        <div id="add-new-charity" class="mt-2" style="display: none;">
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-blue-800">Add New Charity</span>
                                    <button type="button" onclick="cancelAddCharity()" class="text-blue-600 hover:text-blue-800 text-sm">‚úï</button>
                                </div>
                                <div class="grid gap-2">
                                    <input type="text" id="new-charity-name" class="w-full p-2 border rounded text-sm" placeholder="Charity Name">
                                    <input type="text" id="new-charity-ein" class="w-full p-2 border rounded text-sm" placeholder="EIN (Optional)" pattern="[0-9]{2}-[0-9]{7}">
                                    <input type="text" id="new-charity-address" class="w-full p-2 border rounded text-sm" placeholder="Street Address (Optional)">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="text" id="new-charity-city" class="w-full p-2 border rounded text-sm" placeholder="City">
                                        <input type="text" id="new-charity-state" class="w-full p-2 border rounded text-sm" placeholder="State" maxlength="2">
                                    </div>
                                    <input type="text" id="new-charity-zip" class="w-full p-2 border rounded text-sm" placeholder="ZIP Code" pattern="[0-9]{5}(-[0-9]{4})?">
                                    <button type="button" onclick="saveNewCharity()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Add Charity</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Donation Type</label>
                        <select id="donation-type" class="input-field" required>
                            <option value="money">üíµ Money</option>
                            <option value="items">üì¶ Items</option>
                            <option value="mileage">üöó Mileage</option>
                            <option value="stock">üìà Stock</option>
                            <option value="crypto">‚Çø Crypto</option>
                        </select>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Date</label>
                        <input type="date" id="donation-date" class="input-field" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Amount ($)</label>
                        <input type="number" id="amount" step="0.01" class="input-field" required>
                    </div>
                </div>

                <!-- Type-specific fields -->
                <div id="type-specific-fields"></div>

                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <input type="text" id="description" class="input-field"
                           placeholder="Optional description">
                </div>

                <button type="submit" class="btn-primary">üíæ Create Donation</button>
            </form>

            <div id="donation-result" class="mt-4"></div>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reports-page" class="space-y-6">
            <!-- Page Header -->
            <div class="card">
                <div class="card-header">
                    <h2 class="section-title">üìä Donation Reports & Tax Documents</h2>
                    <button onclick="showDashboard()" class="btn-secondary">‚Üê Back to Dashboard</button>
                </div>
                <p class="section-subtitle">Export donation data and generate tax-optimized reports</p>
            </div>

            <!-- Report Type Selection -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Consolidated Reports -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-bold text-gray-800">üìà Consolidated Reports</h3>
                        <span class="status-badge status-verified">Summary View</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">Total donations by charity, type, and date ranges</p>
                    <div class="space-y-3">
                        <button onclick="showConsolidatedReport()" class="btn-primary w-full">
                            üìã View Summary Report
                        </button>
                        <button onclick="exportConsolidatedCSV()" class="btn-secondary w-full">
                            üìÑ Export CSV Summary
                        </button>
                    </div>
                </div>

                <!-- Individual Item Reports -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-bold text-gray-800">üì¶ Individual Item Reports</h3>
                        <span class="status-badge status-verified">Detailed View</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">Line-by-line donation details for IRS documentation</p>
                    <div class="space-y-3">
                        <button onclick="showDetailedReport()" class="btn-primary w-full">
                            üìù View Detailed Report
                        </button>
                        <button onclick="exportDetailedCSV()" class="btn-secondary w-full">
                            üìÑ Export CSV Details
                        </button>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800">üéØ Export Options</h3>
                    <span class="status-badge status-verified">Tax Ready</span>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Tax Year</label>
                        <select id="report-year" class="input-field">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Date Range</label>
                        <select id="report-range" class="input-field">
                            <option value="all">All Time</option>
                            <option value="ytd">Year to Date</option>
                            <option value="q4">Q4 (Oct-Dec)</option>
                            <option value="q3">Q3 (Jul-Sep)</option>
                            <option value="q2">Q2 (Apr-Jun)</option>
                            <option value="q1">Q1 (Jan-Mar)</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>
                <div id="custom-date-range" class="grid md:grid-cols-2 gap-4 mt-4" style="display: none;">
                    <div>
                        <label class="block text-sm font-medium mb-2">Start Date</label>
                        <input type="date" id="report-start-date" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">End Date</label>
                        <input type="date" id="report-end-date" class="input-field">
                    </div>
                </div>
                <div class="mt-4 flex space-x-4">
                    <button onclick="exportPDFReport()" class="btn-success">
                        üìë Generate PDF Tax Report
                    </button>
                    <button onclick="exportAllCSV()" class="btn-primary">
                        üìä Export Complete CSV
                    </button>
                </div>
            </div>

            <!-- Report Display Area -->
            <div id="report-display" class="card" style="display: none;">
                <div class="card-header">
                    <h3 id="report-display-title" class="text-lg font-bold text-gray-800">Report Results</h3>
                    <button onclick="closeReport()" class="btn-secondary">‚úï Close</button>
                </div>
                <div id="report-content"></div>
            </div>

            <!-- Report Statistics -->
            <div class="grid md:grid-cols-4 gap-4">
                <div class="card text-center">
                    <div class="text-2xl font-bold text-green-600" id="total-tax-deductible">$0</div>
                    <div class="text-sm text-gray-600">Total Tax Deductible</div>
                </div>
                <div class="card text-center">
                    <div class="text-2xl font-bold text-blue-600" id="total-donations-count">0</div>
                    <div class="text-sm text-gray-600">Total Donations</div>
                </div>
                <div class="card text-center">
                    <div class="text-2xl font-bold text-purple-600" id="unique-charities">0</div>
                    <div class="text-sm text-gray-600">Charities Supported</div>
                </div>
                <div class="card text-center">
                    <div class="text-2xl font-bold text-indigo-600" id="avg-donation">$0</div>
                    <div class="text-sm text-gray-600">Average Donation</div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="space-y-6">
            <!-- Page Header -->
            <div class="card">
                <div class="card-header">
                    <h2 class="section-title">üë§ Profile & Tax Settings</h2>
                    <span class="status-badge status-verified">Pro Account</span>
                </div>
                <p class="section-subtitle">Manage your account and tax calculation preferences</p>
            </div>

            <!-- User Information -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800">Account Information</h3>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">Full Name</label>
                        <input type="text" id="profile-name" class="input-field" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Email Address</label>
                        <input type="email" id="profile-email" class="input-field" readonly>
                    </div>
                </div>
            </div>

            <!-- Tax Settings -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800">Tax Calculation Settings</h3>
                    <span class="text-sm text-gray-500">Used for estimated tax savings calculations</span>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">Filing Status</label>
                        <select id="filing-status" class="input-field" onchange="updateTaxBracket()">
                            <option value="single">Single</option>
                            <option value="married-joint">Married Filing Jointly</option>
                            <option value="married-separate">Married Filing Separately</option>
                            <option value="head-of-household">Head of Household</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Annual Income</label>
                        <select id="income-range" class="input-field" onchange="updateTaxBracket()">
                            <option value="0-44725">$0 - $44,725 (10-12%)</option>
                            <option value="44726-95375">$44,726 - $95,375 (22%)</option>
                            <option value="95376-182050" selected>$95,376 - $182,050 (24%)</option>
                            <option value="182051-231250">$182,051 - $231,250 (32%)</option>
                            <option value="231251-578125">$231,251 - $578,125 (35%)</option>
                            <option value="578126+">$578,126+ (37%)</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-blue-800">Current Tax Bracket</h4>
                            <p class="text-blue-700 text-sm">Used for estimating charitable deduction savings</p>
                        </div>
                        <div class="text-2xl font-bold text-blue-800" id="current-tax-rate">24%</div>
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="saveTaxSettings()" class="btn-primary">Save Tax Settings</button>
                </div>
            </div>

            <!-- Account Stats -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800">Account Statistics</h3>
                </div>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="profile-total-donations">0</div>
                        <div class="text-sm text-gray-600">Total Donations</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="profile-tax-deductible">$0</div>
                        <div class="text-sm text-gray-600">Tax Deductible</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600" id="profile-estimated-savings">$0</div>
                        <div class="text-sm text-gray-600">Estimated Savings</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel (hidden by default) -->
        <div id="admin-section" class="card" style="display: none;">
            <div class="card-header">
                <h2 class="section-title">‚öôÔ∏è Administrator Panel</h2>
                <button onclick="hideAdminPanel()" class="btn-secondary">‚Üê Back to Dashboard</button>
            </div>

            <!-- Admin Tabs -->
            <div class="flex mb-6 border-b border-gray-200">
                <button id="admin-charities-tab" onclick="showAdminCharities()" class="px-4 py-2 bg-red-600 text-white rounded-t-lg">Charity Approvals</button>
                <button id="admin-users-tab" onclick="showAdminUsers()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-t-lg ml-1">User Management</button>
            </div>

            <!-- Charity Approvals -->
            <div id="admin-charities-panel">
                <h3 class="text-lg font-semibold mb-4">Pending Charity Approvals</h3>

                <div id="pending-charities-list" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">üìã</div>
                        <p>Loading pending charities...</p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">Bulk Actions</h4>
                    <div class="flex space-x-2">
                        <button onclick="approveAllVisible()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                            ‚úÖ Approve All Visible
                        </button>
                        <button onclick="refreshPendingCharities()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            üîÑ Refresh List
                        </button>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div id="admin-users-panel" style="display: none;">
                <h3 class="text-lg font-semibold mb-4">User Management</h3>
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-2">üë•</div>
                    <p>User management features coming soon...</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Version Information
        const FRONTEND_VERSION = 'v2.1.2';
        const FRONTEND_BUILD = '2025.01.17-02';

        const API_BASE = 'https://charity-tracker-api.robpress123.workers.dev';

        // Log version info for debugging (immediate)
        console.log(`üè† Frontend Version: ${FRONTEND_VERSION} (${FRONTEND_BUILD})`);
        console.log(`üåê API Base: ${API_BASE}`);
        console.log('üìã Console logging is working - you should see debug messages!');

        // Comprehensive Charities Database
        let charities = [
            { id: 'charity-red-cross', name: 'American Red Cross', address: '2025 E Street, NW', city: 'Washington, DC 20006', ein: '53-0196605' },
            { id: 'charity-goodwill', name: 'Goodwill Industries International', address: '15810 Indianola Drive', city: 'Rockville, MD 20855', ein: '53-0196517' },
            { id: 'charity-salvation-army', name: 'The Salvation Army', address: '615 Slaters Lane', city: 'Alexandria, VA 22313', ein: '13-1623001' },
            { id: 'charity-united-way', name: 'United Way Worldwide', address: '701 N Fairfax Street', city: 'Alexandria, VA 22314', ein: '13-1635294' },
            { id: 'charity-habitat', name: 'Habitat for Humanity International', address: '121 Habitat Street', city: 'Americus, GA 31709', ein: '91-1914868' },
            { id: 'charity-st-jude', name: 'St. Jude Children\'s Research Hospital', address: '501 St. Jude Place', city: 'Memphis, TN 38105', ein: '62-0646012' },
            { id: 'charity-feeding-america', name: 'Feeding America', address: '35 E Wacker Drive', city: 'Chicago, IL 60601', ein: '36-3673599' },
            { id: 'charity-wounded-warrior', name: 'Wounded Warrior Project', address: '4899 Belfort Road', city: 'Jacksonville, FL 32256', ein: '20-2370934' },
            { id: 'charity-cancer-society', name: 'American Cancer Society', address: '250 Williams Street NW', city: 'Atlanta, GA 30303', ein: '13-1788491' },
            { id: 'charity-heart-association', name: 'American Heart Association', address: '7272 Greenville Avenue', city: 'Dallas, TX 75231', ein: '13-5613797' }
        ];

        // Comprehensive Item Categories Database with Pricing & Source Tracking
        const itemCategories = {
            'appliances': {
                name: 'Appliances',
                items: [
                    { id: 'air-conditioner', name: 'Air Conditioner', values: { fair: 21.00, good: 57.00, excellent: 93.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'coffee-maker', name: 'Coffee Maker', values: { fair: 4.00, good: 10.00, excellent: 16.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'dryer', name: 'Dryer', values: { fair: 47.00, good: 70.00, excellent: 93.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'microwave', name: 'Microwave', values: { fair: 10.00, good: 30.00, excellent: 50.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'refrigerator', name: 'Refrigerator', values: { fair: 78.00, good: 168.50, excellent: 259.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'washing-machine', name: 'Washing Machine', values: { fair: 41.00, good: 98.50, excellent: 156.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'mens-clothing': {
                name: "Men's Clothing",
                items: [
                    { id: 'mens-suit', name: "Men's Suit", values: { fair: 16.00, good: 39.00, excellent: 62.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'mens-dress-shirt', name: "Men's Dress Shirt", values: { fair: 3.00, good: 7.50, excellent: 12.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'mens-jeans', name: "Men's Jeans", values: { fair: 4.00, good: 12.50, excellent: 21.00 }, source: 'Goodwill', lastUpdated: '2025-01-01' },
                    { id: 'mens-shoes', name: "Men's Shoes", values: { fair: 4.00, good: 15.00, excellent: 26.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'mens-jacket', name: "Men's Jacket", values: { fair: 8.00, good: 17.00, excellent: 26.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'mens-overcoat', name: "Men's Overcoat", values: { fair: 16.00, good: 39.00, excellent: 62.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'mens-sweater', name: "Men's Sweater", values: { fair: 5.00, good: 10.00, excellent: 15.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'mens-shorts', name: "Men's Shorts", values: { fair: 4.00, good: 7.00, excellent: 10.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'mens-slacks', name: "Men's Slacks", values: { fair: 5.00, good: 8.50, excellent: 12.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'womens-clothing': {
                name: "Women's Clothing",
                items: [
                    { id: 'womens-dress', name: "Women's Dress", values: { fair: 4.00, good: 12.00, excellent: 20.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-blouse', name: "Women's Blouse", values: { fair: 3.00, good: 7.50, excellent: 12.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-suit', name: "Women's Suit", values: { fair: 6.00, good: 18.00, excellent: 30.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-handbag', name: "Women's Handbag", values: { fair: 3.00, good: 12.00, excellent: 21.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-coat', name: "Women's Coat", values: { fair: 10.00, good: 25.50, excellent: 41.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-evening-dress', name: "Women's Evening Dress", values: { fair: 10.00, good: 36.00, excellent: 62.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'womens-shoes', name: "Women's Shoes", values: { fair: 4.00, good: 15.00, excellent: 26.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-sweater', name: "Women's Sweater", values: { fair: 5.00, good: 10.00, excellent: 15.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-skirt', name: "Women's Skirt", values: { fair: 3.00, good: 5.50, excellent: 8.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'womens-slacks', name: "Women's Slacks", values: { fair: 4.00, good: 8.00, excellent: 12.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'childrens-clothing': {
                name: "Children's Clothing",
                items: [
                    { id: 'childrens-shirt', name: "Children's Shirt", values: { fair: 2.00, good: 4.00, excellent: 6.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'childrens-dress', name: "Children's Dress", values: { fair: 4.00, good: 8.00, excellent: 12.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'childrens-pants', name: "Children's Pants", values: { fair: 3.00, good: 6.00, excellent: 9.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'childrens-shoes', name: "Children's Shoes", values: { fair: 3.00, good: 8.00, excellent: 13.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'childrens-jacket', name: "Children's Jacket", values: { fair: 4.00, good: 10.00, excellent: 16.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' }
                ]
            },
            'furniture': {
                name: 'Furniture',
                items: [
                    { id: 'sofa', name: 'Sofa/Couch', values: { fair: 36.00, good: 121.50, excellent: 207.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'desk', name: 'Desk', values: { fair: 30.00, good: 87.50, excellent: 145.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'dresser', name: 'Dresser with Mirror', values: { fair: 21.00, good: 62.50, excellent: 104.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'dining-table', name: 'Dining Table', values: { fair: 36.00, good: 106.00, excellent: 176.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'bed-full', name: 'Bed (Full/Queen/King)', values: { fair: 52.00, good: 114.00, excellent: 176.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'coffee-table', name: 'Coffee Table', values: { fair: 16.00, good: 41.50, excellent: 67.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'chair-upholstered', name: 'Upholstered Chair', values: { fair: 26.00, good: 65.00, excellent: 104.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'electronics': {
                name: 'Electronics',
                items: [
                    { id: 'computer-system', name: 'Computer System', values: { fair: 104.00, good: 259.50, excellent: 415.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'computer-printer', name: 'Computer Printer', values: { fair: 5.00, good: 80.00, excellent: 155.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'computer-monitor', name: 'Computer Monitor', values: { fair: 5.00, good: 28.00, excellent: 51.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'tv-color', name: 'Color TV', values: { fair: 78.00, good: 155.50, excellent: 233.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'stereo-system', name: 'Stereo System', values: { fair: 16.00, good: 47.00, excellent: 78.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'dvd-player', name: 'DVD Player', values: { fair: 8.00, good: 12.00, excellent: 16.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'radio', name: 'Radio', values: { fair: 8.00, good: 30.00, excellent: 52.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'books-media': {
                name: 'Books & Media',
                items: [
                    { id: 'hardcover-book', name: 'Hardcover Book', values: { fair: 1.00, good: 2.00, excellent: 3.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'paperback-book', name: 'Paperback Book', values: { fair: 1.00, good: 1.50, excellent: 2.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'cd', name: 'CD', values: { fair: 2.00, good: 3.50, excellent: 5.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'dvd', name: 'DVD', values: { fair: 2.00, good: 3.50, excellent: 5.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' }
                ]
            },
            'household': {
                name: 'Household Items',
                items: [
                    { id: 'bedspread', name: 'Bedspread/Quilt', values: { fair: 3.00, good: 14.00, excellent: 25.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'blanket', name: 'Blanket', values: { fair: 3.00, good: 9.50, excellent: 16.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'curtains', name: 'Curtains', values: { fair: 2.00, good: 7.00, excellent: 12.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'lamp', name: 'Lamp', values: { fair: 5.00, good: 41.50, excellent: 78.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'pillow', name: 'Pillow', values: { fair: 2.00, good: 5.00, excellent: 8.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'towel', name: 'Towel', values: { fair: 0.50, good: 2.25, excellent: 4.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'kitchen': {
                name: 'Kitchen Items',
                items: [
                    { id: 'dishes-set', name: 'Dishes/Dinnerware Set', values: { fair: 8.00, good: 20.00, excellent: 45.00 }, source: 'Kitchen', lastUpdated: '2025-01-01' },
                    { id: 'glass-cup', name: 'Glass/Cup', values: { fair: 0.50, good: 1.25, excellent: 2.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'pot-pan', name: 'Pot/Pan', values: { fair: 1.00, good: 2.00, excellent: 3.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'kitchen-utensils', name: 'Kitchen Utensils', values: { fair: 0.50, good: 1.25, excellent: 2.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'mixer-blender', name: 'Mixer/Blender', values: { fair: 5.00, good: 13.00, excellent: 21.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'sports': {
                name: 'Sports & Recreation',
                items: [
                    { id: 'bicycle', name: 'Bicycle', values: { fair: 5.00, good: 44.00, excellent: 83.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'tennis-racket', name: 'Tennis Racket', values: { fair: 2.00, good: 3.50, excellent: 5.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'golf-clubs', name: 'Golf Clubs (individual)', values: { fair: 2.00, good: 14.00, excellent: 26.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'ice-skates', name: 'Ice Skates', values: { fair: 3.00, good: 9.50, excellent: 16.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'roller-blades', name: 'Roller Blades', values: { fair: 3.00, good: 9.50, excellent: 16.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            }
        };

        // Flatten for backward compatibility (flat array of all items)
        const allDonationItems = Object.values(itemCategories).flatMap(category =>
            category.items.map(item => ({ ...item, category: category.name }))
        );

        // Set today's date
        document.getElementById('donation-date').value = new Date().toISOString().split('T')[0];

        // Setup donation type change handler
        document.getElementById('donation-type').addEventListener('change', updateTypeSpecificFields);


        // Load Charities (combines personal and master charities)
        async function loadCharities() {
            try {
                // Always load master/approved charities
                const masterResponse = await fetch(`${API_BASE}/api/charities?verified=true`, {
                    headers: {
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    }
                });

                let allCharities = [...charities]; // Start with hardcoded backup

                if (masterResponse.ok) {
                    const masterData = await masterResponse.json();
                    if (masterData.success && masterData.data.charities) {
                        // Replace hardcoded with real data from API
                        allCharities = masterData.data.charities.map(charity => ({
                            id: charity.id,
                            name: charity.name,
                            ein: charity.ein || '',
                            address: '', // Will be parsed from metadata if needed
                            city: '',
                            verified: charity.is_verified,
                            source: 'master'
                        }));
                    }
                }

                // If user is logged in, also load their personal charities
                if (authToken) {
                    try {
                        const userResponse = await fetch(`${API_BASE}/api/user-charities`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });

                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            if (userData.success && userData.data.charities) {
                                // Add personal charities with special marking
                                const personalCharities = userData.data.charities.map(charity => ({
                                    id: charity.id,
                                    name: `${charity.name} (Personal)`,
                                    ein: charity.ein || '',
                                    address: charity.address || '',
                                    city: charity.city || '',
                                    state: charity.state || '',
                                    zip: charity.zip || '',
                                    verified: false,
                                    source: 'personal',
                                    original_name: charity.name,
                                    is_submitted_for_approval: charity.is_submitted_for_approval
                                }));
                                allCharities = [...allCharities, ...personalCharities];
                            }
                        }
                    } catch (error) {
                        console.warn('Could not load personal charities:', error);
                    }
                }

                charities = allCharities;
                console.log(`üìä Frontend v${FRONTEND_VERSION} loaded ${charities.length} charities total`);
                setupCharityAutocomplete();

            } catch (error) {
                console.error('Failed to load charities:', error);
                console.log(`üìä Frontend v${FRONTEND_VERSION} using ${charities.length} backup charities (API unavailable)`);
                setupCharityAutocomplete();
            }
        }

        // Authenticated Donation Creation
        document.getElementById('donation-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentUser) {
                showMessage('Please login to create donations', 'error');
                showLogin();
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Creating...';
            submitButton.disabled = true;

            try {
                const charitySelect = document.getElementById('charity-select');
                const formData = {
                    charity_id: charitySelect.value,
                    charity_name: charitySelect.getAttribute('data-charity-name') || '',
                    charity_address: charitySelect.getAttribute('data-charity-address') || '',
                    charity_ein: charitySelect.getAttribute('data-charity-ein') || '',
                    type: document.getElementById('donation-type').value,
                    date: document.getElementById('donation-date').value,
                    tax_deductible_amount: parseFloat(document.getElementById('amount').value),
                    description: document.getElementById('description').value || 'Donation via Charity Tracker'
                };

                // Add type-specific data
                const type = formData.type;
                if (type === 'items') {
                    formData.item_category = document.getElementById('item-category')?.value;
                    formData.item_type = document.getElementById('item-type')?.value;
                    formData.item_condition = document.getElementById('item-condition')?.value;
                } else if (type === 'mileage') {
                    formData.miles_driven = parseFloat(document.getElementById('miles-driven')?.value || 0);
                    formData.mileage_rate = parseFloat(document.getElementById('mileage-rate')?.value || 0.14);
                } else if (type === 'stock') {
                    formData.stock_symbol = document.getElementById('stock-symbol')?.value;
                    formData.shares = parseFloat(document.getElementById('stock-shares')?.value || 0);
                    formData.cost_basis = parseFloat(document.getElementById('stock-cost-basis')?.value || 0);
                } else if (type === 'crypto') {
                    formData.crypto_currency = document.getElementById('crypto-currency')?.value;
                    formData.crypto_amount = parseFloat(document.getElementById('crypto-amount')?.value || 0);
                    formData.cost_basis = parseFloat(document.getElementById('crypto-cost-basis')?.value || 0);
                }

                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`${API_BASE}/api/donations`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('Donation created successfully! Saved to D1 database.', 'success');
                    document.getElementById('donation-form').reset();
                    document.getElementById('type-specific-fields').innerHTML = '';
                    document.getElementById('donation-date').value = new Date().toISOString().split('T')[0];
                    loadUserDonations(); // Refresh the donation list
                    loadDashboardStats(); // Refresh dashboard stats
                } else {
                    showMessage(result.message || 'Failed to create donation', 'error');
                }

            } catch (error) {
                showMessage('Error creating donation: ' + error.message, 'error');
            }

            submitButton.textContent = originalText;
            submitButton.disabled = false;
        });


        // Update type-specific fields based on donation type
        function updateTypeSpecificFields() {
            const type = document.getElementById('donation-type').value;
            const container = document.getElementById('type-specific-fields');

            container.innerHTML = '';

            switch(type) {
                case 'items':
                    container.innerHTML = `
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Item Category</label>
                                <select id="item-category" class="w-full p-3 border rounded-lg" onchange="updateItemTypes()">
                                    <option value="">Select category...</option>
                                    <option value="Clothing">Clothing</option>
                                    <option value="Household">Household Items</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Books">Books & Media</option>
                                    <option value="Furniture">Furniture</option>
                                    <option value="Sports">Sports Equipment</option>
                                    <option value="Toys">Toys & Games</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Item Type</label>
                                <select id="item-type" class="w-full p-3 border rounded-lg" onchange="updateItemValue()">
                                    <option value="">Select item...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Condition</label>
                                <select id="item-condition" class="w-full p-3 border rounded-lg" onchange="updateItemValue()">
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Suggested Value</label>
                                <div class="p-3 bg-blue-50 border rounded-lg">
                                    <span id="suggested-value" class="text-blue-800 font-medium">Select item for valuation</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Fair Market Value ($)</label>
                                <input type="number" id="fair-market-value" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00">
                            </div>
                        </div>
                    `;
                    break;

                case 'mileage':
                    container.innerHTML = `
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Miles Driven</label>
                                <input type="number" id="miles" step="0.1" class="w-full p-3 border rounded-lg" placeholder="0.0" onchange="calculateMileageValue()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">IRS Rate 2025 ($/mile)</label>
                                <input type="number" id="mileage-rate" step="0.001" value="0.14" class="w-full p-3 border rounded-lg" onchange="calculateMileageValue()">
                                <div class="text-xs text-gray-500 mt-1">14¬¢/mile - statutory rate for charitable use</div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Calculated Value</label>
                                <div class="p-3 bg-green-50 border rounded-lg">
                                    <span id="mileage-value" class="text-green-800 font-medium">$0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium mb-2">Purpose</label>
                            <input type="text" id="mileage-purpose" class="w-full p-3 border rounded-lg" placeholder="e.g., Volunteer work, charity event">
                        </div>
                    `;
                    break;

                case 'stock':
                    container.innerHTML = `
                        <div class="grid md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Stock Symbol</label>
                                <input type="text" id="stock-symbol" class="w-full p-3 border rounded-lg" placeholder="AAPL" style="text-transform: uppercase;">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Shares</label>
                                <input type="number" id="shares" step="0.001" class="w-full p-3 border rounded-lg" placeholder="0" onchange="calculateStockGains()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Current Price ($)</label>
                                <input type="number" id="current-price" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00" onchange="calculateStockGains()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Cost Basis ($)</label>
                                <input type="number" id="cost-basis" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00" onchange="calculateStockGains()">
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-purple-50 rounded-lg">
                            <h4 class="font-medium text-purple-800 mb-2">Tax Benefits Summary</h4>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p><strong>Market Value:</strong> <span id="stock-market-value">$0.00</span></p>
                                    <p><strong>Capital Gains Avoided:</strong> <span id="capital-gains-avoided">$0.00</span></p>
                                </div>
                                <div>
                                    <p><strong>Tax Deduction:</strong> <span id="stock-deduction">$0.00</span></p>
                                    <p><strong>Total Tax Benefit:</strong> <span id="total-stock-benefit">$0.00</span></p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'crypto':
                    container.innerHTML = `
                        <div class="grid md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Cryptocurrency</label>
                                <select id="crypto-type" class="w-full p-3 border rounded-lg">
                                    <option value="BTC">Bitcoin (BTC)</option>
                                    <option value="ETH">Ethereum (ETH)</option>
                                    <option value="ADA">Cardano (ADA)</option>
                                    <option value="SOL">Solana (SOL)</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Amount</label>
                                <input type="number" id="crypto-amount" step="0.00000001" class="w-full p-3 border rounded-lg" placeholder="0.00000000" onchange="calculateCryptoGains()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Current Price ($)</label>
                                <input type="number" id="crypto-current-price" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00" onchange="calculateCryptoGains()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Cost Basis ($)</label>
                                <input type="number" id="crypto-cost-basis" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00" onchange="calculateCryptoGains()">
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-orange-50 rounded-lg">
                            <h4 class="font-medium text-orange-800 mb-2">Crypto Tax Benefits</h4>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p><strong>Current Value:</strong> <span id="crypto-current-value">$0.00</span></p>
                                    <p><strong>Capital Gains Avoided:</strong> <span id="crypto-gains-avoided">$0.00</span></p>
                                </div>
                                <div>
                                    <p><strong>Tax Deduction:</strong> <span id="crypto-deduction">$0.00</span></p>
                                    <p><strong>Total Benefit:</strong> <span id="total-crypto-benefit">$0.00</span></p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        // Item valuation data (simplified version)
        const itemValues = {
            'Clothing': {
                "Men's Shirt": { good: 8.00, fair: 4.00, poor: 2.00 },
                "Women's Dress": { good: 12.00, fair: 6.00, poor: 3.00 },
                "Pants/Slacks": { good: 10.00, fair: 5.00, poor: 2.50 },
                "Shoes": { good: 15.00, fair: 8.00, poor: 4.00 },
                "Coat/Jacket": { good: 25.00, fair: 12.00, poor: 6.00 }
            },
            'Household': {
                "Coffee Maker": { good: 15.00, fair: 8.00, poor: 4.00 },
                "Microwave": { good: 50.00, fair: 25.00, poor: 12.00 },
                "Toaster": { good: 10.00, fair: 5.00, poor: 2.50 },
                "Dishes (set)": { good: 20.00, fair: 10.00, poor: 5.00 },
                "Cookware": { good: 30.00, fair: 15.00, poor: 7.50 }
            },
            'Electronics': {
                "Television (32\" or less)": { good: 75.00, fair: 40.00, poor: 20.00 },
                "Computer Monitor": { good: 60.00, fair: 30.00, poor: 15.00 },
                "Smartphone": { good: 200.00, fair: 100.00, poor: 50.00 },
                "Tablet": { good: 150.00, fair: 75.00, poor: 35.00 }
            },
            'Books': {
                "Hardcover Book": { good: 3.00, fair: 1.50, poor: 0.75 },
                "Paperback Book": { good: 1.50, fair: 0.75, poor: 0.35 },
                "Textbook": { good: 15.00, fair: 8.00, poor: 4.00 }
            }
        };

        function updateItemTypes() {
            const category = document.getElementById('item-category').value;
            const typeSelect = document.getElementById('item-type');

            typeSelect.innerHTML = '<option value="">Select item...</option>';

            if (category && itemValues[category]) {
                Object.keys(itemValues[category]).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    typeSelect.appendChild(option);
                });
            }
        }

        function updateItemValue() {
            const category = document.getElementById('item-category').value;
            const itemType = document.getElementById('item-type').value;
            const condition = document.getElementById('item-condition').value;

            if (category && itemType && condition && itemValues[category] && itemValues[category][itemType]) {
                const value = itemValues[category][itemType][condition];
                document.getElementById('suggested-value').textContent = `$${value.toFixed(2)}`;
                document.getElementById('fair-market-value').value = value.toFixed(2);
                document.getElementById('amount').value = value.toFixed(2);
            }
        }

        function calculateMileageValue() {
            const miles = parseFloat(document.getElementById('miles').value) || 0;
            const rate = parseFloat(document.getElementById('mileage-rate').value) || 0.14;
            const value = miles * rate;

            document.getElementById('mileage-value').textContent = `$${value.toFixed(2)}`;
            document.getElementById('amount').value = value.toFixed(2);
        }

        function calculateStockGains() {
            const shares = parseFloat(document.getElementById('shares').value) || 0;
            const currentPrice = parseFloat(document.getElementById('current-price').value) || 0;
            const costBasis = parseFloat(document.getElementById('cost-basis').value) || 0;

            const marketValue = shares * currentPrice;
            const totalCostBasis = shares * costBasis;
            const capitalGains = marketValue - totalCostBasis;
            const taxOnGains = capitalGains * 0.20; // Assuming 20% capital gains rate
            const deduction = marketValue * getUserTaxRate(); // Use actual tax bracket
            const totalBenefit = taxOnGains + deduction;

            document.getElementById('stock-market-value').textContent = `$${marketValue.toFixed(2)}`;
            document.getElementById('capital-gains-avoided').textContent = `$${taxOnGains.toFixed(2)}`;
            document.getElementById('stock-deduction').textContent = `$${deduction.toFixed(2)}`;
            document.getElementById('total-stock-benefit').textContent = `$${totalBenefit.toFixed(2)}`;
            document.getElementById('amount').value = marketValue.toFixed(2);
        }

        function calculateCryptoGains() {
            const amount = parseFloat(document.getElementById('crypto-amount').value) || 0;
            const currentPrice = parseFloat(document.getElementById('crypto-current-price').value) || 0;
            const costBasis = parseFloat(document.getElementById('crypto-cost-basis').value) || 0;

            const currentValue = amount * currentPrice;
            const originalValue = amount * (costBasis / amount);
            const capitalGains = currentValue - originalValue;
            const taxOnGains = capitalGains * 0.20;
            const deduction = currentValue * getUserTaxRate(); // Use actual tax bracket
            const totalBenefit = taxOnGains + deduction;

            document.getElementById('crypto-current-value').textContent = `$${currentValue.toFixed(2)}`;
            document.getElementById('crypto-gains-avoided').textContent = `$${taxOnGains.toFixed(2)}`;
            document.getElementById('crypto-deduction').textContent = `$${deduction.toFixed(2)}`;
            document.getElementById('total-crypto-benefit').textContent = `$${totalBenefit.toFixed(2)}`;
            document.getElementById('amount').value = currentValue.toFixed(2);
        }

        // Authentication Variables
        let currentUser = null;
        let authToken = null;
        let currentTaxYear = 2025;

        // Authentication Functions
        function showLogin() {
            document.getElementById('login-tab').className = 'px-4 py-2 bg-blue-600 text-white rounded-l-lg';
            document.getElementById('register-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-r-lg';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('login-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-l-lg';
            document.getElementById('register-tab').className = 'px-4 py-2 bg-blue-600 text-white rounded-r-lg';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showMessage('Please enter both email and password', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (result.success) {
                    currentUser = result.data.user;
                    authToken = result.data.token;

                    // Store session based on user preference
                    const rememberMe = document.getElementById('remember-me')?.checked || false;
                    const storage = rememberMe ? localStorage : sessionStorage;
                    const expireTime = rememberMe ?
                        Date.now() + (7 * 24 * 60 * 60 * 1000) : // 7 days if remember me
                        Date.now() + (2 * 60 * 60 * 1000); // 2 hours for session only

                    storage.setItem('auth_session', JSON.stringify({
                        token: authToken,
                        user: currentUser,
                        expires: expireTime,
                        remember: rememberMe
                    }));

                    showUserInfo();
                    showMessage('Login successful!', 'success');
                    enableDonationFeatures();
                } else {
                    showMessage(result.message || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('Login error: ' + error.message, 'error');
            }
        }

        async function handleRegister() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            if (!name || !email || !password) {
                showMessage('Please fill in all registration fields', 'error');
                return;
            }

            if (password.length < 8) {
                showMessage('Password must be at least 8 characters', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, password })
                });

                const result = await response.json();

                if (result.success) {
                    currentUser = result.data.user;
                    authToken = result.data.token;

                    // Store session based on user preference
                    const rememberMe = document.getElementById('remember-me')?.checked || false;
                    const storage = rememberMe ? localStorage : sessionStorage;
                    const expireTime = rememberMe ?
                        Date.now() + (7 * 24 * 60 * 60 * 1000) : // 7 days if remember me
                        Date.now() + (2 * 60 * 60 * 1000); // 2 hours for session only

                    storage.setItem('auth_session', JSON.stringify({
                        token: authToken,
                        user: currentUser,
                        expires: expireTime,
                        remember: rememberMe
                    }));

                    showUserInfo();
                    showMessage('Registration successful!', 'success');
                    enableDonationFeatures();
                } else {
                    showMessage(result.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showMessage('Registration error: ' + error.message, 'error');
            }
        }

        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST'
                });
            } catch (error) {
                console.log('Logout request failed:', error);
            }

            currentUser = null;
            authToken = null;

            // Clear stored session
            // Clear session from both storage types
            sessionStorage.removeItem('auth_session');
            localStorage.removeItem('auth_session');

            hideUserInfo();
            showMessage('Logged out successfully', 'success');
            disableDonationFeatures();
        }

        function showUserInfo() {
            if (currentUser) {
                // Normalize user data from API response
                const userName = currentUser.name || `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || 'User';
                const userLicense = currentUser.license_type || (currentUser.is_admin ? 'admin' : 'standard');
                const donationLimit = currentUser.donation_limit || 'unlimited';

                // Update auth section
                document.getElementById('user-name').textContent = userName;
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('user-license').textContent = `${userLicense.toUpperCase()} - ${donationLimit} donations/month`;

                document.getElementById('auth-section').querySelector('#login-form').style.display = 'none';
                document.getElementById('auth-section').querySelector('#register-form').style.display = 'none';
                document.getElementById('user-info').style.display = 'block';

                // Update dashboard header
                document.getElementById('dashboard-user-name').textContent = userName;
                document.getElementById('dashboard-user-status').textContent = `${userLicense.toUpperCase()} Account - Ready to track donations`;

                // Update navigation bar
                document.getElementById('nav-user-name').textContent = userName;
                document.getElementById('main-nav').style.display = 'block';

                // Update profile page
                document.getElementById('profile-name').value = currentUser.name;
                document.getElementById('profile-email').value = currentUser.email;

                // Show user dashboard, hide landing page
                document.getElementById('landing-page').style.display = 'none';
                document.getElementById('user-dashboard').style.display = 'block';

                // Load user statistics and tax settings
                loadTaxSettingsFromDB().then(() => {
                    loadDashboardStats();
                    loadUserDonations();
                });

                // Only show dashboard on first login, not when already logged in
                if (document.getElementById('auth-section').style.display === 'block') {
                    // User just logged in from auth page, show dashboard
                    showDashboard();
                }
            }
        }

        function hideUserInfo() {
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('main-nav').style.display = 'none';

            // Show landing page, hide user dashboard
            document.getElementById('landing-page').style.display = 'block';
            document.getElementById('user-dashboard').style.display = 'none';

            showDashboard();
        }

        async function loadDashboardStats() {
            if (!currentUser || !authToken) return;

            try {
                const response = await fetch(`${API_BASE}/api/donations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();

                if (result.success && result.data.donations) {
                    const donations = result.data.donations;
                    const totalDonations = donations.length;
                    const totalTaxDeductible = donations.reduce((sum, d) => sum + d.tax_deductible_amount, 0);
                    const uniqueCharities = new Set(donations.map(d => d.charity_id)).size;
                    const averageDonation = totalDonations > 0 ? totalTaxDeductible / totalDonations : 0;
                    const taxRate = getUserTaxRate();
                    const estimatedSavings = totalTaxDeductible * taxRate;

                    // Count by donation type
                    const typeCounts = {
                        money: donations.filter(d => d.type === 'money').length,
                        items: donations.filter(d => d.type === 'items').length,
                        mileage: donations.filter(d => d.type === 'mileage').length,
                        stock: donations.filter(d => d.type === 'stock').length,
                        crypto: donations.filter(d => d.type === 'crypto').length
                    };

                    // Update main stats
                    document.getElementById('total-donations').textContent = totalDonations;
                    document.getElementById('tax-deductible').textContent = `$${totalTaxDeductible.toFixed(2)}`;
                    document.getElementById('estimated-savings').textContent = `$${estimatedSavings.toFixed(2)}`;

                    // Update tax bracket display
                    const taxBracketElement = document.getElementById('tax-bracket-display');
                    if (taxBracketElement) {
                        taxBracketElement.textContent = `At ${(taxRate * 100).toFixed(0)}% bracket`;
                    }

                    // Update progress section
                    document.getElementById('donations-this-year').textContent = totalDonations;
                    document.getElementById('charity-count-dash').textContent = uniqueCharities;
                    document.getElementById('average-donation').textContent = `$${averageDonation.toFixed(2)}`;

                    // Update donation type counts
                    document.getElementById('money-count').textContent = typeCounts.money;
                    document.getElementById('items-count').textContent = typeCounts.items;
                    document.getElementById('mileage-count').textContent = typeCounts.mileage;
                    document.getElementById('investments-count').textContent = typeCounts.stock + typeCounts.crypto;

                    // Update profile page stats if they exist
                    const profileTotalElement = document.getElementById('profile-total-donations');
                    const profileTaxElement = document.getElementById('profile-tax-deductible');
                    const profileSavingsElement = document.getElementById('profile-estimated-savings');

                    if (profileTotalElement) profileTotalElement.textContent = totalDonations;
                    if (profileTaxElement) profileTaxElement.textContent = `$${totalTaxDeductible.toFixed(2)}`;
                    if (profileSavingsElement) profileSavingsElement.textContent = `$${estimatedSavings.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Tax Settings Functions
        let userTaxRate = 0.24; // Default to 24%

        function getUserTaxRate() {
            // Use saved tax rate from currentUser if available
            return currentUser && currentUser.taxRate ? currentUser.taxRate / 100 : userTaxRate;
        }


        function updateTaxBracket() {
            const incomeRange = document.getElementById('income-range').value;

            // Determine tax rate based on income range
            const taxRates = {
                '0-44725': 0.12,
                '44726-95375': 0.22,
                '95376-182050': 0.24,
                '182051-231250': 0.32,
                '231251-578125': 0.35,
                '578126+': 0.37
            };

            userTaxRate = taxRates[incomeRange] || 0.24;
            document.getElementById('current-tax-rate').textContent = `${(userTaxRate * 100).toFixed(0)}%`;

            // Update savings calculation on dashboard if stats are loaded
            if (currentUser) {
                loadDashboardStats();
            }
        }

        function enableDonationFeatures() {
            const donationSection = document.getElementById('step3');
            if (donationSection) {
                donationSection.style.display = 'block';
                // Update create donation button to use authenticated API
                const createBtn = donationSection.querySelector('button[onclick*="createDonation"]');
                if (createBtn) {
                    createBtn.textContent = 'üíæ Create Authenticated Donation';
                }
            }
        }

        function disableDonationFeatures() {
            const donationSection = document.getElementById('step3');
            if (donationSection) {
                const createBtn = donationSection.querySelector('button[onclick*="createDonation"]');
                if (createBtn) {
                    createBtn.textContent = 'üîí Login Required for Donations';
                }
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('auth-message');
            messageDiv.innerHTML = `
                <div class="p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // Load user's donations from backend
        async function loadUserDonations() {
            if (!currentUser) {
                document.getElementById('user-donations').innerHTML = `
                    <div class="text-red-500 text-center p-4">Please login to view donations</div>
                `;
                return;
            }

            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`${API_BASE}/api/donations`, {
                    method: 'GET',
                    headers: headers
                });

                const result = await response.json();

                if (result.success && result.data.donations) {
                    const donations = result.data.donations;

                    if (donations.length === 0) {
                        document.getElementById('user-donations').innerHTML = `
                            <div class="text-gray-500 text-center p-4">No donations yet. Create your first donation below!</div>
                        `;
                        return;
                    }

                    let donationsHtml = '';
                    donations.forEach(donation => {
                        donationsHtml += `
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border">
                                <div class="flex-1">
                                    <div class="font-medium">${donation.charity_name || 'Unknown Charity'}</div>
                                    <div class="text-sm text-gray-600">
                                        ${donation.type.charAt(0).toUpperCase() + donation.type.slice(1)} ‚Ä¢ $${donation.tax_deductible_amount.toFixed(2)} ‚Ä¢ ${donation.date}
                                    </div>
                                    ${donation.description ? `<div class="text-xs text-gray-500">${donation.description}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-green-600 font-medium">$${donation.tax_deductible_amount.toFixed(2)}</div>
                                    <div class="text-xs text-gray-500">${donation.created_at ? new Date(donation.created_at).toLocaleDateString() : ''}</div>
                                </div>
                            </div>
                        `;
                    });

                    document.getElementById('user-donations').innerHTML = donationsHtml;
                } else {
                    document.getElementById('user-donations').innerHTML = `
                        <div class="text-red-500 text-center p-4">Failed to load donations: ${result.message}</div>
                    `;
                }

            } catch (error) {
                document.getElementById('user-donations').innerHTML = `
                    <div class="text-red-500 text-center p-4">Error loading donations: ${error.message}</div>
                `;
            }
        }

        // Navigation Functions
        function showDashboard() {
            hideAllPages();
            document.getElementById('dashboard').style.display = 'block';

            // Show appropriate dashboard view based on authentication
            if (currentUser) {
                document.getElementById('landing-page').style.display = 'none';
                document.getElementById('user-dashboard').style.display = 'block';
            } else {
                document.getElementById('landing-page').style.display = 'block';
                document.getElementById('user-dashboard').style.display = 'none';
            }
        }

        function showAddDonation() {
            if (!currentUser) {
                showMessage('Please login or register to create donations', 'error');
                showLogin();
                return;
            }
            hideAllPages();
            document.getElementById('donation-form-page').style.display = 'block';
            loadUserDonations();
        }

        function showReports() {
            // Don't replace container, just replace the reports page content
            hideAllPages();

            const reportsPage = document.getElementById('reports-page');

            reportsPage.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 80vh; padding: 40px; border-radius: 15px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <h1 style="font-size: 3.5rem; margin: 0 0 20px 0; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üìä Reports & Analytics</h1>
                    <p style="text-align: center; font-size: 1.2rem; margin-bottom: 40px; opacity: 0.9;">Generate comprehensive donation reports for tax documentation</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 40px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 15px 0;">üìà Consolidated Reports</h3>
                            <p style="margin: 0 0 20px 0; opacity: 0.9;">Summary view of all donations by charity and type</p>
                            <button onclick="generateSummaryReport()" style="background: #fff; color: #667eea; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px;">View Summary</button>
                            <button onclick="exportSummaryCSV()" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; width: 100%;">Export CSV</button>
                        </div>

                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 15px 0;">üìÑ Detailed Reports</h3>
                            <p style="margin: 0 0 20px 0; opacity: 0.9;">Line-by-line donation details for IRS documentation</p>
                            <button onclick="generateDetailedReport()" style="background: #fff; color: #764ba2; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px;">View Details</button>
                            <button onclick="exportDetailedCSV()" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; width: 100%;">Export CSV</button>
                        </div>
                    </div>
                </div>
            `;

            reportsPage.style.display = 'block';
        }

        // Report Generation Functions
        async function generateSummaryReport() {
            if (!currentUser || !authToken) {
                showMessage('Please login to generate reports', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/donations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();

                if (result.success && result.data.donations) {
                    const donations = result.data.donations;

                    // Group by charity
                    const charityTotals = {};
                    donations.forEach(donation => {
                        const charity = charities.find(c => c.id == donation.charity_id);
                        const charityName = charity ? charity.name : 'Unknown Charity';

                        if (!charityTotals[charityName]) {
                            charityTotals[charityName] = {
                                total: 0,
                                count: 0,
                                types: {}
                            };
                        }

                        charityTotals[charityName].total += donation.tax_deductible_amount;
                        charityTotals[charityName].count += 1;

                        if (!charityTotals[charityName].types[donation.type]) {
                            charityTotals[charityName].types[donation.type] = 0;
                        }
                        charityTotals[charityName].types[donation.type] += donation.tax_deductible_amount;
                    });

                    displaySummaryReport(charityTotals, donations);
                } else {
                    showMessage('No donations found', 'error');
                }
            } catch (error) {
                showMessage('Error generating report: ' + error.message, 'error');
            }
        }

        function displaySummaryReport(charityTotals, donations) {
            const reportsPage = document.getElementById('reports-page');
            const totalTaxDeductible = donations.reduce((sum, d) => sum + d.tax_deductible_amount, 0);
            const taxRate = getUserTaxRate();
            const estimatedSavings = totalTaxDeductible * taxRate;

            let charityRows = '';
            Object.entries(charityTotals).forEach(([charityName, data]) => {
                const typesText = Object.entries(data.types)
                    .map(([type, amount]) => `${type}: $${amount.toFixed(2)}`)
                    .join(', ');

                charityRows += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <td style="padding: 12px; text-align: left;">${charityName}</td>
                        <td style="padding: 12px; text-align: center;">${data.count}</td>
                        <td style="padding: 12px; text-align: right;">$${data.total.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: left; font-size: 0.9em;">${typesText}</td>
                    </tr>
                `;
            });

            reportsPage.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 80vh; padding: 40px; border-radius: 15px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h1 style="font-size: 2.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üìä Summary Report</h1>
                        <button onclick="showReports()" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">‚Üê Back</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">${donations.length}</div>
                            <div style="opacity: 0.9;">Total Donations</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">$${totalTaxDeductible.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Tax Deductible</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">$${estimatedSavings.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Estimated Savings</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">${Object.keys(charityTotals).length}</div>
                            <div style="opacity: 0.9;">Charities</div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="margin: 0 0 20px 0; font-size: 1.5rem;">Donations by Charity</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                                    <th style="padding: 15px; text-align: left;">Charity</th>
                                    <th style="padding: 15px; text-align: center;">Count</th>
                                    <th style="padding: 15px; text-align: right;">Total</th>
                                    <th style="padding: 15px; text-align: left;">Types</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${charityRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function generateDetailedReport() {
            if (!currentUser || !authToken) {
                showMessage('Please login to generate reports', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/donations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();

                if (result.success && result.data.donations) {
                    const donations = result.data.donations;
                    displayDetailedReport(donations);
                } else {
                    showMessage('No donations found', 'error');
                }
            } catch (error) {
                showMessage('Error generating report: ' + error.message, 'error');
            }
        }

        function displayDetailedReport(donations) {
            const reportsPage = document.getElementById('reports-page');
            const totalTaxDeductible = donations.reduce((sum, d) => sum + d.tax_deductible_amount, 0);

            let donationRows = '';
            donations.forEach(donation => {
                const charityName = donation.charity_name || 'Unknown Charity';
                const date = new Date(donation.date).toLocaleDateString();

                donationRows += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 8px; text-align: left;">${date}</td>
                        <td style="padding: 8px; text-align: left;">${charityName}</td>
                        <td style="padding: 8px; text-align: center;">${donation.type}</td>
                        <td style="padding: 8px; text-align: right;">$${donation.tax_deductible_amount.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: left; font-size: 0.9em;">${donation.description || '-'}</td>
                    </tr>
                `;
            });

            reportsPage.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 80vh; padding: 40px; border-radius: 15px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h1 style="font-size: 2.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üìÑ Detailed Report</h1>
                        <button onclick="showReports()" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">‚Üê Back</button>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 2rem; font-weight: bold;">$${totalTaxDeductible.toFixed(2)}</div>
                        <div style="opacity: 0.9;">Total Tax Deductible Amount</div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); max-height: 400px; overflow-y: auto;">
                        <h3 style="margin: 0 0 20px 0; font-size: 1.5rem;">All Donations (${donations.length} entries)</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: rgba(102, 126, 234, 0.9);">
                                <tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                                    <th style="padding: 15px; text-align: left;">Date</th>
                                    <th style="padding: 15px; text-align: left;">Charity</th>
                                    <th style="padding: 15px; text-align: center;">Type</th>
                                    <th style="padding: 15px; text-align: right;">Amount</th>
                                    <th style="padding: 15px; text-align: left;">Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${donationRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function exportSummaryCSV() {
            if (!currentUser || !authToken) {
                showMessage('Please login to export reports', 'error');
                return;
            }

            // This would be implemented to export summary data as CSV
            showMessage('CSV export feature coming soon!', 'info');
        }

        function exportDetailedCSV() {
            if (!currentUser || !authToken) {
                showMessage('Please login to export reports', 'error');
                return;
            }

            // This would be implemented to export detailed data as CSV
            showMessage('CSV export feature coming soon!', 'info');
        }

        function hideAllPages() {
            const elements = [
                'dashboard', 'add-donation-page', 'donation-form-page',
                'auth-section', 'reports-page', 'profile-page'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });
        }

        function showLogin() {
            hideAllPages();
            document.getElementById('auth-section').style.display = 'block';

            // Show login form
            document.getElementById('login-tab').className = 'px-4 py-2 bg-blue-600 text-white rounded-l-lg';
            document.getElementById('register-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-r-lg';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }

        function showRegister() {
            hideAllPages();
            document.getElementById('auth-section').style.display = 'block';

            // Show register form
            document.getElementById('login-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-l-lg';
            document.getElementById('register-tab').className = 'px-4 py-2 bg-blue-600 text-white rounded-r-lg';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }

        function showProfile() {
            hideAllPages();

            const profilePage = document.getElementById('profile-page');

            profilePage.innerHTML = `
                <div style="background: linear-gradient(135deg, #ff9a56 0%, #ff6b9d 100%); min-height: 80vh; padding: 40px; border-radius: 15px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <h1 style="font-size: 3.5rem; margin: 0 0 20px 0; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üë§ Profile & Settings</h1>
                    <p style="text-align: center; font-size: 1.2rem; margin-bottom: 40px; opacity: 0.9;">Manage your account and tax calculation preferences</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 40px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 20px 0;">Account Information</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Full Name</label>
                                <input type="text" id="profile-name" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;" placeholder="Your Name">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email</label>
                                <input type="email" id="profile-email" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;" placeholder="your@email.com">
                            </div>
                            <button onclick="updateProfile()" style="background: #fff; color: #ff6b9d; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 15px;">Update Profile</button>
                        </div>

                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 20px 0;">Tax Settings</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filing Status</label>
                                <select id="filing-status" onchange="updateIncomeBrackets()" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;">
                                    <option value="single">Single</option>
                                    <option value="married_filing_jointly">Married Filing Jointly</option>
                                    <option value="married_filing_separately">Married Filing Separately</option>
                                    <option value="head_of_household">Head of Household</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">2025 Tax Bracket (Taxable Income)</label>
                                <select id="income-range" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;">
                                    <!-- Options will be populated by updateIncomeBrackets() -->
                                </select>
                            </div>
                            <button onclick="saveTaxSettings()" style="background: #fff; color: #ff6b9d; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;">Save Tax Settings</button>
                        </div>
                    </div>
                </div>
            `;

            profilePage.style.display = 'block';

            // Load current user data into form fields
            setTimeout(async () => {
                // Initialize tax brackets first
                updateIncomeBrackets();

                if (currentUser) {
                    // Load basic profile data
                    document.getElementById('profile-name').value = currentUser.name || '';
                    document.getElementById('profile-email').value = currentUser.email || '';

                    // Load tax settings from database
                    await loadTaxSettingsFromDB();

                    // Set form values based on loaded data
                    document.getElementById('filing-status').value = currentUser.filingStatus || 'single';

                    // Update brackets again in case filing status changed
                    updateIncomeBrackets();

                    // Set income bracket if saved
                    if (currentUser.incomeBracket) {
                        document.getElementById('income-range').value = currentUser.incomeBracket;
                    }
                }
            }, 100);
        }

        function updateProfile() {
            const name = document.getElementById('profile-name').value;
            const email = document.getElementById('profile-email').value;

            if (!name || !email) {
                showMessage('Please fill in all fields', 'error');
                return;
            }

            if (currentUser) {
                currentUser.name = name;
                currentUser.email = email;
                showMessage('Profile updated successfully!', 'success');
            }
        }

        async function saveTaxSettings() {
            let filingStatus = document.getElementById('filing-status').value;
            const incomeRange = document.getElementById('income-range').value;

            // Map old format to new format for backwards compatibility
            const filingStatusMap = {
                'married-jointly': 'married_filing_jointly',
                'married-separately': 'married_filing_separately',
                'head-of-household': 'head_of_household'
            };
            const originalFilingStatus = filingStatus;
            filingStatus = filingStatusMap[filingStatus] || filingStatus;
            console.log('Debug - Filing Status Mapping:', originalFilingStatus, '->', filingStatus);

            if (!currentUser) {
                showMessage('Please login to save tax settings', 'error');
                return;
            }

            // Extract the actual tax rate from the selected bracket
            const brackets = taxBrackets2025[filingStatus] || taxBrackets2025.single;
            const bracketIndex = parseInt(incomeRange.replace('bracket-', ''));

            if (!brackets[bracketIndex]) {
                showMessage('Invalid tax bracket selected', 'error');
                return;
            }

            // Convert bracket index to tax rate for backend
            console.log('Debug - Filing Status:', filingStatus);
            console.log('Debug - Income Range:', incomeRange);
            console.log('Debug - Bracket Index:', bracketIndex);
            console.log('Debug - Brackets:', brackets);
            console.log('Debug - Selected Bracket:', brackets[bracketIndex]);

            const taxRate = brackets[bracketIndex].rate.toString();
            console.log('Debug - Tax Rate:', taxRate);

            const taxData = {
                filing_status: filingStatus,
                income_bracket: taxRate,
                tax_year: new Date().getFullYear()
            };

            console.log('Debug - Tax Data being sent:', taxData);

            try {
                // Try to save to database first
                const response = await fetch(`${API_BASE}/api/users/tax-settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(taxData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Database save successful
                        currentUser.filingStatus = filingStatus;
                        currentUser.incomeBracket = incomeRange;
                        currentUser.taxRate = brackets[bracketIndex].rate;
                        currentUser.incomeMin = brackets[bracketIndex].min;
                        currentUser.incomeMax = brackets[bracketIndex].max;
                        showMessage('Tax settings saved to database!', 'success');
                        loadDashboardStats();
                        return;
                    }
                }
            } catch (error) {
                console.log('Database save failed, using localStorage fallback:', error.message);
            }

            // Fallback to localStorage if database save fails
            try {
                const localTaxData = {
                    filingStatus: filingStatus,
                    incomeBracket: incomeRange,
                    taxRate: brackets[bracketIndex].rate,
                    incomeMin: brackets[bracketIndex].min,
                    incomeMax: brackets[bracketIndex].max
                };
                localStorage.setItem(`tax_settings_${currentUser.id || 'default'}`, JSON.stringify(localTaxData));
                currentUser.filingStatus = filingStatus;
                currentUser.incomeBracket = incomeRange;
                currentUser.taxRate = brackets[bracketIndex].rate;
                currentUser.incomeMin = brackets[bracketIndex].min;
                currentUser.incomeMax = brackets[bracketIndex].max;
                showMessage('Tax settings saved locally!', 'success');
                loadDashboardStats();
            } catch (error) {
                showMessage('Error saving tax settings: ' + error.message, 'error');
            }
        }

        function updateCurrentUserTaxData(taxData, filingStatus, incomeRange, bracket) {
            currentUser.filingStatus = filingStatus;
            currentUser.incomeBracket = incomeRange;
            currentUser.taxRate = bracket.rate;
            currentUser.incomeMin = bracket.min;
            currentUser.incomeMax = bracket.max;
        }

        async function loadTaxSettingsFromDB() {
            if (!currentUser || !authToken) return;

            try {
                // Try to load from database first
                const response = await fetch(`${API_BASE}/api/users/tax-settings`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const taxSettings = result.data;
                        currentUser.filingStatus = taxSettings.filing_status || 'single';

                        // Convert tax rate back to bracket format for UI
                        const taxRate = taxSettings.income_bracket || '24';
                        const brackets = taxBrackets2025[currentUser.filingStatus] || taxBrackets2025.single;
                        const bracketIndex = brackets.findIndex(b => b.rate.toString() === taxRate);
                        currentUser.incomeBracket = bracketIndex >= 0 ? `bracket-${bracketIndex}` : 'bracket-0';

                        currentUser.taxYear = taxSettings.tax_year || new Date().getFullYear();

                        // Store the actual tax rate for dashboard display
                        currentUser.taxRate = parseInt(taxRate);

                        // Update dashboard display with saved tax rate
                        updateDashboardTaxDisplay();
                        return;
                    }
                }
            } catch (error) {
                console.log('Database load failed, trying localStorage fallback:', error.message);
            }

            // Fallback to localStorage
            try {
                const savedSettings = localStorage.getItem(`tax_settings_${currentUser.id || 'default'}`);
                if (savedSettings) {
                    const taxSettings = JSON.parse(savedSettings);
                    currentUser.filingStatus = taxSettings.filingStatus || 'single';
                    currentUser.incomeBracket = taxSettings.incomeBracket || 'bracket-0';
                    currentUser.taxRate = taxSettings.taxRate || 24;
                    currentUser.incomeMin = taxSettings.incomeMin || 0;
                    currentUser.incomeMax = taxSettings.incomeMax || 11975;

                    // Update dashboard display with saved tax rate
                    updateDashboardTaxDisplay();
                    return;
                }
            } catch (error) {
                console.log('localStorage load failed:', error.message);
            }

            // Use defaults if all loading fails
            currentUser.filingStatus = currentUser.filingStatus || 'single';
            currentUser.incomeBracket = currentUser.incomeBracket || 'bracket-0';
            currentUser.taxRate = currentUser.taxRate || 24;
        }

        function loadProfileData() {
            // Profile data loading functionality - placeholder for now
        }

        function updateDashboardTaxDisplay() {
            if (currentUser && currentUser.taxRate) {
                // Update the dashboard tax rate displays
                const taxBracketDisplay = document.getElementById('tax-bracket-display');
                const currentTaxRateDisplay = document.getElementById('current-tax-rate');

                if (taxBracketDisplay) {
                    taxBracketDisplay.textContent = `At ${currentUser.taxRate}% bracket`;
                }
                if (currentTaxRateDisplay) {
                    currentTaxRateDisplay.textContent = `${currentUser.taxRate}%`;
                }

                // Update any tax calculation variables
                window.userTaxRate = currentUser.taxRate / 100; // Convert to decimal for calculations
            }
        }

        // Tax Year Functions
        function toggleTaxYearDropdown() {
            const dropdown = document.getElementById('tax-year-dropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function selectTaxYear(year) {
            currentTaxYear = year;
            document.getElementById('current-tax-year').textContent = year;
            document.getElementById('tax-year-dropdown').style.display = 'none';
            showMessage(`Tax year set to ${year}`, 'success');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('tax-year-dropdown');
            const button = event.target.closest('[onclick="toggleTaxYearDropdown()"]');
            if (!button && dropdown) {
                dropdown.style.display = 'none';
            }
        });

        // IRS Tax Brackets for 2025
        const taxBrackets2025 = {
            single: [
                { min: 0, max: 11975, rate: 10, label: "$0 - $11,975 (10%)" },
                { min: 11975, max: 48700, rate: 12, label: "$11,975 - $48,700 (12%)" },
                { min: 48700, max: 103350, rate: 22, label: "$48,700 - $103,350 (22%)" },
                { min: 103350, max: 197300, rate: 24, label: "$103,350 - $197,300 (24%)" },
                { min: 197300, max: 250525, rate: 32, label: "$197,300 - $250,525 (32%)" },
                { min: 250525, max: 626350, rate: 35, label: "$250,525 - $626,350 (35%)" },
                { min: 626350, max: Infinity, rate: 37, label: "$626,350+ (37%)" }
            ],
            'married-jointly': [
                { min: 0, max: 23950, rate: 10, label: "$0 - $23,950 (10%)" },
                { min: 23950, max: 97400, rate: 12, label: "$23,950 - $97,400 (12%)" },
                { min: 97400, max: 206700, rate: 22, label: "$97,400 - $206,700 (22%)" },
                { min: 206700, max: 394600, rate: 24, label: "$206,700 - $394,600 (24%)" },
                { min: 394600, max: 501050, rate: 32, label: "$394,600 - $501,050 (32%)" },
                { min: 501050, max: 751600, rate: 35, label: "$501,050 - $751,600 (35%)" },
                { min: 751600, max: Infinity, rate: 37, label: "$751,600+ (37%)" }
            ],
            'married-separately': [
                { min: 0, max: 11975, rate: 10, label: "$0 - $11,975 (10%)" },
                { min: 11975, max: 48700, rate: 12, label: "$11,975 - $48,700 (12%)" },
                { min: 48700, max: 103350, rate: 22, label: "$48,700 - $103,350 (22%)" },
                { min: 103350, max: 197300, rate: 24, label: "$103,350 - $197,300 (24%)" },
                { min: 197300, max: 250525, rate: 32, label: "$197,300 - $250,525 (32%)" },
                { min: 250525, max: 375800, rate: 35, label: "$250,525 - $375,800 (35%)" },
                { min: 375800, max: Infinity, rate: 37, label: "$375,800+ (37%)" }
            ],
            'head-of-household': [
                { min: 0, max: 17100, rate: 10, label: "$0 - $17,100 (10%)" },
                { min: 17100, max: 65400, rate: 12, label: "$17,100 - $65,400 (12%)" },
                { min: 65400, max: 103350, rate: 22, label: "$65,400 - $103,350 (22%)" },
                { min: 103350, max: 197300, rate: 24, label: "$103,350 - $197,300 (24%)" },
                { min: 197300, max: 250500, rate: 32, label: "$197,300 - $250,500 (32%)" },
                { min: 250500, max: 626350, rate: 35, label: "$250,500 - $626,350 (35%)" },
                { min: 626350, max: Infinity, rate: 37, label: "$626,350+ (37%)" }
            ]
        };

        function updateIncomeBrackets() {
            const filingStatus = document.getElementById('filing-status').value;
            const incomeSelect = document.getElementById('income-range');
            const brackets = taxBrackets2025[filingStatus] || taxBrackets2025.single;

            // Clear existing options
            incomeSelect.innerHTML = '';

            // Add new options based on filing status
            brackets.forEach((bracket, index) => {
                const option = document.createElement('option');
                option.value = `bracket-${index}`;
                option.textContent = bracket.label;
                incomeSelect.appendChild(option);
            });
        }


        // Handle Enter key for login/register
        function handleLoginEnter(event) {
            if (event.key === 'Enter') {
                handleLogin();
            }
        }

        function handleRegisterEnter(event) {
            if (event.key === 'Enter') {
                handleRegister();
            }
        }

        // Charity Autocomplete Functionality
        function setupCharityAutocomplete() {
            const searchInput = document.getElementById('charity-search');
            const dropdown = document.getElementById('charity-dropdown');
            const hiddenSelect = document.getElementById('charity-select');

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();

                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    hiddenSelect.value = '';
                    return;
                }

                const matches = charities.filter(charity =>
                    charity.name.toLowerCase().includes(query)
                );

                if (matches.length > 0) {
                    let html = '';
                    matches.slice(0, 10).forEach(charity => {
                        html += `
                            <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200"
                                 onclick="selectCharity('${charity.id}', '${charity.name.replace(/'/g, "\\'")}')">
                                <div class="font-medium">${charity.name}</div>
                                <div class="text-sm text-gray-500">EIN: ${charity.ein}</div>
                            </div>
                        `;
                    });

                    // Add option to create new charity if no exact match
                    const exactMatch = matches.find(c => c.name.toLowerCase() === query);
                    if (!exactMatch && query.length >= 3) {
                        html += `
                            <div class="p-3 hover:bg-blue-50 cursor-pointer border-t-2 border-blue-200 bg-blue-25"
                                 onclick="showAddNewCharity('${query.replace(/'/g, "\\'")}')">
                                <div class="font-medium text-blue-700">+ Add "${query}" as new charity</div>
                                <div class="text-sm text-blue-600">Create new charity entry</div>
                            </div>
                        `;
                    }

                    dropdown.innerHTML = html;
                    dropdown.style.display = 'block';
                } else {
                    // No matches, show add new option
                    if (query.length >= 3) {
                        dropdown.innerHTML = `
                            <div class="p-3 hover:bg-blue-50 cursor-pointer bg-blue-25"
                                 onclick="showAddNewCharity('${query.replace(/'/g, "\\'")}')">
                                <div class="font-medium text-blue-700">+ Add "${query}" as new charity</div>
                                <div class="text-sm text-blue-600">No matches found. Create new charity entry.</div>
                            </div>
                        `;
                        dropdown.style.display = 'block';
                    } else {
                        dropdown.style.display = 'none';
                    }
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function selectCharity(charityId, charityName) {
            const charity = charities.find(c => c.id == charityId);
            document.getElementById('charity-search').value = charityName;
            document.getElementById('charity-select').value = charityId;
            // Store charity details for form submission
            if (charity) {
                document.getElementById('charity-select').setAttribute('data-charity-name', charity.name);
                document.getElementById('charity-select').setAttribute('data-charity-address', charity.address + ', ' + charity.city);
                document.getElementById('charity-select').setAttribute('data-charity-ein', charity.ein);
            }
            document.getElementById('charity-dropdown').style.display = 'none';
            document.getElementById('add-new-charity').style.display = 'none';
        }

        function showAddNewCharity(initialName = '') {
            document.getElementById('charity-dropdown').style.display = 'none';
            document.getElementById('add-new-charity').style.display = 'block';
            document.getElementById('new-charity-name').value = initialName;
            document.getElementById('new-charity-ein').value = '';
            document.getElementById('new-charity-address').value = '';
            document.getElementById('new-charity-city').value = '';
            document.getElementById('new-charity-state').value = '';
            document.getElementById('new-charity-zip').value = '';
        }

        function cancelAddCharity() {
            document.getElementById('add-new-charity').style.display = 'none';
            document.getElementById('new-charity-name').value = '';
            document.getElementById('new-charity-ein').value = '';
            document.getElementById('new-charity-address').value = '';
            document.getElementById('new-charity-city').value = '';
            document.getElementById('new-charity-state').value = '';
            document.getElementById('new-charity-zip').value = '';
            document.getElementById('charity-search').focus();
        }

        async function saveNewCharity() {
            console.log('üéØ saveNewCharity() called');

            const name = document.getElementById('new-charity-name').value.trim();
            const ein = document.getElementById('new-charity-ein').value.trim();
            const address = document.getElementById('new-charity-address').value.trim();
            const city = document.getElementById('new-charity-city').value.trim();
            const state = document.getElementById('new-charity-state').value.trim();
            const zip = document.getElementById('new-charity-zip').value.trim();

            console.log('üìù Form data:', { name, ein, address, city, state, zip });
            console.log('üîë Auth token:', authToken ? 'Present' : 'Missing');
            console.log('üë§ Current user:', currentUser ? currentUser.email : 'Not logged in');

            if (!name) {
                console.error('‚ùå No charity name provided');
                showMessage('Charity name is required', 'error');
                return;
            }

            // Validate EIN format if provided
            if (ein && !/^\d{2}-\d{7}$/.test(ein)) {
                console.error('‚ùå Invalid EIN format:', ein);
                showMessage('EIN must be in format XX-XXXXXXX', 'error');
                return;
            }

            // Validate ZIP code format if provided
            if (zip && !/^\d{5}(-\d{4})?$/.test(zip)) {
                console.error('‚ùå Invalid ZIP format:', zip);
                showMessage('ZIP code must be in format XXXXX or XXXXX-XXXX', 'error');
                return;
            }

            // Validate state format if provided
            if (state && state.length !== 2) {
                console.error('‚ùå Invalid state format:', state);
                showMessage('State must be 2-letter abbreviation (e.g., CA, NY)', 'error');
                return;
            }

            // Check authentication before proceeding
            if (!authToken) {
                console.error('‚ùå No authentication token - user must log in');
                showMessage('Please log in to add personal charities', 'error');
                return;
            }

            console.log('‚úÖ Validation passed, proceeding with API call');

            try {
                // Save to personal charity database
                const charityData = {
                    name: name,
                    ein: ein || null,
                    address: address || null,
                    city: city || null,
                    state: state || null,
                    zip: zip || null
                };

                console.log('üåê Making API call to:', `${API_BASE}/api/user-charities`);
                console.log('üì§ Sending data:', charityData);

                const response = await fetch(`${API_BASE}/api/user-charities`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify(charityData)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response ok:', response.ok);

                let result;
                try {
                    result = await response.json();
                    console.log('üì• Response data:', result);
                } catch (parseError) {
                    console.error('‚ùå Failed to parse JSON response:', parseError);
                    console.log('üìÑ Raw response text:', await response.text());
                    throw new Error('Invalid response from server');
                }

                // If user-charities API isn't deployed yet, fall back to local storage
                if (!response.ok && response.status === 404) {
                    console.warn('‚ö†Ô∏è API not available yet, using local fallback');
                    result = await handleLocalCharityFallback(charityData);
                }

                if (result.success) {
                    console.log('‚úÖ Charity saved successfully');
                    const newCharity = result.data;

                    // Add to local list for immediate use (marked as personal)
                    const personalCharity = {
                        id: newCharity.id,
                        name: `${newCharity.name} (Personal)`,
                        ein: newCharity.ein || '',
                        address: newCharity.address || '',
                        city: newCharity.city || '',
                        state: newCharity.state || '',
                        zip: newCharity.zip || '',
                        verified: false,
                        source: 'personal',
                        original_name: newCharity.name
                    };

                    console.log('‚ûï Adding to local charities list:', personalCharity);
                    charities.push(personalCharity);

                    console.log('üéØ Selecting charity in dropdown');
                    selectCharity(personalCharity.id, personalCharity.name);

                    console.log('üîÑ Hiding add form');
                    document.getElementById('add-new-charity').style.display = 'none';

                    // Show success message
                    showMessage(`Personal charity "${name}" added successfully! Would you like to submit it for approval to the master database so others can use it?`, 'success');

                    // Optionally show a button to submit for approval
                    setTimeout(() => {
                        if (confirm(`Submit "${name}" to master database for admin approval?`)) {
                            console.log('üì§ User chose to submit for approval');
                            submitCharityForApproval(newCharity.id, name);
                        } else {
                            console.log('‚ùå User chose not to submit for approval');
                        }
                    }, 2000);
                } else {
                    console.error('‚ùå API call failed:', result);
                    showMessage(result.message || 'Failed to add personal charity', 'error');
                }
            } catch (error) {
                console.error('üí• Exception in saveNewCharity:', error);
                showMessage('Error adding charity: ' + error.message, 'error');
            }
        }

        // Fallback function for when API isn't available yet
        async function handleLocalCharityFallback(charityData) {
            console.log('üíæ Using local storage fallback for charity');

            const charityId = crypto.randomUUID ? crypto.randomUUID() : 'local-' + Date.now();
            const localCharity = {
                id: charityId,
                ...charityData,
                created_at: new Date().toISOString()
            };

            // Store in localStorage as backup
            let userCharities = JSON.parse(localStorage.getItem('user_charities') || '[]');
            userCharities.push(localCharity);
            localStorage.setItem('user_charities', JSON.stringify(userCharities));

            console.log('üíæ Saved to local storage:', localCharity);

            return {
                success: true,
                data: localCharity,
                message: 'Charity saved locally (API not available yet)'
            };
        }

        // Submit personal charity for approval to master database
        async function submitCharityForApproval(userCharityId, charityName) {
            try {
                const response = await fetch(`${API_BASE}/api/user-charities/submit-for-approval`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify({ user_charity_id: userCharityId })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`"${charityName}" submitted for admin approval to the master database!`, 'success');

                    // Update the local charity to show it's submitted
                    const charityIndex = charities.findIndex(c => c.id === userCharityId);
                    if (charityIndex !== -1) {
                        charities[charityIndex].is_submitted_for_approval = true;
                        charities[charityIndex].name = charities[charityIndex].name.replace(' (Personal)', ' (Personal - Pending Approval)');
                    }
                } else {
                    showMessage(result.message || 'Failed to submit charity for approval', 'error');
                }
            } catch (error) {
                showMessage('Error submitting charity: ' + error.message, 'error');
            }
        }

        // Reports Functionality
        let reportsData = [];

        async function loadReportsData() {
            // Show demo data for now since we removed auth checks
            console.log('Loading reports data...');

            try {
                const response = await fetch(`${API_BASE}/api/donations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();

                if (result.success) {
                    reportsData = result.data.donations;
                    updateReportStatistics();
                    setupDateRangeHandler();
                } else {
                    showMessage('Failed to load donation data', 'error');
                }
            } catch (error) {
                showMessage('Error loading reports: ' + error.message, 'error');
            }
        }

        function setupDateRangeHandler() {
            document.getElementById('report-range').addEventListener('change', function() {
                const customRange = document.getElementById('custom-date-range');
                if (this.value === 'custom') {
                    customRange.style.display = 'grid';
                } else {
                    customRange.style.display = 'none';
                }
            });
        }

        function updateReportStatistics() {
            const filteredData = getFilteredDonations();

            const totalTaxDeductible = filteredData.reduce((sum, d) => sum + d.tax_deductible_amount, 0);
            const uniqueCharities = new Set(filteredData.map(d => d.charity_id)).size;
            const avgDonation = filteredData.length > 0 ? totalTaxDeductible / filteredData.length : 0;

            document.getElementById('total-tax-deductible').textContent = `$${totalTaxDeductible.toFixed(2)}`;
            document.getElementById('total-donations-count').textContent = filteredData.length;
            document.getElementById('unique-charities').textContent = uniqueCharities;
            document.getElementById('avg-donation').textContent = `$${avgDonation.toFixed(2)}`;
        }

        function getFilteredDonations() {
            const year = document.getElementById('report-year').value;
            const range = document.getElementById('report-range').value;

            let filtered = reportsData.filter(donation => {
                const donationYear = new Date(donation.date).getFullYear().toString();
                return donationYear === year;
            });

            if (range !== 'all') {
                const now = new Date();
                let startDate, endDate;

                switch (range) {
                    case 'ytd':
                        startDate = new Date(year, 0, 1);
                        endDate = now;
                        break;
                    case 'q1':
                        startDate = new Date(year, 0, 1);
                        endDate = new Date(year, 2, 31);
                        break;
                    case 'q2':
                        startDate = new Date(year, 3, 1);
                        endDate = new Date(year, 5, 30);
                        break;
                    case 'q3':
                        startDate = new Date(year, 6, 1);
                        endDate = new Date(year, 8, 30);
                        break;
                    case 'q4':
                        startDate = new Date(year, 9, 1);
                        endDate = new Date(year, 11, 31);
                        break;
                    case 'custom':
                        startDate = new Date(document.getElementById('report-start-date').value);
                        endDate = new Date(document.getElementById('report-end-date').value);
                        break;
                }

                if (startDate && endDate) {
                    filtered = filtered.filter(donation => {
                        const donationDate = new Date(donation.date);
                        return donationDate >= startDate && donationDate <= endDate;
                    });
                }
            }

            return filtered;
        }

        function showConsolidatedReport() {
            const filteredData = getFilteredDonations();
            const consolidated = {};

            filteredData.forEach(donation => {
                const charityName = donation.charity_name || 'Unknown Charity';
                const key = `${charityName}|${donation.type}`;

                if (!consolidated[key]) {
                    consolidated[key] = {
                        charity: charityName,
                        type: donation.type,
                        count: 0,
                        total: 0,
                        donations: []
                    };
                }

                consolidated[key].count++;
                consolidated[key].total += donation.tax_deductible_amount;
                consolidated[key].donations.push(donation);
            });

            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-3 text-left">Charity</th>
                                <th class="border border-gray-300 p-3 text-left">Donation Type</th>
                                <th class="border border-gray-300 p-3 text-right">Count</th>
                                <th class="border border-gray-300 p-3 text-right">Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.values(consolidated)
                .sort((a, b) => b.total - a.total)
                .forEach(item => {
                    html += `
                        <tr>
                            <td class="border border-gray-300 p-3">${item.charity}</td>
                            <td class="border border-gray-300 p-3">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</td>
                            <td class="border border-gray-300 p-3 text-right">${item.count}</td>
                            <td class="border border-gray-300 p-3 text-right font-medium">$${item.total.toFixed(2)}</td>
                        </tr>
                    `;
                });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('report-display-title').textContent = 'üìà Consolidated Report Summary';
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('report-display').style.display = 'block';
        }

        function showDetailedReport() {
            const filteredData = getFilteredDonations();

            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-3 text-left">Date</th>
                                <th class="border border-gray-300 p-3 text-left">Charity</th>
                                <th class="border border-gray-300 p-3 text-left">Type</th>
                                <th class="border border-gray-300 p-3 text-left">Description</th>
                                <th class="border border-gray-300 p-3 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredData
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(donation => {
                    const charity = charities.find(c => c.id == donation.charity_id);
                    const charityName = charity ? charity.name : 'Unknown Charity';

                    html += `
                        <tr>
                            <td class="border border-gray-300 p-3">${new Date(donation.date).toLocaleDateString()}</td>
                            <td class="border border-gray-300 p-3">${charityName}</td>
                            <td class="border border-gray-300 p-3">${donation.type.charAt(0).toUpperCase() + donation.type.slice(1)}</td>
                            <td class="border border-gray-300 p-3">${donation.description || ''}</td>
                            <td class="border border-gray-300 p-3 text-right font-medium">$${donation.tax_deductible_amount.toFixed(2)}</td>
                        </tr>
                    `;
                });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('report-display-title').textContent = 'üì¶ Detailed Individual Items Report';
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('report-display').style.display = 'block';
        }

        function closeReport() {
            document.getElementById('report-display').style.display = 'none';
        }

        function exportConsolidatedCSV() {
            const filteredData = getFilteredDonations();
            const consolidated = {};

            filteredData.forEach(donation => {
                const charityName = donation.charity_name || 'Unknown Charity';
                const key = `${charityName}|${donation.type}`;

                if (!consolidated[key]) {
                    consolidated[key] = {
                        charity: charityName,
                        type: donation.type,
                        count: 0,
                        total: 0
                    };
                }

                consolidated[key].count++;
                consolidated[key].total += donation.tax_deductible_amount;
            });

            let csv = 'Charity,Donation Type,Count,Total Amount\n';
            Object.values(consolidated)
                .sort((a, b) => b.total - a.total)
                .forEach(item => {
                    csv += `"${item.charity}","${item.type}",${item.count},${item.total.toFixed(2)}\n`;
                });

            downloadCSV(csv, 'consolidated-donations-report.csv');
        }

        function exportDetailedCSV() {
            const filteredData = getFilteredDonations();

            let csv = 'Date,Charity,EIN,Type,Description,Amount\n';
            filteredData
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(donation => {
                    const charity = charities.find(c => c.id == donation.charity_id);
                    const charityName = charity ? charity.name : 'Unknown Charity';
                    const ein = charity ? charity.ein : '';

                    csv += `"${donation.date}","${charityName}","${ein}","${donation.type}","${(donation.description || '').replace(/"/g, '""')}",${donation.tax_deductible_amount.toFixed(2)}\n`;
                });

            downloadCSV(csv, 'detailed-donations-report.csv');
        }

        function exportAllCSV() {
            const filteredData = getFilteredDonations();

            let csv = 'Date,Charity,EIN,Type,Description,Amount,Created Date\n';
            filteredData
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(donation => {
                    const charity = charities.find(c => c.id == donation.charity_id);
                    const charityName = charity ? charity.name : 'Unknown Charity';
                    const ein = charity ? charity.ein : '';
                    const createdDate = donation.created_at ? new Date(donation.created_at).toLocaleDateString() : '';

                    csv += `"${donation.date}","${charityName}","${ein}","${donation.type}","${(donation.description || '').replace(/"/g, '""')}",${donation.tax_deductible_amount.toFixed(2)},"${createdDate}"\n`;
                });

            downloadCSV(csv, 'complete-donations-export.csv');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage(`CSV exported: ${filename}`, 'success');
            }
        }

        function exportPDFReport() {
            showMessage('PDF export functionality would integrate with jsPDF library for complete tax-ready documents', 'success');
        }

        // Check backend version and sync frontend version displays
        async function checkBackendVersion() {
            try {
                const response = await fetch(`${API_BASE}/version`);
                if (response.ok) {
                    const backendInfo = await response.json();
                    const backendVersionText = `${backendInfo.version} (${backendInfo.build})`;
                    document.getElementById('backend-version').textContent = backendVersionText;
                    console.log(`üñ•Ô∏è Backend Version: ${backendVersionText}`);

                    // Sync frontend version displays with backend version
                    const frontendVersion = backendInfo.version;
                    document.getElementById('frontend-version').textContent = frontendVersion;

                    // Update other version displays
                    const allSpans = document.querySelectorAll('span');
                    allSpans.forEach(el => {
                        if (el.textContent.includes('v2.1.2')) {
                            el.textContent = el.textContent.replace(/v2\.1\.2/g, frontendVersion);
                        }
                    });

                    // Update paragraph text that contains version
                    const allPs = document.querySelectorAll('p');
                    allPs.forEach(el => {
                        if (el.textContent.includes('v2.1.2')) {
                            el.innerHTML = el.innerHTML.replace(/v2\.1\.2/g, frontendVersion);
                        }
                    });

                    // Update app version if it exists
                    const appVersionEl = document.getElementById('app-version');
                    if (appVersionEl) {
                        appVersionEl.textContent = frontendVersion;
                    }

                    console.log(`üè† Frontend Version synced to: ${frontendVersion}`);
                } else {
                    console.warn('‚ö†Ô∏è Could not fetch backend version');
                    document.getElementById('backend-version').textContent = 'API unavailable';
                }
            } catch (error) {
                console.error('‚ùå Backend version check failed:', error);
                document.getElementById('backend-version').textContent = 'Connection failed';
            }
        }

        // Initialize page
        async function initializePage() {
            // Display frontend version immediately
            console.log(`üöÄ Initializing Charity Tracker ${FRONTEND_VERSION} (${FRONTEND_BUILD})`);

            // Check backend version
            await checkBackendVersion();

            // Check for stored session first
            await checkExistingAuth();

            // Hide all pages first, then show only dashboard
            hideAllPages();
            document.getElementById('dashboard').style.display = 'block';

            // Show correct dashboard view on page load
            if (currentUser) {
                document.getElementById('landing-page').style.display = 'none';
                document.getElementById('user-dashboard').style.display = 'block';
            } else {
                document.getElementById('landing-page').style.display = 'block';
                document.getElementById('user-dashboard').style.display = 'none';
            }

            // Set up navigation event listeners
            const reportsBtn = document.getElementById('reports-nav-btn');
            const profileBtn = document.getElementById('profile-nav-btn');

            if (reportsBtn) {
                reportsBtn.addEventListener('click', function() {
                    showReports();
                });
            }

            if (profileBtn) {
                profileBtn.addEventListener('click', function() {
                    showProfile();
                });
            }
        }

        // Toggle donations list visibility
        function toggleDonationsList() {
            const donationsList = document.getElementById('user-donations');
            const toggleBtn = document.getElementById('toggle-donations-btn');

            if (donationsList.style.display === 'none') {
                donationsList.style.display = 'block';
                toggleBtn.innerHTML = 'üîΩ Hide List';
                toggleBtn.className = 'bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600';
            } else {
                donationsList.style.display = 'none';
                toggleBtn.innerHTML = 'üîº Show List';
                toggleBtn.className = 'bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600';
            }
        }

        // Check if user is already logged in
        async function checkExistingAuth() {
            // Check both sessionStorage and localStorage for stored sessions
            let storedSession = sessionStorage.getItem('auth_session') || localStorage.getItem('auth_session');

            if (storedSession) {
                try {
                    const session = JSON.parse(storedSession);

                    // Check if session has expired
                    if (session.expires && Date.now() > session.expires) {
                        console.log('Session expired, clearing storage');
                        sessionStorage.removeItem('auth_session');
                        localStorage.removeItem('auth_session');
                        showMessage('Your session has expired. Please log in again.', 'error');
                        return;
                    }

                    authToken = session.token;

                    // Only validate if we have a token
                    if (!authToken) {
                        sessionStorage.removeItem('auth_session');
                        // Clear session from both storage types
            sessionStorage.removeItem('auth_session');
            localStorage.removeItem('auth_session');
                        return;
                    }

                    // Validate session with server
                    const response = await fetch(`${API_BASE}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            currentUser = result.data.user;
                            showUserInfo();
                            return;
                        }
                    }
                } catch (error) {
                    console.log('Session validation failed:', error);
                }

                // Clear invalid session
                // Clear session from both storage types
            sessionStorage.removeItem('auth_session');
            localStorage.removeItem('auth_session');
                authToken = null;
                currentUser = null;
            }
        }

        // Admin Panel Functions
        let isAdminMode = false;
        let pendingCharities = [];

        function showAdminPanel() {
            hideAllSections();
            document.getElementById('admin-section').style.display = 'block';
            loadPendingCharities();
        }

        function hideAdminPanel() {
            document.getElementById('admin-section').style.display = 'none';
            showDashboard();
        }

        function showAdminCharities() {
            document.getElementById('admin-charities-tab').className = 'px-4 py-2 bg-red-600 text-white rounded-t-lg';
            document.getElementById('admin-users-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-t-lg ml-1';
            document.getElementById('admin-charities-panel').style.display = 'block';
            document.getElementById('admin-users-panel').style.display = 'none';
            loadPendingCharities();
        }

        function showAdminUsers() {
            document.getElementById('admin-charities-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-t-lg';
            document.getElementById('admin-users-tab').className = 'px-4 py-2 bg-red-600 text-white rounded-t-lg ml-1';
            document.getElementById('admin-charities-panel').style.display = 'none';
            document.getElementById('admin-users-panel').style.display = 'block';
        }

        async function loadPendingCharities() {
            if (!isAdminMode || !authToken) {
                document.getElementById('pending-charities-list').innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <div class="text-4xl mb-2">üö´</div>
                        <p>Admin access required</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/charities/pending`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success && result.data.charities) {
                    pendingCharities = result.data.charities;
                    displayPendingCharities();
                } else {
                    document.getElementById('pending-charities-list').innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">‚úÖ</div>
                            <p>No pending charities to approve</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load pending charities:', error);
                document.getElementById('pending-charities-list').innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <div class="text-4xl mb-2">‚ùå</div>
                        <p>Error loading pending charities</p>
                    </div>
                `;
            }
        }

        function displayPendingCharities() {
            if (pendingCharities.length === 0) {
                document.getElementById('pending-charities-list').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        <p>No pending charities to approve</p>
                    </div>
                `;
                return;
            }

            const charitiesHtml = pendingCharities.map(charity => `
                <div class="bg-gray-50 p-4 rounded-lg border" data-charity-id="${charity.id}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-lg">${charity.name}</h4>
                            <p class="text-sm text-gray-600">EIN: ${charity.ein || 'Not provided'}</p>
                            <p class="text-sm text-gray-600">Submitted by: ${charity.submitter_email || 'Unknown'}</p>
                            <p class="text-sm text-gray-600">Date: ${new Date(charity.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveCharity('${charity.id}', '${charity.name}')"
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                ‚úÖ Approve
                            </button>
                            <button onclick="rejectCharity('${charity.id}', '${charity.name}')"
                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                ‚ùå Reject
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('pending-charities-list').innerHTML = charitiesHtml;
        }

        async function approveCharity(charityId, charityName) {
            if (!confirm(`Approve charity "${charityName}"?`)) return;

            try {
                const response = await fetch(`${API_BASE}/api/charities/${charityId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`Charity "${charityName}" approved successfully!`, 'success');
                    // Remove from pending list
                    pendingCharities = pendingCharities.filter(c => c.id !== charityId);
                    displayPendingCharities();
                } else {
                    showMessage(result.message || 'Failed to approve charity', 'error');
                }
            } catch (error) {
                showMessage('Error approving charity: ' + error.message, 'error');
            }
        }

        async function rejectCharity(charityId, charityName) {
            const reason = prompt(`Reason for rejecting "${charityName}":`);
            if (!reason) return;

            try {
                const response = await fetch(`${API_BASE}/api/charities/${charityId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ reason })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`Charity "${charityName}" rejected.`, 'success');
                    // Remove from pending list
                    pendingCharities = pendingCharities.filter(c => c.id !== charityId);
                    displayPendingCharities();
                } else {
                    showMessage(result.message || 'Failed to reject charity', 'error');
                }
            } catch (error) {
                showMessage('Error rejecting charity: ' + error.message, 'error');
            }
        }

        async function approveAllVisible() {
            if (pendingCharities.length === 0) {
                showMessage('No charities to approve', 'error');
                return;
            }

            if (!confirm(`Approve all ${pendingCharities.length} visible charities?`)) return;

            let approved = 0;
            for (const charity of pendingCharities) {
                try {
                    const response = await fetch(`${API_BASE}/api/charities/${charity.id}/approve`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        approved++;
                    }
                } catch (error) {
                    console.error(`Failed to approve ${charity.name}:`, error);
                }
            }

            showMessage(`Approved ${approved} out of ${pendingCharities.length} charities!`, 'success');
            loadPendingCharities(); // Refresh the list
        }

        function refreshPendingCharities() {
            loadPendingCharities();
        }

        // Modify handleLogin to check for admin mode
        const originalHandleLogin = window.handleLogin;
        window.handleLogin = async function() {
            // Check if admin checkbox is selected
            isAdminMode = document.getElementById('admin-login').checked;

            // Call original login function
            await originalHandleLogin();

            // If admin mode and login successful, show admin message
            if (isAdminMode && currentUser) {
                setTimeout(() => {
                    showMessage('üîê Administrator mode activated', 'success');
                    // Could show admin panel immediately or add admin button
                    setTimeout(() => {
                        if (confirm('Open Administrator Panel?')) {
                            showAdminPanel();
                        }
                    }, 1000);
                }, 500);
            }
        };

        // Auto-start the system
        setTimeout(() => {
            initializePage();
            loadCharities();
        }, 1000);
    </script>
</body>
</html>