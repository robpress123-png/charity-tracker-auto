<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity Tracker - Clean Rebuild</title>
    <!-- Tailwind CSS CDN (for development only - consider PostCSS for production) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #7c3aed 50%, #059669 100%);
        }
        .card {
            @apply bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-100;
        }
        .card-header {
            @apply flex items-center justify-between mb-4 pb-4 border-b border-gray-200;
        }
        .btn-primary {
            @apply bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5 cursor-pointer;
        }
        .btn-success {
            @apply bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5 cursor-pointer;
        }
        .btn-hero {
            @apply bg-gradient-to-r from-green-500 to-emerald-500 text-white px-10 py-4 rounded-xl hover:from-green-600 hover:to-emerald-600 transition-all duration-300 font-bold text-lg shadow-xl hover:shadow-2xl transform hover:-translate-y-1 cursor-pointer border-0 min-w-48;
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4), 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-hero:hover {
            box-shadow: 0 15px 35px rgba(34, 197, 94, 0.6), 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        .btn-hero-secondary {
            @apply bg-gradient-to-r from-blue-500 to-purple-500 text-white px-10 py-4 rounded-xl hover:from-blue-600 hover:to-purple-600 transition-all duration-300 font-bold text-lg shadow-xl hover:shadow-2xl transform hover:-translate-y-1 cursor-pointer border-0 min-w-48;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4), 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-hero-secondary:hover {
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.6), 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            @apply bg-gradient-to-r from-gray-600 to-gray-700 text-white px-4 py-2 rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all duration-200 font-medium;
        }
        .status-badge {
            @apply px-3 py-1 rounded-full text-sm font-medium;
        }
        .status-online {
            @apply bg-green-100 text-green-800;
        }
        .status-verified {
            @apply bg-emerald-100 text-emerald-800;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors;
        }
        .section-title {
            @apply text-2xl font-bold text-gray-800 mb-2;
        }
        .section-subtitle {
            @apply text-gray-600 mb-6;
        }
        .metric-card {
            @apply bg-gradient-to-br p-4 rounded-lg text-white;
        }
        .metric-value {
            @apply text-2xl font-bold;
        }
        .metric-label {
            @apply text-sm opacity-90;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-xl">
        <div class="container mx-auto px-4 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-2">
                        <span class="text-yellow-300">üíù</span> Charity Tracker Pro <span class="text-sm text-yellow-300" id="frontend-version">v2.4.0</span>
                    </h1>
                    <p class="text-blue-100 text-lg">Complete Tax-Optimized Donation Management Platform - <span class="text-yellow-300 font-semibold">v2.4.0</span></p>
                    <p class="text-xs text-blue-200">
                        Frontend: <span id="frontend-build">Build 2025.09.17-MULTIITEM-UI</span> |
                        Backend: <span id="backend-version">Checking...</span>
                    </p>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold">2025</div>
                        <div class="text-sm opacity-75">Tax Year</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold">üèÜ</div>
                        <div class="text-sm opacity-75">Pro Version</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-yellow-300" id="app-version">v2.3.0</div>
                        <div class="text-xs opacity-75">Build 2025.01.17</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Persistent Navigation Bar (for authenticated users) -->
    <div id="main-nav" class="bg-white shadow-md border-b" style="display: none;">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-3">
                <div class="flex space-x-6">
                    <button onclick="showDashboard()" class="flex items-center px-4 py-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                        <span class="mr-2">üè†</span>
                        Dashboard
                    </button>
                    <button onclick="showAddDonation()" class="flex items-center px-4 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors">
                        <span class="mr-2">üíù</span>
                        Add Donation
                    </button>
                    <button id="reports-nav-btn" class="flex items-center px-4 py-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors">
                        <span class="mr-2">üìä</span>
                        Reports
                    </button>
                    <button id="profile-nav-btn" class="flex items-center px-4 py-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                        <span class="mr-2">üë§</span>
                        Profile
                    </button>
                    <button onclick="showTools()" class="flex items-center px-4 py-2 text-gray-600 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors">
                        <span class="mr-2">üîß</span>
                        Tools
                    </button>
                    <button id="admin-nav-btn" onclick="showAdminDashboard()" class="flex items-center px-4 py-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" style="display: none;">
                        <span class="mr-2">‚öôÔ∏è</span>
                        Admin
                    </button>
                </div>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                    <span id="nav-user-name">User</span>
                    <div class="relative">
                        <button onclick="toggleTaxYearDropdown()" class="flex items-center px-3 py-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors border border-blue-200">
                            <span class="mr-1">üìÖ</span>
                            <span id="current-tax-year">2025</span> Tax Year
                            <span class="ml-1">‚ñº</span>
                        </button>
                        <div id="tax-year-dropdown" class="absolute right-0 mt-1 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-50" style="display: none;">
                            <button onclick="selectTaxYear(2025)" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-t-lg">2025 Tax Year</button>
                            <button onclick="selectTaxYear(2026)" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600">2026 Tax Year</button>
                            <button onclick="selectTaxYear(2027)" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-b-lg">2027 Tax Year</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">

        <!-- Authentication Section -->
        <div id="auth-section" class="card" style="display: none;">
            <div class="card-header">
                <h2 class="section-title">üîê Authentication</h2>
                <button onclick="showDashboard()" class="btn-secondary">‚Üê Back to Dashboard</button>
            </div>
            <div class="flex mb-4">
                <button id="login-tab" onclick="showLogin()" class="px-4 py-2 bg-blue-600 text-white rounded-l-lg">Login</button>
                <button id="register-tab" onclick="showRegister()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-r-lg">Register</button>
            </div>
            <div id="login-form">
                <form autocomplete="on">
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="login-email" class="input-field" placeholder="your@email.com" autocomplete="username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="login-password" class="input-field" placeholder="Password" autocomplete="current-password" onkeypress="handleLoginEnter(event)">
                    </div>
                </div>
                <div class="mb-4 space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="remember-me" class="mr-2 rounded">
                        <span class="text-sm text-gray-600">Remember me (keep me logged in for 7 days)</span>
                    </label>
                </div>
                <button onclick="handleLogin()" class="btn-primary" type="button">üîê Login</button>
                </form>
            </div>
            <div id="register-form" style="display: none;">
                <form autocomplete="on">
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Full Name</label>
                        <input type="text" id="register-name" class="input-field" placeholder="John Doe" autocomplete="name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="register-email" class="input-field" placeholder="your@email.com" autocomplete="username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="register-password" class="input-field" placeholder="8+ chars, mixed case, number" autocomplete="new-password" onkeypress="handleRegisterEnter(event)">
                    </div>
                </div>
                <button onclick="handleRegister()" class="btn-success" type="button">‚ú® Create Account</button>
                </form>
            </div>
            <div id="user-info" style="display: none;" class="bg-green-50 p-4 rounded-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-medium" id="user-name"></div>
                        <div class="text-sm text-gray-600" id="user-email"></div>
                        <div class="text-sm text-green-600" id="user-license"></div>
                    </div>
                    <button onclick="handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
                </div>
            </div>
            <div id="auth-message" class="mt-4"></div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="space-y-6">
            <!-- Landing Page for Non-Authenticated Users -->
            <div id="landing-page">
                <!-- Hero Section -->
                <div class="card text-center">
                    <div class="max-w-4xl mx-auto">
                        <div class="text-6xl mb-6">üíù</div>
                        <h2 class="text-4xl font-bold text-gray-800 mb-4">Maximize Your Tax Savings</h2>
                        <p class="text-xl text-gray-600 mb-8">Track all donation types, get accurate valuations, and generate tax-ready reports with our comprehensive charity tracking platform.</p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                            <button onclick="showRegister()" class="btn-hero">
                                üöÄ Get Started Free
                            </button>
                            <button onclick="showLogin()" class="btn-hero-secondary">
                                üë§ Sign In
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="card text-center">
                        <div class="text-4xl mb-4">üíµ</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">5 Donation Types</h3>
                        <p class="text-gray-600">Track money, items, mileage, stock, and crypto donations with automatic tax calculations and IRS compliance.</p>
                    </div>
                    <div class="card text-center">
                        <div class="text-4xl mb-4">üìä</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Tax-Ready Reports</h3>
                        <p class="text-gray-600">Generate consolidated summaries and detailed line-item reports. Export CSV files ready for your tax preparer.</p>
                    </div>
                    <div class="card text-center">
                        <div class="text-4xl mb-4">üéØ</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Smart Valuations</h3>
                        <p class="text-gray-600">Get accurate item valuations based on IRS guidelines and current mileage rates (14¬¢/mile for 2025).</p>
                    </div>
                </div>

                <!-- Platform Stats -->
                <div class="card">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Trusted by Generous Donors</h3>
                        <p class="text-gray-600">Join thousands who are maximizing their charitable impact</p>
                    </div>
                    <div class="grid md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-600">$2.5M+</div>
                            <div class="text-sm text-gray-600">Donations Tracked</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-600">15,000+</div>
                            <div class="text-sm text-gray-600">Transactions Recorded</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-purple-600">500+</div>
                            <div class="text-sm text-gray-600">Verified Charities</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-indigo-600">2025</div>
                            <div class="text-sm text-gray-600">Tax Year Ready</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Authenticated User Dashboard -->
            <div id="user-dashboard" style="display: none;">
                <!-- Welcome Header with User Info -->
                <div class="card">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">
                                Welcome back, <span id="dashboard-user-name">Demo User</span>! üëã
                            </h2>
                            <p class="text-gray-600" id="dashboard-user-status">Ready to track donations</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 mb-1">2025 Tax Year</div>
                            <button onclick="handleLogout()" class="text-sm text-red-600 hover:text-red-800 font-medium">Logout</button>
                        </div>
                    </div>
                </div>

                <!-- Key Statistics - Prominently Displayed -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold opacity-90 mb-1">Total Donations</h3>
                                <div class="text-3xl font-bold" id="total-donations">0</div>
                                <div class="text-sm opacity-80 mt-1">This year</div>
                            </div>
                            <div class="text-4xl opacity-80">üìä</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold opacity-90 mb-1">Amount Donated</h3>
                                <div class="text-3xl font-bold" id="tax-deductible">$0</div>
                                <div class="text-sm opacity-80 mt-1">Tax deductible</div>
                            </div>
                            <div class="text-4xl opacity-80">üí∞</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-pink-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold opacity-90 mb-1">Estimated Tax Savings</h3>
                                <div class="text-3xl font-bold" id="estimated-savings">$0</div>
                                <div class="text-sm opacity-80 mt-1" id="tax-bracket-display">At 24% bracket</div>
                            </div>
                            <div class="text-4xl opacity-80">üéØ</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <button onclick="showAddDonation()" class="flex items-center justify-center p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <span class="text-2xl mr-3">üíù</span>
                            <div class="text-left">
                                <div class="font-semibold">Add Donation</div>
                                <div class="text-sm opacity-90">Record new donation</div>
                            </div>
                        </button>

                        <button onclick="showReports()" class="flex items-center justify-center p-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <span class="text-2xl mr-3">üìä</span>
                            <div class="text-left">
                                <div class="font-semibold">View Reports</div>
                                <div class="text-sm opacity-90">Generate tax documents</div>
                            </div>
                        </button>

                        <button onclick="showProfile()" class="flex items-center justify-center p-4 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <span class="text-2xl mr-3">üë§</span>
                            <div class="text-left">
                                <div class="font-semibold">Profile</div>
                                <div class="text-sm opacity-90">Account settings</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Recent Activity Summary -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üéØ 2025 Progress</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Donations This Year</span>
                                <span class="font-semibold" id="donations-this-year">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Charities Supported</span>
                                <span class="font-semibold" id="charity-count-dash">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Average per Donation</span>
                                <span class="font-semibold" id="average-donation">$0</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìã Donation Types</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">üíµ Money</span>
                                <span class="font-semibold" id="money-count">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">üì¶ Items</span>
                                <span class="font-semibold" id="items-count">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">üöó Mileage</span>
                                <span class="font-semibold" id="mileage-count">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">üìà Stock/Crypto</span>
                                <span class="font-semibold" id="investments-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Donation Type Selection Page -->
        <div id="donation-type-selection-page" class="space-y-6" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="section-title">Choose Donation Type</h2>
                    <span class="text-sm text-gray-600">Select the type of donation you'd like to record</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <!-- Items Donation Card -->
                <div onclick="showItemsDonationPage()" class="donation-type-card group relative bg-white p-8 border-2 border-gray-200 rounded-2xl shadow-lg hover:shadow-2xl cursor-pointer transition-all duration-300 transform hover:-translate-y-2">
                    <div class="text-center">
                        <div class="flex justify-center items-center w-16 h-16 mx-auto mb-6 bg-gradient-to-r from-blue-400 to-blue-600 group-hover:from-blue-500 group-hover:to-blue-700 rounded-2xl shadow-lg">
                            <span class="text-3xl text-white">üì¶</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-3">Items</h3>
                        <p class="text-sm text-gray-600 mb-4">Clothing, household goods, electronics</p>
                        <div class="bg-blue-50 text-blue-700 text-xs px-3 py-1 rounded-full font-medium">Multi-Item Support</div>
                    </div>
                </div>

                <!-- Money Donation Card -->
                <div onclick="showMoneyDonationPage()" class="donation-type-card group relative bg-white p-8 border-2 border-gray-200 rounded-2xl shadow-lg hover:shadow-2xl cursor-pointer transition-all duration-300 transform hover:-translate-y-2">
                    <div class="text-center">
                        <div class="flex justify-center items-center w-16 h-16 mx-auto mb-6 bg-gradient-to-r from-green-400 to-green-600 group-hover:from-green-500 group-hover:to-green-700 rounded-2xl shadow-lg">
                            <span class="text-3xl text-white">üíµ</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-3">Money</h3>
                        <p class="text-sm text-gray-600 mb-4">Cash donations, checks</p>
                        <div class="bg-green-50 text-green-700 text-xs px-3 py-1 rounded-full font-medium">Tax Deductible</div>
                    </div>
                </div>

                <!-- Mileage Donation Card -->
                <div onclick="showMileageDonationPage()" class="donation-type-card group relative bg-white p-8 border-2 border-gray-200 rounded-2xl shadow-lg hover:shadow-2xl cursor-pointer transition-all duration-300 transform hover:-translate-y-2">
                    <div class="text-center">
                        <div class="flex justify-center items-center w-16 h-16 mx-auto mb-6 bg-gradient-to-r from-orange-400 to-orange-600 group-hover:from-orange-500 group-hover:to-orange-700 rounded-2xl shadow-lg">
                            <span class="text-3xl text-white">üöó</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-3">Mileage</h3>
                        <p class="text-sm text-gray-600 mb-4">Volunteer driving</p>
                        <div class="bg-orange-50 text-orange-700 text-xs px-3 py-1 rounded-full font-medium">14¬¢/mile</div>
                    </div>
                </div>

                <!-- Stock Donation Card -->
                <div onclick="showStockDonationPage()" class="donation-type-card group relative bg-white p-8 border-2 border-gray-200 rounded-2xl shadow-lg hover:shadow-2xl cursor-pointer transition-all duration-300 transform hover:-translate-y-2">
                    <div class="text-center">
                        <div class="flex justify-center items-center w-16 h-16 mx-auto mb-6 bg-gradient-to-r from-purple-400 to-purple-600 group-hover:from-purple-500 group-hover:to-purple-700 rounded-2xl shadow-lg">
                            <span class="text-3xl text-white">üìà</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-3">Stock</h3>
                        <p class="text-sm text-gray-600 mb-4">Securities, shares</p>
                        <div class="bg-purple-50 text-purple-700 text-xs px-3 py-1 rounded-full font-medium">Tax Advantage</div>
                    </div>
                </div>

                <!-- Crypto Donation Card -->
                <div onclick="showCryptoDonationPage()" class="donation-type-card group relative bg-white p-8 border-2 border-gray-200 rounded-2xl shadow-lg hover:shadow-2xl cursor-pointer transition-all duration-300 transform hover:-translate-y-2">
                    <div class="text-center">
                        <div class="flex justify-center items-center w-16 h-16 mx-auto mb-6 bg-gradient-to-r from-yellow-400 to-yellow-600 group-hover:from-yellow-500 group-hover:to-yellow-700 rounded-2xl shadow-lg">
                            <span class="text-3xl text-white">‚Çø</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-3">Crypto</h3>
                        <p class="text-sm text-gray-600 mb-4">Digital assets</p>
                        <div class="bg-yellow-50 text-yellow-700 text-xs px-3 py-1 rounded-full font-medium">Capital Gains</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Donation Form -->
        <div id="donation-form-page" class="space-y-6" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="flex items-center">
                        <button onclick="showDonationTypeSelection()" class="text-blue-600 hover:text-blue-800 mr-4">
                            ‚Üê Back to Donation Types
                        </button>
                        <h2 class="section-title" id="donation-form-title">Add New Donation</h2>
                    </div>
                </div>
            </div>

            <div class="card">
            <div class="card-header">
                <h2 class="section-title">üí∞ Donation Management Center</h2>
                <div class="flex space-x-2">
                    <span class="status-badge status-verified">‚úÖ Tax Optimized</span>
                    <span class="status-badge status-verified">üîí Secure</span>
                </div>
            </div>

            <!-- User's Donations List -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">üìä Your Donations</h3>
                    <div class="flex gap-2">
                        <button onclick="toggleDonationsList()" id="toggle-donations-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            üîº Show List
                        </button>
                        <button onclick="loadUserDonations()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            üîÑ Refresh List
                        </button>
                    </div>
                </div>
                <div id="user-donations" class="space-y-2" style="display: none;">
                    <div class="text-gray-500 text-center p-4">Click "Refresh List" to load your donations</div>
                </div>
            </div>

            <hr class="my-6">

            <!-- Create New Donation -->
            <h3 class="text-lg font-semibold mb-4">‚ûï Create New Donation</h3>
            <form id="donation-form" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium mb-2">Charity</label>
                        <input type="text" id="charity-search" class="input-field" placeholder="Type to search charities..." autocomplete="off" required>
                        <input type="hidden" id="charity-select" required>
                        <div id="charity-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto" style="display: none;"></div>
                        <div id="add-new-charity" class="mt-2" style="display: none;">
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-blue-800">Add New Charity</span>
                                    <button type="button" onclick="cancelAddCharity()" class="text-blue-600 hover:text-blue-800 text-sm">‚úï</button>
                                </div>
                                <div class="grid gap-2">
                                    <input type="text" id="new-charity-name" class="w-full p-2 border rounded text-sm" placeholder="Charity Name">
                                    <input type="text" id="new-charity-ein" class="w-full p-2 border rounded text-sm" placeholder="EIN (Optional)" pattern="[0-9]{2}-[0-9]{7}">
                                    <input type="text" id="new-charity-address" class="w-full p-2 border rounded text-sm" placeholder="Street Address (Optional)">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="text" id="new-charity-city" class="w-full p-2 border rounded text-sm" placeholder="City">
                                        <input type="text" id="new-charity-state" class="w-full p-2 border rounded text-sm" placeholder="State" maxlength="2">
                                    </div>
                                    <input type="text" id="new-charity-zip" class="w-full p-2 border rounded text-sm" placeholder="ZIP Code" pattern="[0-9]{5}(-[0-9]{4})?">
                                    <button type="button" onclick="saveNewCharity()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Add Charity</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Donation Type</label>
                        <div class="p-3 bg-gray-50 border rounded-lg">
                            <span id="selected-donation-type" class="text-gray-600">No type selected</span>
                        </div>
                        <input type="hidden" id="donation-type" required>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Date</label>
                        <input type="date" id="donation-date" class="input-field" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Amount ($)</label>
                        <input type="number" id="amount" step="0.01" class="input-field" required>
                    </div>
                </div>

                <!-- Type-specific fields -->
                <div id="type-specific-fields"></div>

                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <input type="text" id="description" class="input-field"
                           placeholder="Optional description">
                </div>

                <div class="flex justify-start">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        ‚úÖ Save Donation
                    </button>
                </div>
            </form>

            <div id="donation-result" class="mt-4"></div>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reports-page" class="space-y-6">
            <!-- Page Header -->
            <div class="card">
                <div class="card-header">
                    <h2 class="section-title">üìä Donation Reports & Tax Documents</h2>
                    <button onclick="showDashboard()" class="btn-secondary">‚Üê Back to Dashboard</button>
                </div>
                <p class="section-subtitle">Export donation data and generate tax-optimized reports</p>
            </div>

            <!-- Report Type Selection -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Consolidated Reports -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-bold text-gray-800">üìà Consolidated Reports</h3>
                        <span class="status-badge status-verified">Summary View</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">Total donations by charity, type, and date ranges</p>
                    <div class="space-y-3">
                        <button onclick="showConsolidatedReport()" class="btn-primary w-full">
                            üìã View Summary Report
                        </button>
                        <button onclick="exportConsolidatedCSV()" class="btn-secondary w-full">
                            üìÑ Export CSV Summary
                        </button>
                    </div>
                </div>

                <!-- Individual Item Reports -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-bold text-gray-800">üì¶ Individual Item Reports</h3>
                        <span class="status-badge status-verified">Detailed View</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">Line-by-line donation details for IRS documentation</p>
                    <div class="space-y-3">
                        <button onclick="showDetailedReport()" class="btn-primary w-full">
                            üìù View Detailed Report
                        </button>
                        <button onclick="exportDetailedCSV()" class="btn-secondary w-full">
                            üìÑ Export CSV Details
                        </button>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800">üéØ Export Options</h3>
                    <span class="status-badge status-verified">Tax Ready</span>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Tax Year</label>
                        <select id="report-year" class="input-field">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Date Range</label>
                        <select id="report-range" class="input-field">
                            <option value="all">All Time</option>
                            <option value="ytd">Year to Date</option>
                            <option value="q4">Q4 (Oct-Dec)</option>
                            <option value="q3">Q3 (Jul-Sep)</option>
                            <option value="q2">Q2 (Apr-Jun)</option>
                            <option value="q1">Q1 (Jan-Mar)</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>
                <div id="custom-date-range" class="grid md:grid-cols-2 gap-4 mt-4" style="display: none;">
                    <div>
                        <label class="block text-sm font-medium mb-2">Start Date</label>
                        <input type="date" id="report-start-date" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">End Date</label>
                        <input type="date" id="report-end-date" class="input-field">
                    </div>
                </div>
                <div class="mt-4 flex space-x-4">
                    <button onclick="exportPDFReport()" class="btn-success">
                        üìë Generate PDF Tax Report
                    </button>
                    <button onclick="exportAllCSV()" class="btn-primary">
                        üìä Export Complete CSV
                    </button>
                </div>
            </div>

            <!-- Report Display Area -->
            <div id="report-display" class="card" style="display: none;">
                <div class="card-header">
                    <h3 id="report-display-title" class="text-lg font-bold text-gray-800">Report Results</h3>
                    <button onclick="closeReport()" class="btn-secondary">‚úï Close</button>
                </div>
                <div id="report-content"></div>
            </div>

            <!-- Report Statistics -->
            <div class="grid md:grid-cols-4 gap-4">
                <div class="card text-center">
                    <div class="text-2xl font-bold text-green-600" id="total-tax-deductible">$0</div>
                    <div class="text-sm text-gray-600">Total Tax Deductible</div>
                </div>
                <div class="card text-center">
                    <div class="text-2xl font-bold text-blue-600" id="total-donations-count">0</div>
                    <div class="text-sm text-gray-600">Total Donations</div>
                </div>
                <div class="card text-center">
                    <div class="text-2xl font-bold text-purple-600" id="unique-charities">0</div>
                    <div class="text-sm text-gray-600">Charities Supported</div>
                </div>
                <div class="card text-center">
                    <div class="text-2xl font-bold text-indigo-600" id="avg-donation">$0</div>
                    <div class="text-sm text-gray-600">Average Donation</div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="space-y-6">
            <!-- Page Header -->
            <div class="card">
                <div class="card-header">
                    <h2 class="section-title">üë§ Profile & Tax Settings</h2>
                    <span class="status-badge status-verified">Pro Account</span>
                </div>
                <p class="section-subtitle">Manage your account and tax calculation preferences</p>
            </div>

            <!-- User Information -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800">Account Information</h3>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">Full Name</label>
                        <input type="text" id="profile-name" class="input-field" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Email Address</label>
                        <input type="email" id="profile-email" class="input-field" readonly>
                    </div>
                </div>
            </div>

            <!-- Tax Settings -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800">Tax Calculation Settings</h3>
                    <span class="text-sm text-gray-500">Used for estimated tax savings calculations</span>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">Filing Status</label>
                        <select id="filing-status" class="input-field" onchange="updateTaxBracket()">
                            <option value="single">Single</option>
                            <option value="married-joint">Married Filing Jointly</option>
                            <option value="married-separate">Married Filing Separately</option>
                            <option value="head-of-household">Head of Household</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Annual Income</label>
                        <select id="income-range" class="input-field" onchange="updateTaxBracket()">
                            <option value="0-44725">$0 - $44,725 (10-12%)</option>
                            <option value="44726-95375">$44,726 - $95,375 (22%)</option>
                            <option value="95376-182050" selected>$95,376 - $182,050 (24%)</option>
                            <option value="182051-231250">$182,051 - $231,250 (32%)</option>
                            <option value="231251-578125">$231,251 - $578,125 (35%)</option>
                            <option value="578126+">$578,126+ (37%)</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-blue-800">Current Tax Bracket</h4>
                            <p class="text-blue-700 text-sm">Used for estimating charitable deduction savings</p>
                        </div>
                        <div class="text-2xl font-bold text-blue-800" id="current-tax-rate">24%</div>
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="saveTaxSettings()" class="btn-primary">Save Tax Settings</button>
                </div>
            </div>

            <!-- Account Stats -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800">Account Statistics</h3>
                </div>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="profile-total-donations">0</div>
                        <div class="text-sm text-gray-600">Total Donations</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="profile-tax-deductible">$0</div>
                        <div class="text-sm text-gray-600">Tax Deductible</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600" id="profile-estimated-savings">$0</div>
                        <div class="text-sm text-gray-600">Estimated Savings</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Page -->
        <div id="tools-page" class="space-y-6">
            <!-- Page Header -->
            <div class="card">
                <div class="card-header">
                    <h2 class="section-title">üîß Tools & Data Management</h2>
                    <span class="status-badge status-verified">Admin Tools</span>
                </div>
                <p class="section-subtitle">Manage your donation data and perform maintenance tasks</p>
            </div>

            <!-- Delete Donations Tool -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800 text-red-600">üóëÔ∏è Delete Donations</h3>
                </div>
                <div class="space-y-4">
                    <p class="text-gray-600">Select donations to permanently delete from your records. This action cannot be undone.</p>

                    <div class="grid gap-4">
                        <div class="flex space-x-4">
                            <button onclick="loadDeletableDonations()" class="btn-primary">
                                üìã Load All Donations
                            </button>
                            <button onclick="deleteSelectedDonations()" class="btn-danger" id="delete-selected-btn" disabled>
                                üóëÔ∏è Delete Selected
                            </button>
                        </div>

                        <div id="deletable-donations-list" class="border rounded-lg p-4 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-4xl mb-2">üìã</div>
                                <p>Click "Load All Donations" to see your donation history</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Charities Tool -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800 text-blue-600">üè† Personal Charities</h3>
                </div>
                <div class="space-y-4">
                    <p class="text-gray-600">View and manage your personal charity entries for diagnostic purposes.</p>

                    <div class="grid gap-4">
                        <div class="flex space-x-4">
                            <button onclick="loadPersonalCharities()" class="btn-primary">
                                üè† Load Personal Charities
                            </button>
                            <button onclick="refreshCharityList()" class="btn-secondary">
                                üîÑ Refresh Charity List
                            </button>
                        </div>

                        <div id="personal-charities-list" class="border rounded-lg p-4 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-4xl mb-2">üè†</div>
                                <p>Click "Load Personal Charities" to see your charity entries</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Future Tools Section -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold text-gray-800">üöÄ Coming Soon</h3>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold mb-2">üìä Data Export</h4>
                        <p class="text-sm text-gray-600">Export all your data in various formats</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold mb-2">üîÑ Data Import</h4>
                        <p class="text-sm text-gray-600">Import donations from other platforms</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold mb-2">üßπ Data Cleanup</h4>
                        <p class="text-sm text-gray-600">Find and fix duplicate entries</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold mb-2">üìà Analytics</h4>
                        <p class="text-sm text-gray-600">Advanced donation analytics and insights</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel (hidden by default) -->

        <!-- Items Donation Page -->
        <div id="items-donation-page" class="space-y-6" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="flex items-center">
                        <button onclick="showDonationTypeSelection()" class="text-blue-600 hover:text-blue-800 mr-4">
                            ‚Üê Back to Donation Types
                        </button>
                        <h2 class="section-title">üì¶ Items Donation</h2>
                    </div>
                    <div class="flex space-x-2">
                        <span class="status-badge status-verified">‚úÖ Multi-Item Support</span>
                        <span class="status-badge status-verified">üí∞ Auto-Valuation</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                <!-- Left column - Main form and item entry (2/3 width) -->
                <div class="xl:col-span-2 space-y-6">
                    <!-- Charity Information -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold">üè¢ Charity Information</h3>
                        </div>
                        <form id="items-donation-form" class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="relative">
                                    <label class="block text-sm font-medium mb-2">Charity</label>
                                    <input type="text" id="items-charity-search" class="input-field" placeholder="Type to search charities..." autocomplete="off" required>
                                    <input type="hidden" id="items-charity-select" required>
                                    <div id="items-charity-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto" style="display: none;"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Date</label>
                                    <input type="date" id="items-donation-date" class="input-field" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Description (Optional)</label>
                                <input type="text" id="items-description" class="input-field" placeholder="e.g., Household cleanout, seasonal clothing">
                            </div>
                        </form>
                    </div>

                    <!-- Add Items Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold">‚ûï Add Items</h3>
                            <span class="text-sm text-gray-500">Add each item individually</span>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Item Category</label>
                                <select id="items-item-category" class="input-field" onchange="updateItemsItemTypes()">
                                    <option value="">Select category...</option>
                                    <option value="appliances">Appliances</option>
                                    <option value="mens-clothing">Men's Clothing</option>
                                    <option value="womens-clothing">Women's Clothing</option>
                                    <option value="childrens-clothing">Children's Clothing</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="books-media">Books & Media</option>
                                    <option value="household">Household Items</option>
                                    <option value="kitchen">Kitchen Items</option>
                                    <option value="sports">Sports & Recreation</option>
                                    <option value="toys">Toys & Games</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Item Type</label>
                                <select id="items-item-type" class="input-field" onchange="updateItemsItemValue()">
                                    <option value="">Select item...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Condition</label>
                                <select id="items-item-condition" class="input-field" onchange="updateItemsItemValue()">
                                    <option value="excellent">Excellent</option>
                                    <option value="good" selected>Good</option>
                                    <option value="fair">Fair</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Quantity</label>
                                <input type="number" id="items-item-quantity" class="input-field" value="1" min="1" onchange="updateItemsItemValue()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Fair Market Value (each)</label>
                                <div class="flex items-center space-x-2">
                                    <span class="text-gray-600 text-sm">$</span>
                                    <input type="number" id="items-fair-market-value" step="0.01" class="input-field" placeholder="0.00" onchange="updateItemsItemValue()" readonly>
                                    <span class="text-sm text-gray-500">auto-calculated</span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Description (Optional)</label>
                            <input type="text" id="items-item-description" class="input-field" placeholder="e.g., Brand, size, color">
                        </div>
                        <div class="text-center">
                            <button type="button" onclick="addItemsItemToReceipt()" class="btn-primary">
                                ‚ûï Add Item to Donation
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right column - Receipt (1/3 width) -->
                <div class="xl:col-span-1">
                    <div class="card sticky top-6">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold">üßæ Donation Receipt</h3>
                            <span class="text-sm text-gray-500">Items: <span id="items-receipt-count">0</span></span>
                        </div>

                        <div id="items-receipt-items" class="space-y-2 mb-4 min-h-32">
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-3xl mb-2">üì¶</div>
                                <p class="text-sm">No items added yet</p>
                                <p class="text-xs">Add items using the form</p>
                            </div>
                        </div>

                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-4">
                                <span class="font-semibold">Total Value:</span>
                                <span id="items-receipt-total" class="font-bold text-green-600">$0.00</span>
                            </div>
                            <button type="button" onclick="saveItemsDonation()" class="btn-success w-full" disabled id="save-items-donation-btn">
                                üíæ Save Donation
                            </button>
                            <p class="text-xs text-gray-500 mt-2 text-center">Add at least one item to save</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard Page -->
        <div id="admin-dashboard-page" class="space-y-6" style="display: none;">
            <!-- Admin Header -->
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="section-title">üîß Administrator Dashboard</h2>
                            <p class="text-sm text-gray-600">System administration and management</p>
                        </div>
                        <button onclick="showDashboard()" class="btn-secondary">
                            ‚Üê Back to User Dashboard
                        </button>
                    </div>
                </div>
            </div>

            <!-- Admin Navigation -->
            <div class="card">
                <div class="border-b border-gray-200">
                    <div class="flex space-x-8 px-6">
                        <button onclick="showAdminSection('system-stats')" class="admin-nav-link border-blue-500 text-blue-600 py-4 px-1 border-b-2 font-medium text-sm">
                            üìä System Stats
                        </button>
                        <button onclick="showAdminSection('charity-mgmt')" class="admin-nav-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 border-b-2 font-medium text-sm">
                            ‚ù§Ô∏è Charities
                        </button>
                        <button onclick="showAdminSection('user-mgmt')" class="admin-nav-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 border-b-2 font-medium text-sm">
                            üë• Users
                        </button>
                        <button onclick="showAdminSection('admin-tools')" class="admin-nav-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 border-b-2 font-medium text-sm">
                            üõ†Ô∏è Admin Tools
                        </button>
                    </div>
                </div>
            </div>

            <!-- System Stats Section -->
            <div id="admin-system-stats" class="admin-section">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
                    <!-- Total Users -->
                    <div class="card">
                        <div class="card-header">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">üë•</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Total Users</p>
                                    <p id="stat-total-users" class="text-2xl font-bold text-gray-900">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Donations -->
                    <div class="card">
                        <div class="card-header">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">üéÅ</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Total Donations</p>
                                    <p id="stat-total-donations" class="text-2xl font-bold text-gray-900">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Value -->
                    <div class="card">
                        <div class="card-header">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">üí∞</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Total Value</p>
                                    <p id="stat-total-value" class="text-2xl font-bold text-green-600">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Charities -->
                    <div class="card">
                        <div class="card-header">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">üè¢</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Total Charities</p>
                                    <p id="stat-total-charities" class="text-2xl font-bold text-gray-900">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-medium text-gray-900">Recent User Activity</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Donations</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Activity</th>
                                </tr>
                            </thead>
                            <tbody id="admin-user-activity-table" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading user activity...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Charity Management Section -->
            <div id="admin-charity-mgmt" class="admin-section hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-gray-900">Charity Database Management</h3>
                            <button onclick="showAddCharityForm()" class="btn-primary">
                                ‚ûï Add New Charity
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EIN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-charity-table" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading charities...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- User Management Section -->
            <div id="admin-user-mgmt" class="admin-section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-medium text-gray-900">User Account Management</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Donations</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-user-table" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Tools Section -->
            <div id="admin-admin-tools" class="admin-section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-medium text-gray-900">Administrative Tools</h3>
                        <p class="text-sm text-gray-600">Advanced system administration and management tools</p>
                    </div>

                    <!-- Tools Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6">
                        <!-- Database Management -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border border-blue-200">
                            <div class="flex items-center mb-4">
                                <div class="flex justify-center items-center w-10 h-10 bg-blue-600 rounded-lg mr-3">
                                    <span class="text-white text-lg">üóÑÔ∏è</span>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900">Database Management</h4>
                            </div>
                            <div class="space-y-2">
                                <button onclick="exportAllData()" class="w-full text-left p-2 text-sm bg-white rounded border hover:bg-gray-50">
                                    üì§ Export All Data
                                </button>
                                <button onclick="showSystemLogs()" class="w-full text-left p-2 text-sm bg-white rounded border hover:bg-gray-50">
                                    üìã System Logs
                                </button>
                                <button onclick="showDatabaseStats()" class="w-full text-left p-2 text-sm bg-white rounded border hover:bg-gray-50">
                                    üìä Database Statistics
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Database administration tools</p>
                        </div>

                        <!-- User Management Tools -->
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border border-green-200">
                            <div class="flex items-center mb-4">
                                <div class="flex justify-center items-center w-10 h-10 bg-green-600 rounded-lg mr-3">
                                    <span class="text-white text-lg">üë•</span>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900">User Management</h4>
                            </div>
                            <div class="space-y-2">
                                <button onclick="showUserManagement()" class="w-full text-left p-2 text-sm bg-white rounded border hover:bg-gray-50">
                                    üë§ Manage Users
                                </button>
                                <button onclick="showPendingCharities()" class="w-full text-left p-2 text-sm bg-white rounded border hover:bg-gray-50">
                                    ‚è≥ Pending Charities
                                </button>
                                <button onclick="showUserActivity()" class="w-full text-left p-2 text-sm bg-white rounded border hover:bg-gray-50">
                                    üìä User Activity
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">User account administration</p>
                        </div>

                        <!-- System Configuration -->
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg border border-purple-200">
                            <div class="flex items-center mb-4">
                                <div class="flex justify-center items-center w-10 h-10 bg-purple-600 rounded-lg mr-3">
                                    <span class="text-white text-lg">‚öôÔ∏è</span>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900">System Config</h4>
                            </div>
                            <div class="space-y-2">
                                <button onclick="showGlobalSettings()" class="w-full text-left p-2 text-sm bg-white rounded border hover:bg-gray-50">
                                    ‚öôÔ∏è Global Settings
                                </button>
                                <button onclick="showTaxRateConfig()" class="w-full text-left p-2 text-sm bg-white rounded border hover:bg-gray-50">
                                    üí∞ Tax Rate Updates
                                </button>
                                <button onclick="showSecuritySettings()" class="w-full text-left p-2 text-sm bg-white rounded border hover:bg-gray-50">
                                    üîê Security Settings
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">System-wide configuration</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Version Information - Independent from backend
        const FRONTEND_VERSION = 'v2.5.1';
        const FRONTEND_BUILD = '2025.09.18-ADMIN-DEBUG';

        const API_BASE = 'https://charity-tracker-api.robpress123.workers.dev';

        // Log version info for debugging (immediate)
        console.log(`üè† Frontend Version: ${FRONTEND_VERSION} (${FRONTEND_BUILD})`);
        console.log(`üåê API Base: ${API_BASE}`);
        console.log('üìã Console logging is working - you should see debug messages!');

        // Comprehensive Charities Database
        let charities = [
            { id: 'charity-red-cross', name: 'American Red Cross', address: '2025 E Street, NW', city: 'Washington, DC 20006', ein: '53-0196605' },
            { id: 'charity-goodwill', name: 'Goodwill Industries International', address: '15810 Indianola Drive', city: 'Rockville, MD 20855', ein: '53-0196517' },
            { id: 'charity-salvation-army', name: 'The Salvation Army', address: '615 Slaters Lane', city: 'Alexandria, VA 22313', ein: '13-1623001' },
            { id: 'charity-united-way', name: 'United Way Worldwide', address: '701 N Fairfax Street', city: 'Alexandria, VA 22314', ein: '13-1635294' },
            { id: 'charity-habitat', name: 'Habitat for Humanity International', address: '121 Habitat Street', city: 'Americus, GA 31709', ein: '91-1914868' },
            { id: 'charity-st-jude', name: 'St. Jude Children\'s Research Hospital', address: '501 St. Jude Place', city: 'Memphis, TN 38105', ein: '62-0646012' },
            { id: 'charity-feeding-america', name: 'Feeding America', address: '35 E Wacker Drive', city: 'Chicago, IL 60601', ein: '36-3673599' },
            { id: 'charity-wounded-warrior', name: 'Wounded Warrior Project', address: '4899 Belfort Road', city: 'Jacksonville, FL 32256', ein: '20-2370934' },
            { id: 'charity-cancer-society', name: 'American Cancer Society', address: '250 Williams Street NW', city: 'Atlanta, GA 30303', ein: '13-1788491' },
            { id: 'charity-heart-association', name: 'American Heart Association', address: '7272 Greenville Avenue', city: 'Dallas, TX 75231', ein: '13-5613797' }
        ];

        // Comprehensive Item Categories Database with Pricing & Source Tracking
        const itemCategories = {
            'appliances': {
                name: 'Appliances',
                items: [
                    { id: 'air-conditioner', name: 'Air Conditioner', values: { fair: 21.00, good: 57.00, excellent: 93.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'coffee-maker', name: 'Coffee Maker', values: { fair: 4.00, good: 10.00, excellent: 16.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'dryer', name: 'Dryer', values: { fair: 47.00, good: 70.00, excellent: 93.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'microwave', name: 'Microwave', values: { fair: 10.00, good: 30.00, excellent: 50.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'refrigerator', name: 'Refrigerator', values: { fair: 78.00, good: 168.50, excellent: 259.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'washing-machine', name: 'Washing Machine', values: { fair: 41.00, good: 98.50, excellent: 156.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'mens-clothing': {
                name: "Men's Clothing",
                items: [
                    { id: 'mens-suit', name: "Men's Suit", values: { fair: 16.00, good: 39.00, excellent: 62.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'mens-dress-shirt', name: "Men's Dress Shirt", values: { fair: 3.00, good: 7.50, excellent: 12.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'mens-jeans', name: "Men's Jeans", values: { fair: 4.00, good: 12.50, excellent: 21.00 }, source: 'Goodwill', lastUpdated: '2025-01-01' },
                    { id: 'mens-shoes', name: "Men's Shoes", values: { fair: 4.00, good: 15.00, excellent: 26.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'mens-jacket', name: "Men's Jacket", values: { fair: 8.00, good: 17.00, excellent: 26.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'mens-overcoat', name: "Men's Overcoat", values: { fair: 16.00, good: 39.00, excellent: 62.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'mens-sweater', name: "Men's Sweater", values: { fair: 5.00, good: 10.00, excellent: 15.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'mens-shorts', name: "Men's Shorts", values: { fair: 4.00, good: 7.00, excellent: 10.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'mens-slacks', name: "Men's Slacks", values: { fair: 5.00, good: 8.50, excellent: 12.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'womens-clothing': {
                name: "Women's Clothing",
                items: [
                    { id: 'womens-dress', name: "Women's Dress", values: { fair: 4.00, good: 12.00, excellent: 20.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-blouse', name: "Women's Blouse", values: { fair: 3.00, good: 7.50, excellent: 12.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-suit', name: "Women's Suit", values: { fair: 6.00, good: 18.00, excellent: 30.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-handbag', name: "Women's Handbag", values: { fair: 3.00, good: 12.00, excellent: 21.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-coat', name: "Women's Coat", values: { fair: 10.00, good: 25.50, excellent: 41.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-evening-dress', name: "Women's Evening Dress", values: { fair: 10.00, good: 36.00, excellent: 62.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'womens-shoes', name: "Women's Shoes", values: { fair: 4.00, good: 15.00, excellent: 26.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-sweater', name: "Women's Sweater", values: { fair: 5.00, good: 10.00, excellent: 15.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'womens-skirt', name: "Women's Skirt", values: { fair: 3.00, good: 5.50, excellent: 8.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'womens-slacks', name: "Women's Slacks", values: { fair: 4.00, good: 8.00, excellent: 12.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'childrens-clothing': {
                name: "Children's Clothing",
                items: [
                    { id: 'childrens-shirt', name: "Children's Shirt", values: { fair: 2.00, good: 4.00, excellent: 6.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'childrens-dress', name: "Children's Dress", values: { fair: 4.00, good: 8.00, excellent: 12.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'childrens-pants', name: "Children's Pants", values: { fair: 3.00, good: 6.00, excellent: 9.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'childrens-shoes', name: "Children's Shoes", values: { fair: 3.00, good: 8.00, excellent: 13.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'childrens-jacket', name: "Children's Jacket", values: { fair: 4.00, good: 10.00, excellent: 16.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' }
                ]
            },
            'furniture': {
                name: 'Furniture',
                items: [
                    { id: 'sofa', name: 'Sofa/Couch', values: { fair: 36.00, good: 121.50, excellent: 207.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'desk', name: 'Desk', values: { fair: 30.00, good: 87.50, excellent: 145.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'dresser', name: 'Dresser with Mirror', values: { fair: 21.00, good: 62.50, excellent: 104.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'dining-table', name: 'Dining Table', values: { fair: 36.00, good: 106.00, excellent: 176.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'bed-full', name: 'Bed (Full/Queen/King)', values: { fair: 52.00, good: 114.00, excellent: 176.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'coffee-table', name: 'Coffee Table', values: { fair: 16.00, good: 41.50, excellent: 67.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'chair-upholstered', name: 'Upholstered Chair', values: { fair: 26.00, good: 65.00, excellent: 104.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'electronics': {
                name: 'Electronics',
                items: [
                    { id: 'computer-system', name: 'Computer System', values: { fair: 104.00, good: 259.50, excellent: 415.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'computer-printer', name: 'Computer Printer', values: { fair: 5.00, good: 80.00, excellent: 155.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'computer-monitor', name: 'Computer Monitor', values: { fair: 5.00, good: 28.00, excellent: 51.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'tv-color', name: 'Color TV', values: { fair: 78.00, good: 155.50, excellent: 233.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'stereo-system', name: 'Stereo System', values: { fair: 16.00, good: 47.00, excellent: 78.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'dvd-player', name: 'DVD Player', values: { fair: 8.00, good: 12.00, excellent: 16.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'radio', name: 'Radio', values: { fair: 8.00, good: 30.00, excellent: 52.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'books-media': {
                name: 'Books & Media',
                items: [
                    { id: 'hardcover-book', name: 'Hardcover Book', values: { fair: 1.00, good: 2.00, excellent: 3.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'paperback-book', name: 'Paperback Book', values: { fair: 1.00, good: 1.50, excellent: 2.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'cd', name: 'CD', values: { fair: 2.00, good: 3.50, excellent: 5.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'dvd', name: 'DVD', values: { fair: 2.00, good: 3.50, excellent: 5.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' }
                ]
            },
            'household': {
                name: 'Household Items',
                items: [
                    { id: 'bedspread', name: 'Bedspread/Quilt', values: { fair: 3.00, good: 14.00, excellent: 25.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'blanket', name: 'Blanket', values: { fair: 3.00, good: 9.50, excellent: 16.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'curtains', name: 'Curtains', values: { fair: 2.00, good: 7.00, excellent: 12.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'lamp', name: 'Lamp', values: { fair: 5.00, good: 41.50, excellent: 78.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'pillow', name: 'Pillow', values: { fair: 2.00, good: 5.00, excellent: 8.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'towel', name: 'Towel', values: { fair: 0.50, good: 2.25, excellent: 4.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'kitchen': {
                name: 'Kitchen Items',
                items: [
                    { id: 'dishes-set', name: 'Dishes/Dinnerware Set', values: { fair: 8.00, good: 20.00, excellent: 45.00 }, source: 'Kitchen', lastUpdated: '2025-01-01' },
                    { id: 'glass-cup', name: 'Glass/Cup', values: { fair: 0.50, good: 1.25, excellent: 2.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'pot-pan', name: 'Pot/Pan', values: { fair: 1.00, good: 2.00, excellent: 3.00 }, source: 'Merged Data', lastUpdated: '2025-01-01' },
                    { id: 'kitchen-utensils', name: 'Kitchen Utensils', values: { fair: 0.50, good: 1.25, excellent: 2.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'mixer-blender', name: 'Mixer/Blender', values: { fair: 5.00, good: 13.00, excellent: 21.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            },
            'sports': {
                name: 'Sports & Recreation',
                items: [
                    { id: 'bicycle', name: 'Bicycle', values: { fair: 5.00, good: 44.00, excellent: 83.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'tennis-racket', name: 'Tennis Racket', values: { fair: 2.00, good: 3.50, excellent: 5.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'golf-clubs', name: 'Golf Clubs (individual)', values: { fair: 2.00, good: 14.00, excellent: 26.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'ice-skates', name: 'Ice Skates', values: { fair: 3.00, good: 9.50, excellent: 16.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' },
                    { id: 'roller-blades', name: 'Roller Blades', values: { fair: 3.00, good: 9.50, excellent: 16.00 }, source: 'Salvation Army', lastUpdated: '2025-01-01' }
                ]
            }
        };

        // Flatten for backward compatibility (flat array of all items)
        const allDonationItems = Object.values(itemCategories).flatMap(category =>
            category.items.map(item => ({ ...item, category: category.name }))
        );

        // Set today's date
        document.getElementById('donation-date').value = new Date().toISOString().split('T')[0];

        // Setup donation type change handler
        document.getElementById('donation-type').addEventListener('change', updateTypeSpecificFields);


        // Load Charities (combines personal and master charities)
        async function loadCharities() {
            try {
                // Always load master/approved charities
                const masterResponse = await fetch(`${API_BASE}/api/charities?verified=true`, {
                    headers: {
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    }
                });

                let allCharities = [...charities]; // Start with hardcoded backup

                if (masterResponse.ok) {
                    const masterData = await masterResponse.json();
                    if (masterData.success && masterData.data.charities) {
                        // Replace hardcoded with real data from API
                        allCharities = masterData.data.charities.map(charity => ({
                            id: charity.id,
                            name: charity.name,
                            ein: charity.ein || '',
                            address: '', // Will be parsed from metadata if needed
                            city: '',
                            verified: charity.is_verified,
                            source: 'master'
                        }));
                    }
                }

                // If user is logged in, also load their personal charities
                if (authToken) {
                    try {
                        const userResponse = await fetch(`${API_BASE}/api/user-charities`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });

                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            if (userData.success && userData.data.charities) {
                                // Add personal charities with special marking
                                const personalCharities = userData.data.charities.map(charity => ({
                                    id: charity.id,
                                    name: `${charity.name} (Personal)`,
                                    ein: charity.ein || '',
                                    address: charity.address || '',
                                    city: charity.city || '',
                                    state: charity.state || '',
                                    zip: charity.zip || '',
                                    verified: false,
                                    source: 'personal',
                                    original_name: charity.name,
                                    is_submitted_for_approval: charity.is_submitted_for_approval
                                }));
                                allCharities = [...allCharities, ...personalCharities];
                            }
                        }
                    } catch (error) {
                        console.warn('Could not load personal charities:', error);
                    }
                }

                charities = allCharities;
                console.log(`üìä Frontend v${FRONTEND_VERSION} loaded ${charities.length} charities total`);
                setupCharityAutocomplete();

            } catch (error) {
                console.error('Failed to load charities:', error);
                console.log(`üìä Frontend v${FRONTEND_VERSION} using ${charities.length} backup charities (API unavailable)`);
                setupCharityAutocomplete();
            }
        }

        // Authenticated Donation Creation
        document.getElementById('donation-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentUser) {
                showMessage('Please login to create donations', 'error');
                showLogin();
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Creating...';
            submitButton.disabled = true;

            try {
                const charitySelect = document.getElementById('charity-select');
                const formData = {
                    charity_id: charitySelect.value,
                    charity_name: charitySelect.getAttribute('data-charity-name') || '',
                    charity_address: charitySelect.getAttribute('data-charity-address') || '',
                    charity_ein: charitySelect.getAttribute('data-charity-ein') || '',
                    type: document.getElementById('donation-type').value,
                    date: document.getElementById('donation-date').value,
                    tax_deductible_amount: parseFloat(document.getElementById('amount').value),
                    description: document.getElementById('description').value || 'Donation via Charity Tracker'
                };

                // Add type-specific data
                const type = formData.type;
                if (type === 'items') {
                    formData.item_category = document.getElementById('item-category')?.value;
                    formData.item_type = document.getElementById('item-type')?.value;
                    formData.item_condition = document.getElementById('item-condition')?.value;
                } else if (type === 'mileage') {
                    formData.miles_driven = parseFloat(document.getElementById('miles-driven')?.value || 0);
                    formData.mileage_rate = parseFloat(document.getElementById('mileage-rate')?.value || 0.14);
                } else if (type === 'stock') {
                    formData.stock_symbol = document.getElementById('stock-symbol')?.value;
                    formData.shares = parseFloat(document.getElementById('stock-shares')?.value || 0);
                    formData.cost_basis = parseFloat(document.getElementById('stock-cost-basis')?.value || 0);
                } else if (type === 'crypto') {
                    formData.crypto_currency = document.getElementById('crypto-currency')?.value;
                    formData.crypto_amount = parseFloat(document.getElementById('crypto-amount')?.value || 0);
                    formData.cost_basis = parseFloat(document.getElementById('crypto-cost-basis')?.value || 0);
                }

                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                console.log('üîç DEBUG: Sending donation data:', formData);
                console.log('üîç DEBUG: Charity select value:', charitySelect.value);
                console.log('üîç DEBUG: Charity select data attributes:', {
                    name: charitySelect.getAttribute('data-charity-name'),
                    address: charitySelect.getAttribute('data-charity-address'),
                    ein: charitySelect.getAttribute('data-charity-ein')
                });

                const response = await fetch(`${API_BASE}/api/donations`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(formData)
                });

                console.log('üîç DEBUG: Response status:', response.status);
                console.log('üîç DEBUG: Response headers:', Object.fromEntries(response.headers.entries()));

                const result = await response.json();
                console.log('üîç DEBUG: Response result:', result);

                if (result.success) {
                    showMessage('Donation created successfully! Saved to D1 database.', 'success');
                    document.getElementById('donation-form').reset();
                    document.getElementById('type-specific-fields').innerHTML = '';
                    document.getElementById('donation-date').value = new Date().toISOString().split('T')[0];
                    loadUserDonations(); // Refresh the donation list
                    loadDashboardStats(); // Refresh dashboard stats
                } else {
                    console.error('‚ùå DEBUG: Donation failed:', result);
                    showMessage(result.message || 'Failed to create donation', 'error');
                }

            } catch (error) {
                showMessage('Error creating donation: ' + error.message, 'error');
            }

            submitButton.textContent = originalText;
            submitButton.disabled = false;
        });


        // Update type-specific fields based on donation type
        function updateTypeSpecificFields() {
            const type = document.getElementById('donation-type').value;
            const container = document.getElementById('type-specific-fields');

            container.innerHTML = '';

            switch(type) {
                case 'items':
                    container.innerHTML = `
                        <div class="bg-blue-50 p-4 rounded-lg mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-lg font-semibold text-blue-800">üì¶ Multi-Item Donation</h4>
                                <span class="text-sm text-blue-600">Add multiple items to one donation</span>
                            </div>
                            <p class="text-sm text-blue-700">Perfect for donating multiple items to a thrift store or charity. Add each item individually, then save the entire donation.</p>
                        </div>

                        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                            <!-- Left column - Item form (2/3 width) -->
                            <div class="xl:col-span-2">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="text-lg font-semibold mb-4">Add Item</h4>
                                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Item Category</label>
                                            <select id="item-category" class="w-full p-3 border rounded-lg" onchange="updateItemTypes()">
                                                <option value="">Select category...</option>
                                                <option value="Clothing">Clothing</option>
                                                <option value="Household">Household Items</option>
                                                <option value="Electronics">Electronics</option>
                                                <option value="Books">Books & Media</option>
                                                <option value="Furniture">Furniture</option>
                                                <option value="Sports">Sports Equipment</option>
                                                <option value="Toys">Toys & Games</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Item Type</label>
                                            <select id="item-type" class="w-full p-3 border rounded-lg" onchange="updateItemValue()">
                                                <option value="">Select item...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Condition</label>
                                            <select id="item-condition" class="w-full p-3 border rounded-lg" onchange="updateItemValue()">
                                                <option value="good">Good</option>
                                                <option value="fair">Fair</option>
                                                <option value="poor">Poor</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Quantity</label>
                                            <input type="number" id="item-quantity" class="w-full p-3 border rounded-lg" value="1" min="1" onchange="updateItemValue()">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Suggested Value (each)</label>
                                            <div class="p-3 bg-blue-50 border rounded-lg">
                                                <span id="suggested-value" class="text-blue-800 font-medium">Select item for valuation</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Fair Market Value (each)</label>
                                            <input type="number" id="fair-market-value" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00" onchange="updateItemValue()">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">Description (Optional)</label>
                                        <input type="text" id="item-description" class="w-full p-3 border rounded-lg" placeholder="e.g., Brand, size, specific details">
                                    </div>
                                    <div class="text-center">
                                        <button type="button" onclick="addItemToReceipt()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold transform hover:-translate-y-0.5 transition-all duration-200">
                                            ‚ûï Add Item to Donation
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Right column - Receipt (1/3 width) -->
                            <div class="xl:col-span-1">
                                <div class="bg-white border border-gray-200 rounded-lg p-4 sticky top-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-semibold">üßæ Donation Receipt</h4>
                                        <span class="text-sm text-gray-500">Items: <span id="receipt-count">0</span></span>
                                    </div>

                                    <div id="receipt-items" class="space-y-2 mb-4 min-h-32">
                                        <div class="text-center text-gray-500 py-8">
                                            <div class="text-3xl mb-2">üì¶</div>
                                            <p class="text-sm">No items added yet</p>
                                            <p class="text-xs">Add items using the form</p>
                                        </div>
                                    </div>

                                    <div class="border-t pt-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-semibold">Total Value:</span>
                                            <span id="receipt-total" class="font-bold text-green-600">$0.00</span>
                                        </div>
                                        <p class="text-xs text-gray-500">Final donation will be saved when you click "Create Donation" below</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'mileage':
                    container.innerHTML = `
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Miles Driven</label>
                                <input type="number" id="miles" step="0.1" class="w-full p-3 border rounded-lg" placeholder="0.0" onchange="calculateMileageValue()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">IRS Rate 2025 ($/mile)</label>
                                <input type="number" id="mileage-rate" step="0.001" value="0.14" class="w-full p-3 border rounded-lg" onchange="calculateMileageValue()">
                                <div class="text-xs text-gray-500 mt-1">14¬¢/mile - statutory rate for charitable use</div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Calculated Value</label>
                                <div class="p-3 bg-green-50 border rounded-lg">
                                    <span id="mileage-value" class="text-green-800 font-medium">$0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium mb-2">Purpose</label>
                            <input type="text" id="mileage-purpose" class="w-full p-3 border rounded-lg" placeholder="e.g., Volunteer work, charity event">
                        </div>
                    `;
                    break;

                case 'stock':
                    container.innerHTML = `
                        <div class="grid md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Stock Symbol</label>
                                <input type="text" id="stock-symbol" class="w-full p-3 border rounded-lg" placeholder="AAPL" style="text-transform: uppercase;">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Shares</label>
                                <input type="number" id="shares" step="0.001" class="w-full p-3 border rounded-lg" placeholder="0" onchange="calculateStockGains()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Current Price ($)</label>
                                <input type="number" id="current-price" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00" onchange="calculateStockGains()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Cost Basis ($)</label>
                                <input type="number" id="cost-basis" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00" onchange="calculateStockGains()">
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-purple-50 rounded-lg">
                            <h4 class="font-medium text-purple-800 mb-2">Tax Benefits Summary</h4>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p><strong>Market Value:</strong> <span id="stock-market-value">$0.00</span></p>
                                    <p><strong>Capital Gains Avoided:</strong> <span id="capital-gains-avoided">$0.00</span></p>
                                </div>
                                <div>
                                    <p><strong>Tax Deduction:</strong> <span id="stock-deduction">$0.00</span></p>
                                    <p><strong>Total Tax Benefit:</strong> <span id="total-stock-benefit">$0.00</span></p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'crypto':
                    container.innerHTML = `
                        <div class="grid md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Cryptocurrency</label>
                                <select id="crypto-type" class="w-full p-3 border rounded-lg">
                                    <option value="BTC">Bitcoin (BTC)</option>
                                    <option value="ETH">Ethereum (ETH)</option>
                                    <option value="ADA">Cardano (ADA)</option>
                                    <option value="SOL">Solana (SOL)</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Amount</label>
                                <input type="number" id="crypto-amount" step="0.00000001" class="w-full p-3 border rounded-lg" placeholder="0.00000000" onchange="calculateCryptoGains()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Current Price ($)</label>
                                <input type="number" id="crypto-current-price" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00" onchange="calculateCryptoGains()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Cost Basis ($)</label>
                                <input type="number" id="crypto-cost-basis" step="0.01" class="w-full p-3 border rounded-lg" placeholder="0.00" onchange="calculateCryptoGains()">
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-orange-50 rounded-lg">
                            <h4 class="font-medium text-orange-800 mb-2">Crypto Tax Benefits</h4>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p><strong>Current Value:</strong> <span id="crypto-current-value">$0.00</span></p>
                                    <p><strong>Capital Gains Avoided:</strong> <span id="crypto-gains-avoided">$0.00</span></p>
                                </div>
                                <div>
                                    <p><strong>Tax Deduction:</strong> <span id="crypto-deduction">$0.00</span></p>
                                    <p><strong>Total Benefit:</strong> <span id="total-crypto-benefit">$0.00</span></p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        // Item valuation data (simplified version)
        const itemValues = {
            'Clothing': {
                "Men's Shirt": { good: 8.00, fair: 4.00, poor: 2.00 },
                "Women's Dress": { good: 12.00, fair: 6.00, poor: 3.00 },
                "Pants/Slacks": { good: 10.00, fair: 5.00, poor: 2.50 },
                "Shoes": { good: 15.00, fair: 8.00, poor: 4.00 },
                "Coat/Jacket": { good: 25.00, fair: 12.00, poor: 6.00 }
            },
            'Household': {
                "Coffee Maker": { good: 15.00, fair: 8.00, poor: 4.00 },
                "Microwave": { good: 50.00, fair: 25.00, poor: 12.00 },
                "Toaster": { good: 10.00, fair: 5.00, poor: 2.50 },
                "Dishes (set)": { good: 20.00, fair: 10.00, poor: 5.00 },
                "Cookware": { good: 30.00, fair: 15.00, poor: 7.50 }
            },
            'Electronics': {
                "Television (32\" or less)": { good: 75.00, fair: 40.00, poor: 20.00 },
                "Computer Monitor": { good: 60.00, fair: 30.00, poor: 15.00 },
                "Smartphone": { good: 200.00, fair: 100.00, poor: 50.00 },
                "Tablet": { good: 150.00, fair: 75.00, poor: 35.00 }
            },
            'Books': {
                "Hardcover Book": { good: 3.00, fair: 1.50, poor: 0.75 },
                "Paperback Book": { good: 1.50, fair: 0.75, poor: 0.35 },
                "Textbook": { good: 15.00, fair: 8.00, poor: 4.00 }
            }
        };

        function updateItemTypes() {
            const category = document.getElementById('item-category').value;
            const typeSelect = document.getElementById('item-type');

            typeSelect.innerHTML = '<option value="">Select item...</option>';

            if (category && itemValues[category]) {
                Object.keys(itemValues[category]).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    typeSelect.appendChild(option);
                });
            }
        }

        function updateItemValue() {
            const category = document.getElementById('item-category').value;
            const itemType = document.getElementById('item-type').value;
            const condition = document.getElementById('item-condition').value;

            if (category && itemType && condition && itemValues[category] && itemValues[category][itemType]) {
                const value = itemValues[category][itemType][condition];
                document.getElementById('suggested-value').textContent = `$${value.toFixed(2)}`;
                document.getElementById('fair-market-value').value = value.toFixed(2);
                document.getElementById('amount').value = value.toFixed(2);
            }
        }

        function calculateMileageValue() {
            const miles = parseFloat(document.getElementById('miles').value) || 0;
            const rate = parseFloat(document.getElementById('mileage-rate').value) || 0.14;
            const value = miles * rate;

            document.getElementById('mileage-value').textContent = `$${value.toFixed(2)}`;
            document.getElementById('amount').value = value.toFixed(2);
        }

        function calculateStockGains() {
            const shares = parseFloat(document.getElementById('shares').value) || 0;
            const currentPrice = parseFloat(document.getElementById('current-price').value) || 0;
            const costBasis = parseFloat(document.getElementById('cost-basis').value) || 0;

            const marketValue = shares * currentPrice;
            const totalCostBasis = shares * costBasis;
            const capitalGains = marketValue - totalCostBasis;
            const taxOnGains = capitalGains * 0.20; // Assuming 20% capital gains rate
            const deduction = marketValue * getUserTaxRate(); // Use actual tax bracket
            const totalBenefit = taxOnGains + deduction;

            document.getElementById('stock-market-value').textContent = `$${marketValue.toFixed(2)}`;
            document.getElementById('capital-gains-avoided').textContent = `$${taxOnGains.toFixed(2)}`;
            document.getElementById('stock-deduction').textContent = `$${deduction.toFixed(2)}`;
            document.getElementById('total-stock-benefit').textContent = `$${totalBenefit.toFixed(2)}`;
            document.getElementById('amount').value = marketValue.toFixed(2);
        }

        function calculateCryptoGains() {
            const amount = parseFloat(document.getElementById('crypto-amount').value) || 0;
            const currentPrice = parseFloat(document.getElementById('crypto-current-price').value) || 0;
            const costBasis = parseFloat(document.getElementById('crypto-cost-basis').value) || 0;

            const currentValue = amount * currentPrice;
            const originalValue = amount * (costBasis / amount);
            const capitalGains = currentValue - originalValue;
            const taxOnGains = capitalGains * 0.20;
            const deduction = currentValue * getUserTaxRate(); // Use actual tax bracket
            const totalBenefit = taxOnGains + deduction;

            document.getElementById('crypto-current-value').textContent = `$${currentValue.toFixed(2)}`;
            document.getElementById('crypto-gains-avoided').textContent = `$${taxOnGains.toFixed(2)}`;
            document.getElementById('crypto-deduction').textContent = `$${deduction.toFixed(2)}`;
            document.getElementById('total-crypto-benefit').textContent = `$${totalBenefit.toFixed(2)}`;
            document.getElementById('amount').value = currentValue.toFixed(2);
        }

        // Authentication Variables
        let currentUser = null;
        let authToken = null;
        let currentTaxYear = 2025;

        // Authentication Functions
        function showLogin() {
            document.getElementById('login-tab').className = 'px-4 py-2 bg-blue-600 text-white rounded-l-lg';
            document.getElementById('register-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-r-lg';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('login-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-l-lg';
            document.getElementById('register-tab').className = 'px-4 py-2 bg-blue-600 text-white rounded-r-lg';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showMessage('Please enter both email and password', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (result.success) {
                    currentUser = result.data.user;
                    authToken = result.data.token;

                    // Store session based on user preference
                    const rememberMe = document.getElementById('remember-me')?.checked || false;
                    const storage = rememberMe ? localStorage : sessionStorage;
                    const expireTime = rememberMe ?
                        Date.now() + (7 * 24 * 60 * 60 * 1000) : // 7 days if remember me
                        Date.now() + (2 * 60 * 60 * 1000); // 2 hours for session only

                    storage.setItem('auth_session', JSON.stringify({
                        token: authToken,
                        user: currentUser,
                        expires: expireTime,
                        remember: rememberMe
                    }));

                    showUserInfo();
                    showMessage('Login successful!', 'success');
                    enableDonationFeatures();
                } else {
                    showMessage(result.message || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('Login error: ' + error.message, 'error');
            }
        }

        async function handleRegister() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            if (!name || !email || !password) {
                showMessage('Please fill in all registration fields', 'error');
                return;
            }

            if (password.length < 8) {
                showMessage('Password must be at least 8 characters', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, password })
                });

                const result = await response.json();

                if (result.success) {
                    currentUser = result.data.user;
                    authToken = result.data.token;

                    // Store session based on user preference
                    const rememberMe = document.getElementById('remember-me')?.checked || false;
                    const storage = rememberMe ? localStorage : sessionStorage;
                    const expireTime = rememberMe ?
                        Date.now() + (7 * 24 * 60 * 60 * 1000) : // 7 days if remember me
                        Date.now() + (2 * 60 * 60 * 1000); // 2 hours for session only

                    storage.setItem('auth_session', JSON.stringify({
                        token: authToken,
                        user: currentUser,
                        expires: expireTime,
                        remember: rememberMe
                    }));

                    showUserInfo();
                    showMessage('Registration successful!', 'success');
                    enableDonationFeatures();
                } else {
                    showMessage(result.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showMessage('Registration error: ' + error.message, 'error');
            }
        }

        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST'
                });
            } catch (error) {
                console.log('Logout request failed:', error);
            }

            currentUser = null;
            authToken = null;

            // Clear stored session
            // Clear session from both storage types
            sessionStorage.removeItem('auth_session');
            localStorage.removeItem('auth_session');

            hideUserInfo();
            showMessage('Logged out successfully', 'success');
            disableDonationFeatures();
        }

        function showUserInfo() {
            if (currentUser) {
                // Normalize user data from API response
                const userName = currentUser.name || `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || 'User';
                const userLicense = currentUser.license_type || (currentUser.is_admin ? 'admin' : 'standard');
                const donationLimit = currentUser.donation_limit || 'unlimited';

                // Update auth section with safety checks
                const userNameEl = document.getElementById('user-name');
                const userEmailEl = document.getElementById('user-email');
                const userLicenseEl = document.getElementById('user-license');

                if (userNameEl) userNameEl.textContent = userName;
                if (userEmailEl) userEmailEl.textContent = currentUser.email;
                if (userLicenseEl) userLicenseEl.textContent = `${userLicense.toUpperCase()} - ${donationLimit} donations/month`;

                const authSection = document.getElementById('auth-section');
                const userInfo = document.getElementById('user-info');

                if (authSection) {
                    const loginForm = authSection.querySelector('#login-form');
                    const registerForm = authSection.querySelector('#register-form');
                    if (loginForm) loginForm.style.display = 'none';
                    if (registerForm) registerForm.style.display = 'none';
                }
                if (userInfo) userInfo.style.display = 'block';

                // Update dashboard header with safety checks
                const dashboardUserName = document.getElementById('dashboard-user-name');
                const dashboardUserStatus = document.getElementById('dashboard-user-status');

                if (dashboardUserName) dashboardUserName.textContent = userName;
                if (dashboardUserStatus) dashboardUserStatus.textContent = `${userLicense.toUpperCase()} Account - Ready to track donations`;

                // Update navigation bar with safety checks
                const navUserName = document.getElementById('nav-user-name');
                const mainNav = document.getElementById('main-nav');

                if (navUserName) navUserName.textContent = userName;
                if (mainNav) mainNav.style.display = 'block';

                // Show/hide admin navigation button based on user role
                const adminNavBtn = document.getElementById('admin-nav-btn');
                console.log('üîß Admin Detection Debug:');
                console.log('   currentUser:', currentUser);
                console.log('   currentUser.is_admin:', currentUser.is_admin);
                console.log('   currentUser.email:', currentUser.email);
                console.log('   adminNavBtn element:', adminNavBtn);

                if (adminNavBtn) {
                    const isAdmin = currentUser.is_admin || currentUser.email === 'test@example.com';
                    adminNavBtn.style.display = isAdmin ? 'flex' : 'none';
                    console.log('   Setting admin button display to:', isAdmin ? 'flex' : 'none');
                }

                // Update profile page with safety checks
                const profileName = document.getElementById('profile-name');
                const profileEmail = document.getElementById('profile-email');

                if (profileName) profileName.value = currentUser.name || `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || userName;
                if (profileEmail) profileEmail.value = currentUser.email;

                // Update subscription display
                updateSubscriptionDisplay();

                // Show user dashboard, hide landing page
                document.getElementById('landing-page').style.display = 'none';
                document.getElementById('user-dashboard').style.display = 'block';

                // Load user statistics and tax settings
                loadTaxSettingsFromDB().then(() => {
                    loadDashboardStats();
                    loadUserDonations();
                });

                // Only show dashboard on first login, not when already logged in
                if (document.getElementById('auth-section').style.display === 'block') {
                    // User just logged in from auth page, show dashboard
                    showDashboard();
                }
            }
        }

        function hideUserInfo() {
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('main-nav').style.display = 'none';

            // Show landing page, hide user dashboard
            document.getElementById('landing-page').style.display = 'block';
            document.getElementById('user-dashboard').style.display = 'none';

            showDashboard();
        }

        async function loadDashboardStats() {
            if (!currentUser || !authToken) return;

            try {
                const response = await fetch(`${API_BASE}/api/donations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();

                if (result.success && result.data.donations) {
                    const donations = result.data.donations;
                    const totalDonations = donations.length;
                    const totalTaxDeductible = donations.reduce((sum, d) => sum + d.tax_deductible_amount, 0);
                    const uniqueCharities = new Set(donations.map(d => d.charity_id)).size;
                    const averageDonation = totalDonations > 0 ? totalTaxDeductible / totalDonations : 0;
                    const taxRate = getUserTaxRate();
                    const estimatedSavings = totalTaxDeductible * taxRate;

                    // Count by donation type
                    const typeCounts = {
                        money: donations.filter(d => d.type === 'money').length,
                        items: donations.filter(d => d.type === 'items').length,
                        mileage: donations.filter(d => d.type === 'mileage').length,
                        stock: donations.filter(d => d.type === 'stock').length,
                        crypto: donations.filter(d => d.type === 'crypto').length
                    };

                    // Update main stats
                    document.getElementById('total-donations').textContent = totalDonations;
                    document.getElementById('tax-deductible').textContent = `$${totalTaxDeductible.toFixed(2)}`;
                    document.getElementById('estimated-savings').textContent = `$${estimatedSavings.toFixed(2)}`;

                    // Update tax bracket display
                    const taxBracketElement = document.getElementById('tax-bracket-display');
                    if (taxBracketElement) {
                        taxBracketElement.textContent = `At ${(taxRate * 100).toFixed(0)}% bracket`;
                    }

                    // Update progress section
                    document.getElementById('donations-this-year').textContent = totalDonations;
                    document.getElementById('charity-count-dash').textContent = uniqueCharities;
                    document.getElementById('average-donation').textContent = `$${averageDonation.toFixed(2)}`;

                    // Update donation type counts
                    document.getElementById('money-count').textContent = typeCounts.money;
                    document.getElementById('items-count').textContent = typeCounts.items;
                    document.getElementById('mileage-count').textContent = typeCounts.mileage;
                    document.getElementById('investments-count').textContent = typeCounts.stock + typeCounts.crypto;

                    // Update profile page stats if they exist
                    const profileTotalElement = document.getElementById('profile-total-donations');
                    const profileTaxElement = document.getElementById('profile-tax-deductible');
                    const profileSavingsElement = document.getElementById('profile-estimated-savings');

                    if (profileTotalElement) profileTotalElement.textContent = totalDonations;
                    if (profileTaxElement) profileTaxElement.textContent = `$${totalTaxDeductible.toFixed(2)}`;
                    if (profileSavingsElement) profileSavingsElement.textContent = `$${estimatedSavings.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Tax Settings Functions
        let userTaxRate = 0.24; // Default to 24%

        function getUserTaxRate() {
            // Use saved tax rate from currentUser if available
            return currentUser && currentUser.taxRate ? currentUser.taxRate / 100 : userTaxRate;
        }


        function updateTaxBracket() {
            const incomeRange = document.getElementById('income-range').value;

            // Determine tax rate based on income range
            const taxRates = {
                '0-44725': 0.12,
                '44726-95375': 0.22,
                '95376-182050': 0.24,
                '182051-231250': 0.32,
                '231251-578125': 0.35,
                '578126+': 0.37
            };

            userTaxRate = taxRates[incomeRange] || 0.24;
            document.getElementById('current-tax-rate').textContent = `${(userTaxRate * 100).toFixed(0)}%`;

            // Update savings calculation on dashboard if stats are loaded
            if (currentUser) {
                loadDashboardStats();
            }
        }

        function enableDonationFeatures() {
            const donationSection = document.getElementById('step3');
            if (donationSection) {
                donationSection.style.display = 'block';
                // Update create donation button to use authenticated API
                const createBtn = donationSection.querySelector('button[onclick*="createDonation"]');
                if (createBtn) {
                    createBtn.innerHTML = '‚úÖ Save Donation';
                    createBtn.style.cssText = `
                        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                        color: white;
                        padding: 14px 28px;
                        border: none;
                        border-radius: 8px;
                        font-weight: 600;
                        font-size: 16px;
                        cursor: pointer;
                        width: 100%;
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                        transition: all 0.2s ease;
                        transform: translateY(0);
                    `;
                    createBtn.onmouseover = function() {
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 6px 20px rgba(59, 130, 246, 0.4)';
                    };
                    createBtn.onmouseout = function() {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
                    };
                }
            }
        }

        function disableDonationFeatures() {
            const donationSection = document.getElementById('step3');
            if (donationSection) {
                const createBtn = donationSection.querySelector('button[onclick*="createDonation"]');
                if (createBtn) {
                    createBtn.textContent = 'üîí Login Required for Donations';
                }
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('auth-message');
            messageDiv.innerHTML = `
                <div class="p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // Load user's donations from backend
        async function loadUserDonations() {
            if (!currentUser) {
                document.getElementById('user-donations').innerHTML = `
                    <div class="text-red-500 text-center p-4">Please login to view donations</div>
                `;
                return;
            }

            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`${API_BASE}/api/donations`, {
                    method: 'GET',
                    headers: headers
                });

                const result = await response.json();

                if (result.success && result.data.donations) {
                    const donations = result.data.donations;

                    if (donations.length === 0) {
                        document.getElementById('user-donations').innerHTML = `
                            <div class="text-gray-500 text-center p-4">No donations yet. Create your first donation below!</div>
                        `;
                        return;
                    }

                    let donationsHtml = '';
                    donations.forEach(donation => {
                        donationsHtml += `
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border">
                                <div class="flex-1">
                                    <div class="font-medium">${donation.charity_name || 'Unknown Charity'}</div>
                                    <div class="text-sm text-gray-600">
                                        ${donation.type.charAt(0).toUpperCase() + donation.type.slice(1)} ‚Ä¢ $${donation.tax_deductible_amount.toFixed(2)} ‚Ä¢ ${donation.date}
                                    </div>
                                    ${donation.description ? `<div class="text-xs text-gray-500">${donation.description}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-green-600 font-medium">$${donation.tax_deductible_amount.toFixed(2)}</div>
                                    <div class="text-xs text-gray-500">${donation.created_at ? new Date(donation.created_at).toLocaleDateString() : ''}</div>
                                </div>
                            </div>
                        `;
                    });

                    document.getElementById('user-donations').innerHTML = donationsHtml;
                } else {
                    document.getElementById('user-donations').innerHTML = `
                        <div class="text-red-500 text-center p-4">Failed to load donations: ${result.message}</div>
                    `;
                }

            } catch (error) {
                document.getElementById('user-donations').innerHTML = `
                    <div class="text-red-500 text-center p-4">Error loading donations: ${error.message}</div>
                `;
            }
        }

        // Navigation Functions
        function showDashboard() {
            hideAllPages();
            document.getElementById('dashboard').style.display = 'block';

            // Show appropriate dashboard view based on authentication
            if (currentUser) {
                document.getElementById('landing-page').style.display = 'none';
                document.getElementById('user-dashboard').style.display = 'block';
            } else {
                document.getElementById('landing-page').style.display = 'block';
                document.getElementById('user-dashboard').style.display = 'none';
            }
        }

        function showDonationTypeSelection() {
            if (!currentUser) {
                showMessage('Please login or register to create donations', 'error');
                showLogin();
                return;
            }
            hideAllPages();
            document.getElementById('donation-type-selection-page').style.display = 'block';
        }

        function showAddDonation() {
            // Redirect to donation type selection page
            showDonationTypeSelection();
        }

        function showReports() {
            // Don't replace container, just replace the reports page content
            hideAllPages();

            const reportsPage = document.getElementById('reports-page');

            reportsPage.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 80vh; padding: 40px; border-radius: 15px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <h1 style="font-size: 3.5rem; margin: 0 0 20px 0; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üìä Reports & Analytics</h1>
                    <p style="text-align: center; font-size: 1.2rem; margin-bottom: 40px; opacity: 0.9;">Generate comprehensive donation reports for tax documentation</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 40px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 15px 0;">üìà Consolidated Reports</h3>
                            <p style="margin: 0 0 20px 0; opacity: 0.9;">Summary view of all donations by charity and type</p>
                            <button onclick="generateSummaryReport()" style="background: #fff; color: #667eea; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px;">View Summary</button>
                            <button onclick="exportSummaryCSV()" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; width: 100%;">Export CSV</button>
                        </div>

                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 15px 0;">üìÑ Detailed Reports</h3>
                            <p style="margin: 0 0 20px 0; opacity: 0.9;">Line-by-line donation details for IRS documentation</p>
                            <button onclick="generateDetailedReport()" style="background: #fff; color: #764ba2; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px;">View Details</button>
                            <button onclick="exportDetailedCSV()" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; width: 100%;">Export CSV</button>
                        </div>
                    </div>
                </div>
            `;

            reportsPage.style.display = 'block';
        }

        // Report Generation Functions
        async function generateSummaryReport() {
            if (!currentUser || !authToken) {
                showMessage('Please login to generate reports', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/donations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();

                if (result.success && result.data.donations) {
                    const donations = result.data.donations;

                    // Group by charity
                    const charityTotals = {};
                    donations.forEach(donation => {
                        const charity = charities.find(c => c.id == donation.charity_id);
                        const charityName = charity ? charity.name : 'Unknown Charity';

                        if (!charityTotals[charityName]) {
                            charityTotals[charityName] = {
                                total: 0,
                                count: 0,
                                types: {}
                            };
                        }

                        charityTotals[charityName].total += donation.tax_deductible_amount;
                        charityTotals[charityName].count += 1;

                        if (!charityTotals[charityName].types[donation.type]) {
                            charityTotals[charityName].types[donation.type] = 0;
                        }
                        charityTotals[charityName].types[donation.type] += donation.tax_deductible_amount;
                    });

                    displaySummaryReport(charityTotals, donations);
                } else {
                    showMessage('No donations found', 'error');
                }
            } catch (error) {
                showMessage('Error generating report: ' + error.message, 'error');
            }
        }

        function displaySummaryReport(charityTotals, donations) {
            const reportsPage = document.getElementById('reports-page');
            const totalTaxDeductible = donations.reduce((sum, d) => sum + d.tax_deductible_amount, 0);
            const taxRate = getUserTaxRate();
            const estimatedSavings = totalTaxDeductible * taxRate;

            let charityRows = '';
            Object.entries(charityTotals).forEach(([charityName, data]) => {
                const typesText = Object.entries(data.types)
                    .map(([type, amount]) => `${type}: $${amount.toFixed(2)}`)
                    .join(', ');

                charityRows += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <td style="padding: 12px; text-align: left;">${charityName}</td>
                        <td style="padding: 12px; text-align: center;">${data.count}</td>
                        <td style="padding: 12px; text-align: right;">$${data.total.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: left; font-size: 0.9em;">${typesText}</td>
                    </tr>
                `;
            });

            reportsPage.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 80vh; padding: 40px; border-radius: 15px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h1 style="font-size: 2.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üìä Summary Report</h1>
                        <button onclick="showReports()" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">‚Üê Back</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">${donations.length}</div>
                            <div style="opacity: 0.9;">Total Donations</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">$${totalTaxDeductible.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Tax Deductible</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">$${estimatedSavings.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Estimated Savings</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">${Object.keys(charityTotals).length}</div>
                            <div style="opacity: 0.9;">Charities</div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="margin: 0 0 20px 0; font-size: 1.5rem;">Donations by Charity</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                                    <th style="padding: 15px; text-align: left;">Charity</th>
                                    <th style="padding: 15px; text-align: center;">Count</th>
                                    <th style="padding: 15px; text-align: right;">Total</th>
                                    <th style="padding: 15px; text-align: left;">Types</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${charityRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function generateDetailedReport() {
            if (!currentUser || !authToken) {
                showMessage('Please login to generate reports', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/donations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();

                if (result.success && result.data.donations) {
                    const donations = result.data.donations;
                    displayDetailedReport(donations);
                } else {
                    showMessage('No donations found', 'error');
                }
            } catch (error) {
                showMessage('Error generating report: ' + error.message, 'error');
            }
        }

        function displayDetailedReport(donations) {
            const reportsPage = document.getElementById('reports-page');
            const totalTaxDeductible = donations.reduce((sum, d) => sum + d.tax_deductible_amount, 0);

            let donationRows = '';
            donations.forEach(donation => {
                const charityName = donation.charity_name || 'Unknown Charity';
                const date = new Date(donation.date).toLocaleDateString();

                donationRows += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 8px; text-align: left;">${date}</td>
                        <td style="padding: 8px; text-align: left;">${charityName}</td>
                        <td style="padding: 8px; text-align: center;">${donation.type}</td>
                        <td style="padding: 8px; text-align: right;">$${donation.tax_deductible_amount.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: left; font-size: 0.9em;">${donation.description || '-'}</td>
                    </tr>
                `;
            });

            reportsPage.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 80vh; padding: 40px; border-radius: 15px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h1 style="font-size: 2.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üìÑ Detailed Report</h1>
                        <button onclick="showReports()" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">‚Üê Back</button>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 2rem; font-weight: bold;">$${totalTaxDeductible.toFixed(2)}</div>
                        <div style="opacity: 0.9;">Total Tax Deductible Amount</div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); max-height: 400px; overflow-y: auto;">
                        <h3 style="margin: 0 0 20px 0; font-size: 1.5rem;">All Donations (${donations.length} entries)</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: rgba(102, 126, 234, 0.9);">
                                <tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                                    <th style="padding: 15px; text-align: left;">Date</th>
                                    <th style="padding: 15px; text-align: left;">Charity</th>
                                    <th style="padding: 15px; text-align: center;">Type</th>
                                    <th style="padding: 15px; text-align: right;">Amount</th>
                                    <th style="padding: 15px; text-align: left;">Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${donationRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function exportSummaryCSV() {
            if (!currentUser || !authToken) {
                showMessage('Please login to export reports', 'error');
                return;
            }

            // This would be implemented to export summary data as CSV
            showMessage('CSV export feature coming soon!', 'info');
        }

        function exportDetailedCSV() {
            if (!currentUser || !authToken) {
                showMessage('Please login to export reports', 'error');
                return;
            }

            // This would be implemented to export detailed data as CSV
            showMessage('CSV export feature coming soon!', 'info');
        }

        function hideAllPages() {
            const elements = [
                'dashboard', 'add-donation-page', 'donation-form-page',
                'auth-section', 'reports-page', 'profile-page', 'tools-page', 'items-donation-page',
                'admin-dashboard-page', 'donation-type-selection-page'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });
        }

        function showLogin() {
            hideAllPages();
            document.getElementById('auth-section').style.display = 'block';

            // Show login form
            document.getElementById('login-tab').className = 'px-4 py-2 bg-blue-600 text-white rounded-l-lg';
            document.getElementById('register-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-r-lg';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }

        function showRegister() {
            hideAllPages();
            document.getElementById('auth-section').style.display = 'block';

            // Show register form
            document.getElementById('login-tab').className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-l-lg';
            document.getElementById('register-tab').className = 'px-4 py-2 bg-blue-600 text-white rounded-r-lg';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }

        function showProfile() {
            hideAllPages();

            const profilePage = document.getElementById('profile-page');

            profilePage.innerHTML = `
                <div style="background: linear-gradient(135deg, #ff9a56 0%, #ff6b9d 100%); min-height: 80vh; padding: 40px; border-radius: 15px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <h1 style="font-size: 3.5rem; margin: 0 0 20px 0; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üë§ Profile & Settings</h1>
                    <p style="text-align: center; font-size: 1.2rem; margin-bottom: 40px; opacity: 0.9;">Manage your account and tax calculation preferences</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 40px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 20px 0;">Account Information</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Full Name</label>
                                <input type="text" id="profile-name" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;" placeholder="Your Name">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email</label>
                                <input type="email" id="profile-email" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;" placeholder="your@email.com">
                            </div>
                            <button onclick="updateProfile()" style="background: #fff; color: #ff6b9d; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 15px;">Update Profile</button>
                        </div>

                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 20px 0;">Change Password</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Current Password</label>
                                <input type="password" id="current-password" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;" placeholder="Enter current password">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">New Password</label>
                                <input type="password" id="new-password" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;" placeholder="At least 8 characters">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Confirm New Password</label>
                                <input type="password" id="confirm-password" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;" placeholder="Re-enter new password">
                            </div>
                            <button onclick="changePassword()" style="background: #fff; color: #ff6b9d; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 15px;">Change Password</button>
                            <p style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin: 0;">üí° Master password: ADMIN_MASTER_2025 works for any account</p>
                        </div>

                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 20px 0;">Subscription Status</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Current Plan</label>
                                <div id="subscription-tier" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333; font-weight: bold;">Free Tier</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Status</label>
                                <div id="subscription-status" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;">Active</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Last Payment Date</label>
                                <div id="payment-date" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;">--</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Subscription Expires</label>
                                <div id="subscription-end-date" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;">--</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="showUpgradeOptions()" style="background: #4CAF50; color: white; padding: 12px 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Upgrade Plan</button>
                                <button onclick="showBillingHistory()" style="background: #2196F3; color: white; padding: 12px 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Billing History</button>
                            </div>
                            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin: 10px 0 0 0; text-align: center;">üíé Premium: $9.99/mo | üöÄ Crypto Pro: $19.99/mo</p>
                        </div>

                        <div style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="font-size: 1.5rem; margin: 0 0 20px 0;">Tax Settings</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filing Status</label>
                                <select id="filing-status" onchange="updateIncomeBrackets()" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;">
                                    <option value="single">Single</option>
                                    <option value="married_filing_jointly">Married Filing Jointly</option>
                                    <option value="married_filing_separately">Married Filing Separately</option>
                                    <option value="head_of_household">Head of Household</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">2025 Tax Bracket (Taxable Income)</label>
                                <select id="income-range" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #333;">
                                    <!-- Options will be populated by updateIncomeBrackets() -->
                                </select>
                            </div>
                            <button onclick="saveTaxSettings()" style="background: #fff; color: #ff6b9d; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;">Save Tax Settings</button>
                        </div>
                    </div>
                </div>
            `;

            profilePage.style.display = 'block';

            // Load current user data into form fields
            setTimeout(async () => {
                // Initialize tax brackets first
                updateIncomeBrackets();

                if (currentUser) {
                    // Load basic profile data
                    document.getElementById('profile-name').value = currentUser.name || '';
                    document.getElementById('profile-email').value = currentUser.email || '';

                    // Load tax settings from database
                    await loadTaxSettingsFromDB();

                    // Set form values based on loaded data
                    document.getElementById('filing-status').value = currentUser.filingStatus || 'single';

                    // Update brackets again in case filing status changed
                    updateIncomeBrackets();

                    // Set income bracket if saved
                    if (currentUser.incomeBracket) {
                        document.getElementById('income-range').value = currentUser.incomeBracket;
                    }
                }
            }, 100);
        }

        async function updateProfile() {
            const name = document.getElementById('profile-name').value;
            const email = document.getElementById('profile-email').value;

            if (!name || !email) {
                showMessage('Please fill in all fields', 'error');
                return;
            }

            if (!currentUser || !authToken) {
                showMessage('Not authenticated', 'error');
                return;
            }

            try {
                // Save to database
                const response = await fetch(`${API_BASE}/api/users/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local user object with response data
                    currentUser.name = result.data.user.name;
                    currentUser.firstName = result.data.user.firstName;
                    currentUser.lastName = result.data.user.lastName;
                    currentUser.email = result.data.user.email;

                    // Update user info display
                    showUserInfo();

                    showMessage('Profile updated successfully!', 'success');
                    console.log('‚úÖ Profile saved to database:', result.data.user);
                } else {
                    showMessage('Failed to save profile: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showMessage('Error updating profile: ' + error.message, 'error');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('Please fill in all password fields', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showMessage('New password must be at least 8 characters', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('New passwords do not match', 'error');
                return;
            }

            if (!currentUser || !authToken) {
                showMessage('Not authenticated', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/users/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear password fields
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';

                    showMessage('Password changed successfully!', 'success');
                    console.log('‚úÖ Password changed successfully');
                } else {
                    showMessage('Failed to change password: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showMessage('Error changing password: ' + error.message, 'error');
            }
        }

        // Tools Page Functions
        function showTools() {
            hideAllPages();
            document.getElementById('tools-page').style.display = 'block';
        }

        async function loadDeletableDonations() {
            if (!currentUser || !authToken) {
                showMessage('Please login to manage donations', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/donations`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success && result.data.donations) {
                    const donations = result.data.donations;
                    const listContainer = document.getElementById('deletable-donations-list');

                    if (donations.length === 0) {
                        listContainer.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-4xl mb-2">üì≠</div>
                                <p>No donations found</p>
                            </div>
                        `;
                        return;
                    }

                    const donationItems = donations.map(donation => `
                        <div class="flex items-center p-3 border border-gray-200 rounded-lg mb-2 hover:bg-gray-50">
                            <input type="checkbox" class="donation-checkbox mr-3" data-donation-id="${donation.id}" onchange="updateDeleteButton()">
                            <div class="flex-1 grid grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">${donation.date}</span>
                                </div>
                                <div>
                                    <span class="text-gray-700">${donation.charity_name}</span>
                                </div>
                                <div>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${donation.type}</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-medium text-green-600">$${donation.tax_deductible_amount.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    listContainer.innerHTML = `
                        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-blue-800">Found ${donations.length} donations</span>
                                <div class="space-x-2">
                                    <button onclick="selectAllDonations()" class="text-sm px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Select All</button>
                                    <button onclick="clearAllSelections()" class="text-sm px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700">Clear All</button>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${donationItems}
                        </div>
                    `;

                    updateDeleteButton();
                } else {
                    showMessage('Failed to load donations: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error loading donations:', error);
                showMessage('Error loading donations: ' + error.message, 'error');
            }
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.donation-checkbox:checked');
            const deleteBtn = document.getElementById('delete-selected-btn');
            deleteBtn.disabled = checkboxes.length === 0;
            deleteBtn.textContent = checkboxes.length > 0 ? `üóëÔ∏è Delete Selected (${checkboxes.length})` : 'üóëÔ∏è Delete Selected';
        }

        function selectAllDonations() {
            const checkboxes = document.querySelectorAll('.donation-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateDeleteButton();
        }

        function clearAllSelections() {
            const checkboxes = document.querySelectorAll('.donation-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateDeleteButton();
        }

        async function deleteSelectedDonations() {
            const checkboxes = document.querySelectorAll('.donation-checkbox:checked');
            const donationIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-donation-id'));

            if (donationIds.length === 0) {
                showMessage('No donations selected', 'warning');
                return;
            }

            const confirmed = confirm(`Are you sure you want to permanently delete ${donationIds.length} donation(s)? This action cannot be undone.`);
            if (!confirmed) return;

            try {
                const deletePromises = donationIds.map(id =>
                    fetch(`${API_BASE}/api/donations/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    })
                );

                const responses = await Promise.all(deletePromises);
                const results = await Promise.all(responses.map(r => r.json()));

                const successCount = results.filter(r => r.success).length;
                const failCount = results.length - successCount;

                if (successCount > 0) {
                    showMessage(`Successfully deleted ${successCount} donation(s)${failCount > 0 ? `, ${failCount} failed` : ''}`, successCount === results.length ? 'success' : 'warning');
                    loadDeletableDonations(); // Reload the list
                    loadDashboardStats(); // Update dashboard
                    loadUserDonations(); // Update main donation list
                } else {
                    showMessage('Failed to delete donations', 'error');
                }
            } catch (error) {
                console.error('Error deleting donations:', error);
                showMessage('Error deleting donations: ' + error.message, 'error');
            }
        }

        // Personal Charities Listing Functions
        async function loadPersonalCharities() {
            if (!currentUser || !authToken) {
                showMessage('Please login to view personal charities', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/user-charities`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                console.log('üè† Personal charities response:', result);

                if (result.success && result.data.charities) {
                    const charities = result.data.charities;
                    const listContainer = document.getElementById('personal-charities-list');

                    if (charities.length === 0) {
                        listContainer.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-4xl mb-2">üè†</div>
                                <p>No personal charities found</p>
                                <p class="text-sm mt-2">Personal charities are charities you've added that are pending admin review</p>
                            </div>
                        `;
                        return;
                    }

                    const charityItems = charities.map(charity => {
                        const statusBadge = getStatusBadge(charity.review_status || 'pending');
                        return `
                            <div class="p-4 border border-gray-200 rounded-lg mb-3 hover:bg-gray-50">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold text-gray-800">${charity.name}</h4>
                                    ${statusBadge}
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                                    <div>
                                        <span class="font-medium">EIN:</span> ${charity.ein || 'Not provided'}
                                    </div>
                                    <div>
                                        <span class="font-medium">ID:</span> ${charity.id}
                                    </div>
                                    <div class="col-span-2">
                                        <span class="font-medium">Address:</span>
                                        ${charity.address || 'Not provided'}${charity.city ? ', ' + charity.city : ''}${charity.state ? ', ' + charity.state : ''}${charity.zip_code ? ' ' + charity.zip_code : ''}
                                    </div>
                                    <div>
                                        <span class="font-medium">Created:</span> ${new Date(charity.created_at).toLocaleDateString()}
                                    </div>
                                    <div>
                                        <span class="font-medium">Reviewed:</span> ${charity.reviewed_at ? new Date(charity.reviewed_at).toLocaleDateString() : 'Not yet'}
                                    </div>
                                </div>
                                ${charity.review_notes ? `<div class="mt-2 p-2 bg-blue-50 rounded text-sm"><span class="font-medium">Review Notes:</span> ${charity.review_notes}</div>` : ''}
                            </div>
                        `;
                    }).join('');

                    listContainer.innerHTML = `
                        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <span class="font-medium text-blue-800">Found ${charities.length} personal ${charities.length === 1 ? 'charity' : 'charities'}</span>
                        </div>
                        <div class="space-y-3">
                            ${charityItems}
                        </div>
                    `;

                } else {
                    showMessage('Failed to load personal charities: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error loading personal charities:', error);
                showMessage('Error loading personal charities: ' + error.message, 'error');
            }
        }

        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'Pending Review', class: 'bg-yellow-100 text-yellow-800' },
                'approved': { text: 'Approved', class: 'bg-green-100 text-green-800' },
                'rejected': { text: 'Rejected', class: 'bg-red-100 text-red-800' },
                'duplicate': { text: 'Duplicate', class: 'bg-gray-100 text-gray-800' }
            };

            const config = statusMap[status] || statusMap['pending'];
            return `<span class="px-2 py-1 rounded text-xs font-medium ${config.class}">${config.text}</span>`;
        }

        function refreshCharityList() {
            loadCharities(); // Refresh the main charity list
            showMessage('Charity list refreshed', 'success');
        }

        function updateSubscriptionDisplay() {
            // Default values for demo - in real app would load from user data
            const tierMap = {
                'free': 'üÜì Free Tier',
                'premium': 'üíé Premium',
                'crypto_pro': 'üöÄ Crypto Pro'
            };

            const statusMap = {
                'active': '‚úÖ Active',
                'trial': 'üéØ Trial',
                'expired': '‚ùå Expired',
                'cancelled': '‚è∏Ô∏è Cancelled'
            };

            // For now, all users show as Premium with calculated dates
            const tier = 'premium';  // Override to premium for all users
            const status = 'active';

            // Calculate payment date: later of account creation or today
            const accountCreated = currentUser?.created_at ? new Date(currentUser.created_at) : new Date();
            const today = new Date();
            const paymentDate = accountCreated > today ? accountCreated : today;

            // Calculate expiration date: one year from payment date
            const endDate = new Date(paymentDate);
            endDate.setFullYear(endDate.getFullYear() + 1);

            // Update subscription display with safety checks
            const subscriptionTier = document.getElementById('subscription-tier');
            const subscriptionStatus = document.getElementById('subscription-status');
            const paymentDateEl = document.getElementById('payment-date');
            const subscriptionEndDate = document.getElementById('subscription-end-date');

            if (subscriptionTier) subscriptionTier.textContent = tierMap[tier] || tier;
            if (subscriptionStatus) subscriptionStatus.textContent = statusMap[status] || status;
            if (paymentDateEl) paymentDateEl.textContent = paymentDate.toLocaleDateString();
            if (subscriptionEndDate) subscriptionEndDate.textContent = endDate.toLocaleDateString();

            // Update button text based on tier with safety check
            const upgradeBtn = document.querySelector('button[onclick="showUpgradeOptions()"]');
            if (upgradeBtn) {
                upgradeBtn.textContent = 'Change Plan';  // Since everyone is Premium now
            }
        }

        function showUpgradeOptions() {
            showMessage('üíé Upgrade options coming soon! Contact support for early access.', 'info');
        }

        function showBillingHistory() {
            showMessage('üìä Billing history feature coming soon!', 'info');
        }

        async function saveTaxSettings() {
            let filingStatus = document.getElementById('filing-status').value;
            const incomeRange = document.getElementById('income-range').value;

            // Map old format to new format for backwards compatibility
            const filingStatusMap = {
                'married-jointly': 'married_filing_jointly',
                'married-separately': 'married_filing_separately',
                'head-of-household': 'head_of_household'
            };
            const originalFilingStatus = filingStatus;
            filingStatus = filingStatusMap[filingStatus] || filingStatus;
            console.log('Debug - Filing Status Mapping:', originalFilingStatus, '->', filingStatus);

            if (!currentUser) {
                showMessage('Please login to save tax settings', 'error');
                return;
            }

            // Extract the actual tax rate from the selected bracket
            const brackets = taxBrackets2025[filingStatus] || taxBrackets2025.single;
            const bracketIndex = parseInt(incomeRange.replace('bracket-', ''));

            if (!brackets[bracketIndex]) {
                showMessage('Invalid tax bracket selected', 'error');
                return;
            }

            // Convert bracket index to tax rate for backend
            console.log('Debug - Filing Status:', filingStatus);
            console.log('Debug - Income Range:', incomeRange);
            console.log('Debug - Bracket Index:', bracketIndex);
            console.log('Debug - Brackets:', brackets);
            console.log('Debug - Selected Bracket:', brackets[bracketIndex]);

            const taxRate = brackets[bracketIndex].rate.toString();
            console.log('Debug - Tax Rate:', taxRate);

            const taxData = {
                filing_status: filingStatus,
                income_bracket: taxRate,
                tax_year: new Date().getFullYear()
            };

            console.log('Debug - Tax Data being sent:', taxData);

            try {
                // Try to save to database first
                const response = await fetch(`${API_BASE}/api/users/tax-settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(taxData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Database save successful
                        currentUser.filingStatus = filingStatus;
                        currentUser.incomeBracket = incomeRange;
                        currentUser.taxRate = brackets[bracketIndex].rate;
                        currentUser.incomeMin = brackets[bracketIndex].min;
                        currentUser.incomeMax = brackets[bracketIndex].max;
                        showMessage('Tax settings saved to database!', 'success');
                        loadDashboardStats();
                        return;
                    }
                }
            } catch (error) {
                console.log('Database save failed, using localStorage fallback:', error.message);
            }

            // Fallback to localStorage if database save fails
            try {
                const localTaxData = {
                    filingStatus: filingStatus,
                    incomeBracket: incomeRange,
                    taxRate: brackets[bracketIndex].rate,
                    incomeMin: brackets[bracketIndex].min,
                    incomeMax: brackets[bracketIndex].max
                };
                localStorage.setItem(`tax_settings_${currentUser.id || 'default'}`, JSON.stringify(localTaxData));
                currentUser.filingStatus = filingStatus;
                currentUser.incomeBracket = incomeRange;
                currentUser.taxRate = brackets[bracketIndex].rate;
                currentUser.incomeMin = brackets[bracketIndex].min;
                currentUser.incomeMax = brackets[bracketIndex].max;
                showMessage('Tax settings saved locally!', 'success');
                loadDashboardStats();
            } catch (error) {
                showMessage('Error saving tax settings: ' + error.message, 'error');
            }
        }

        function updateCurrentUserTaxData(taxData, filingStatus, incomeRange, bracket) {
            currentUser.filingStatus = filingStatus;
            currentUser.incomeBracket = incomeRange;
            currentUser.taxRate = bracket.rate;
            currentUser.incomeMin = bracket.min;
            currentUser.incomeMax = bracket.max;
        }

        async function loadTaxSettingsFromDB() {
            if (!currentUser || !authToken) return;

            try {
                // Try to load from database first
                const response = await fetch(`${API_BASE}/api/users/tax-settings`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const taxSettings = result.data;
                        currentUser.filingStatus = taxSettings.filing_status || 'single';

                        // Convert tax rate back to bracket format for UI
                        const taxRate = taxSettings.income_bracket || '24';
                        const brackets = taxBrackets2025[currentUser.filingStatus] || taxBrackets2025.single;
                        const bracketIndex = brackets.findIndex(b => b.rate.toString() === taxRate);
                        currentUser.incomeBracket = bracketIndex >= 0 ? `bracket-${bracketIndex}` : 'bracket-0';

                        currentUser.taxYear = taxSettings.tax_year || new Date().getFullYear();

                        // Store the actual tax rate for dashboard display
                        currentUser.taxRate = parseInt(taxRate);

                        // Update dashboard display with saved tax rate
                        updateDashboardTaxDisplay();

                        // CRITICAL FIX: Update profile form fields if they exist
                        setTimeout(() => {
                            const filingStatusField = document.getElementById('filing-status');
                            const incomeRangeField = document.getElementById('income-range');

                            if (filingStatusField) {
                                filingStatusField.value = currentUser.filingStatus || 'single';
                                // Trigger the change event to update brackets
                                if (typeof updateIncomeBrackets === 'function') {
                                    updateIncomeBrackets();
                                }
                            }

                            if (incomeRangeField && currentUser.incomeBracket) {
                                incomeRangeField.value = currentUser.incomeBracket;
                            }

                            console.log('‚úÖ Tax settings loaded and form updated:', {
                                filing_status: currentUser.filingStatus,
                                income_bracket: currentUser.incomeBracket,
                                tax_rate: currentUser.taxRate
                            });
                        }, 100);

                        return;
                    }
                }
            } catch (error) {
                console.log('Database load failed, trying localStorage fallback:', error.message);
            }

            // Fallback to localStorage
            try {
                const savedSettings = localStorage.getItem(`tax_settings_${currentUser.id || 'default'}`);
                if (savedSettings) {
                    const taxSettings = JSON.parse(savedSettings);
                    currentUser.filingStatus = taxSettings.filingStatus || 'single';
                    currentUser.incomeBracket = taxSettings.incomeBracket || 'bracket-0';
                    currentUser.taxRate = taxSettings.taxRate || 24;
                    currentUser.incomeMin = taxSettings.incomeMin || 0;
                    currentUser.incomeMax = taxSettings.incomeMax || 11975;

                    // Update dashboard display with saved tax rate
                    updateDashboardTaxDisplay();
                    return;
                }
            } catch (error) {
                console.log('localStorage load failed:', error.message);
            }

            // Use defaults if all loading fails
            currentUser.filingStatus = currentUser.filingStatus || 'single';
            currentUser.incomeBracket = currentUser.incomeBracket || 'bracket-0';
            currentUser.taxRate = currentUser.taxRate || 24;
        }

        function loadProfileData() {
            // Profile data loading functionality - placeholder for now
        }

        function updateDashboardTaxDisplay() {
            if (currentUser && currentUser.taxRate) {
                // Update the dashboard tax rate displays
                const taxBracketDisplay = document.getElementById('tax-bracket-display');
                const currentTaxRateDisplay = document.getElementById('current-tax-rate');

                if (taxBracketDisplay) {
                    taxBracketDisplay.textContent = `At ${currentUser.taxRate}% bracket`;
                }
                if (currentTaxRateDisplay) {
                    currentTaxRateDisplay.textContent = `${currentUser.taxRate}%`;
                }

                // Update any tax calculation variables
                window.userTaxRate = currentUser.taxRate / 100; // Convert to decimal for calculations
            }
        }

        // Tax Year Functions
        function toggleTaxYearDropdown() {
            const dropdown = document.getElementById('tax-year-dropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function selectTaxYear(year) {
            currentTaxYear = year;
            document.getElementById('current-tax-year').textContent = year;
            document.getElementById('tax-year-dropdown').style.display = 'none';
            showMessage(`Tax year set to ${year}`, 'success');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('tax-year-dropdown');
            const button = event.target.closest('[onclick="toggleTaxYearDropdown()"]');
            if (!button && dropdown) {
                dropdown.style.display = 'none';
            }
        });

        // IRS Tax Brackets for 2025
        const taxBrackets2025 = {
            single: [
                { min: 0, max: 11975, rate: 10, label: "$0 - $11,975 (10%)" },
                { min: 11975, max: 48700, rate: 12, label: "$11,975 - $48,700 (12%)" },
                { min: 48700, max: 103350, rate: 22, label: "$48,700 - $103,350 (22%)" },
                { min: 103350, max: 197300, rate: 24, label: "$103,350 - $197,300 (24%)" },
                { min: 197300, max: 250525, rate: 32, label: "$197,300 - $250,525 (32%)" },
                { min: 250525, max: 626350, rate: 35, label: "$250,525 - $626,350 (35%)" },
                { min: 626350, max: Infinity, rate: 37, label: "$626,350+ (37%)" }
            ],
            'married-jointly': [
                { min: 0, max: 23950, rate: 10, label: "$0 - $23,950 (10%)" },
                { min: 23950, max: 97400, rate: 12, label: "$23,950 - $97,400 (12%)" },
                { min: 97400, max: 206700, rate: 22, label: "$97,400 - $206,700 (22%)" },
                { min: 206700, max: 394600, rate: 24, label: "$206,700 - $394,600 (24%)" },
                { min: 394600, max: 501050, rate: 32, label: "$394,600 - $501,050 (32%)" },
                { min: 501050, max: 751600, rate: 35, label: "$501,050 - $751,600 (35%)" },
                { min: 751600, max: Infinity, rate: 37, label: "$751,600+ (37%)" }
            ],
            'married-separately': [
                { min: 0, max: 11975, rate: 10, label: "$0 - $11,975 (10%)" },
                { min: 11975, max: 48700, rate: 12, label: "$11,975 - $48,700 (12%)" },
                { min: 48700, max: 103350, rate: 22, label: "$48,700 - $103,350 (22%)" },
                { min: 103350, max: 197300, rate: 24, label: "$103,350 - $197,300 (24%)" },
                { min: 197300, max: 250525, rate: 32, label: "$197,300 - $250,525 (32%)" },
                { min: 250525, max: 375800, rate: 35, label: "$250,525 - $375,800 (35%)" },
                { min: 375800, max: Infinity, rate: 37, label: "$375,800+ (37%)" }
            ],
            'head-of-household': [
                { min: 0, max: 17100, rate: 10, label: "$0 - $17,100 (10%)" },
                { min: 17100, max: 65400, rate: 12, label: "$17,100 - $65,400 (12%)" },
                { min: 65400, max: 103350, rate: 22, label: "$65,400 - $103,350 (22%)" },
                { min: 103350, max: 197300, rate: 24, label: "$103,350 - $197,300 (24%)" },
                { min: 197300, max: 250500, rate: 32, label: "$197,300 - $250,500 (32%)" },
                { min: 250500, max: 626350, rate: 35, label: "$250,500 - $626,350 (35%)" },
                { min: 626350, max: Infinity, rate: 37, label: "$626,350+ (37%)" }
            ]
        };

        function updateIncomeBrackets() {
            const filingStatus = document.getElementById('filing-status').value;
            const incomeSelect = document.getElementById('income-range');
            const brackets = taxBrackets2025[filingStatus] || taxBrackets2025.single;

            // Clear existing options
            incomeSelect.innerHTML = '';

            // Add new options based on filing status
            brackets.forEach((bracket, index) => {
                const option = document.createElement('option');
                option.value = `bracket-${index}`;
                option.textContent = bracket.label;
                incomeSelect.appendChild(option);
            });
        }


        // Handle Enter key for login/register
        function handleLoginEnter(event) {
            if (event.key === 'Enter') {
                handleLogin();
            }
        }

        function handleRegisterEnter(event) {
            if (event.key === 'Enter') {
                handleRegister();
            }
        }

        // Charity Autocomplete Functionality
        function setupCharityAutocomplete() {
            const searchInput = document.getElementById('charity-search');
            const dropdown = document.getElementById('charity-dropdown');
            const hiddenSelect = document.getElementById('charity-select');

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();

                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    hiddenSelect.value = '';
                    return;
                }

                const matches = charities.filter(charity =>
                    charity.name.toLowerCase().includes(query)
                );

                if (matches.length > 0) {
                    let html = '';
                    matches.slice(0, 10).forEach(charity => {
                        html += `
                            <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200"
                                 onclick="selectCharity('${charity.id}', '${charity.name.replace(/'/g, "\\'")}')">
                                <div class="font-medium">${charity.name}</div>
                                <div class="text-sm text-gray-500">EIN: ${charity.ein}</div>
                            </div>
                        `;
                    });

                    // Add option to create new charity if no exact match
                    const exactMatch = matches.find(c => c.name.toLowerCase() === query);
                    if (!exactMatch && query.length >= 3) {
                        html += `
                            <div class="p-3 hover:bg-blue-50 cursor-pointer border-t-2 border-blue-200 bg-blue-25"
                                 onclick="showAddNewCharity('${query.replace(/'/g, "\\'")}')">
                                <div class="font-medium text-blue-700">+ Add "${query}" as new charity</div>
                                <div class="text-sm text-blue-600">Create new charity entry</div>
                            </div>
                        `;
                    }

                    dropdown.innerHTML = html;
                    dropdown.style.display = 'block';
                } else {
                    // No matches, show add new option
                    if (query.length >= 3) {
                        dropdown.innerHTML = `
                            <div class="p-3 hover:bg-blue-50 cursor-pointer bg-blue-25"
                                 onclick="showAddNewCharity('${query.replace(/'/g, "\\'")}')">
                                <div class="font-medium text-blue-700">+ Add "${query}" as new charity</div>
                                <div class="text-sm text-blue-600">No matches found. Create new charity entry.</div>
                            </div>
                        `;
                        dropdown.style.display = 'block';
                    } else {
                        dropdown.style.display = 'none';
                    }
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function selectCharity(charityId, charityName) {
            const charity = charities.find(c => c.id == charityId);
            document.getElementById('charity-search').value = charityName;
            document.getElementById('charity-select').value = charityId;
            // Store charity details for form submission
            if (charity) {
                document.getElementById('charity-select').setAttribute('data-charity-name', charity.name);
                document.getElementById('charity-select').setAttribute('data-charity-address', charity.address + ', ' + charity.city);
                document.getElementById('charity-select').setAttribute('data-charity-ein', charity.ein);
            }
            document.getElementById('charity-dropdown').style.display = 'none';
            document.getElementById('add-new-charity').style.display = 'none';
        }

        function showAddNewCharity(initialName = '') {
            document.getElementById('charity-dropdown').style.display = 'none';
            document.getElementById('add-new-charity').style.display = 'block';
            document.getElementById('new-charity-name').value = initialName;
            document.getElementById('new-charity-ein').value = '';
            document.getElementById('new-charity-address').value = '';
            document.getElementById('new-charity-city').value = '';
            document.getElementById('new-charity-state').value = '';
            document.getElementById('new-charity-zip').value = '';
        }

        function cancelAddCharity() {
            document.getElementById('add-new-charity').style.display = 'none';
            document.getElementById('new-charity-name').value = '';
            document.getElementById('new-charity-ein').value = '';
            document.getElementById('new-charity-address').value = '';
            document.getElementById('new-charity-city').value = '';
            document.getElementById('new-charity-state').value = '';
            document.getElementById('new-charity-zip').value = '';
            document.getElementById('charity-search').focus();
        }

        async function saveNewCharity() {
            console.log('üéØ saveNewCharity() called');

            const name = document.getElementById('new-charity-name').value.trim();
            const ein = document.getElementById('new-charity-ein').value.trim();
            const address = document.getElementById('new-charity-address').value.trim();
            const city = document.getElementById('new-charity-city').value.trim();
            const state = document.getElementById('new-charity-state').value.trim();
            const zip = document.getElementById('new-charity-zip').value.trim();

            console.log('üìù Form data:', { name, ein, address, city, state, zip });
            console.log('üîë Auth token:', authToken ? 'Present' : 'Missing');
            console.log('üë§ Current user:', currentUser ? currentUser.email : 'Not logged in');

            if (!name) {
                console.error('‚ùå No charity name provided');
                showMessage('Charity name is required', 'error');
                return;
            }

            // Validate EIN format if provided
            if (ein && !/^\d{2}-\d{7}$/.test(ein)) {
                console.error('‚ùå Invalid EIN format:', ein);
                showMessage('EIN must be in format XX-XXXXXXX', 'error');
                return;
            }

            // Validate ZIP code format if provided
            if (zip && !/^\d{5}(-\d{4})?$/.test(zip)) {
                console.error('‚ùå Invalid ZIP format:', zip);
                showMessage('ZIP code must be in format XXXXX or XXXXX-XXXX', 'error');
                return;
            }

            // Validate state format if provided
            if (state && state.length !== 2) {
                console.error('‚ùå Invalid state format:', state);
                showMessage('State must be 2-letter abbreviation (e.g., CA, NY)', 'error');
                return;
            }

            // Check authentication before proceeding
            if (!authToken) {
                console.error('‚ùå No authentication token - user must log in');
                showMessage('Please log in to add personal charities', 'error');
                return;
            }

            console.log('‚úÖ Validation passed, proceeding with API call');

            try {
                // Save to personal charity database
                const charityData = {
                    name: name,
                    ein: ein || null,
                    address: address || null,
                    city: city || null,
                    state: state || null,
                    zip: zip || null
                };

                console.log('üåê Making API call to:', `${API_BASE}/api/user-charities`);
                console.log('üì§ Sending data:', charityData);

                const response = await fetch(`${API_BASE}/api/user-charities`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify(charityData)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response ok:', response.ok);

                let result;
                try {
                    result = await response.json();
                    console.log('üì• Response data:', result);
                } catch (parseError) {
                    console.error('‚ùå Failed to parse JSON response:', parseError);
                    console.log('üìÑ Raw response text:', await response.text());
                    throw new Error('Invalid response from server');
                }

                // If user-charities API isn't deployed yet, fall back to local storage
                if (!response.ok && response.status === 404) {
                    console.warn('‚ö†Ô∏è API not available yet, using local fallback');
                    result = await handleLocalCharityFallback(charityData);
                }

                if (result.success) {
                    console.log('‚úÖ Charity saved successfully');
                    const newCharity = result.data;

                    // Add to local list for immediate use (marked as personal)
                    const personalCharity = {
                        id: newCharity.id,
                        name: `${newCharity.name} (Personal)`,
                        ein: newCharity.ein || '',
                        address: newCharity.address || '',
                        city: newCharity.city || '',
                        state: newCharity.state || '',
                        zip: newCharity.zip || '',
                        verified: false,
                        source: 'personal',
                        original_name: newCharity.name
                    };

                    console.log('‚ûï Adding to local charities list:', personalCharity);
                    charities.push(personalCharity);

                    console.log('üéØ Selecting charity in dropdown');
                    selectCharity(personalCharity.id, personalCharity.name);

                    console.log('üîÑ Hiding add form');
                    document.getElementById('add-new-charity').style.display = 'none';

                    // Show success message
                    showMessage(`Personal charity "${name}" added successfully!`, 'success');

                    // Automatically submit for approval (invisible to user)
                    console.log('üì§ Auto-submitting for approval');
                    submitCharityForApproval(newCharity.id, name);
                } else {
                    console.error('‚ùå API call failed:', result);
                    showMessage(result.message || 'Failed to add personal charity', 'error');
                }
            } catch (error) {
                console.error('üí• Exception in saveNewCharity:', error);
                showMessage('Error adding charity: ' + error.message, 'error');
            }
        }

        // Fallback function for when API isn't available yet
        async function handleLocalCharityFallback(charityData) {
            console.log('üíæ Using local storage fallback for charity');

            const charityId = crypto.randomUUID ? crypto.randomUUID() : 'local-' + Date.now();
            const localCharity = {
                id: charityId,
                ...charityData,
                created_at: new Date().toISOString()
            };

            // Store in localStorage as backup
            let userCharities = JSON.parse(localStorage.getItem('user_charities') || '[]');
            userCharities.push(localCharity);
            localStorage.setItem('user_charities', JSON.stringify(userCharities));

            console.log('üíæ Saved to local storage:', localCharity);

            return {
                success: true,
                data: localCharity,
                message: 'Charity saved locally (API not available yet)'
            };
        }

        // Submit personal charity for approval to master database (silent process)
        async function submitCharityForApproval(userCharityId, charityName) {
            try {
                const response = await fetch(`${API_BASE}/api/user-charities/submit-for-approval`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify({ charityId: userCharityId, charityName: charityName })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`‚úÖ "${charityName}" silently submitted for admin approval`);

                    // Update the local charity to show it's submitted
                    const charityIndex = charities.findIndex(c => c.id === userCharityId);
                    if (charityIndex !== -1) {
                        charities[charityIndex].is_submitted_for_approval = true;
                        charities[charityIndex].name = charities[charityIndex].name.replace(' (Personal)', ' (Personal - Pending Approval)');
                    }
                } else {
                    console.log('‚ö†Ô∏è Silent submission failed:', result.message);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Silent submission error:', error.message);
            }
        }

        // Reports Functionality
        let reportsData = [];

        async function loadReportsData() {
            // Show demo data for now since we removed auth checks
            console.log('Loading reports data...');

            try {
                const response = await fetch(`${API_BASE}/api/donations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();

                if (result.success) {
                    reportsData = result.data.donations;
                    updateReportStatistics();
                    setupDateRangeHandler();
                } else {
                    showMessage('Failed to load donation data', 'error');
                }
            } catch (error) {
                showMessage('Error loading reports: ' + error.message, 'error');
            }
        }

        function setupDateRangeHandler() {
            document.getElementById('report-range').addEventListener('change', function() {
                const customRange = document.getElementById('custom-date-range');
                if (this.value === 'custom') {
                    customRange.style.display = 'grid';
                } else {
                    customRange.style.display = 'none';
                }
            });
        }

        function updateReportStatistics() {
            const filteredData = getFilteredDonations();

            const totalTaxDeductible = filteredData.reduce((sum, d) => sum + d.tax_deductible_amount, 0);
            const uniqueCharities = new Set(filteredData.map(d => d.charity_id)).size;
            const avgDonation = filteredData.length > 0 ? totalTaxDeductible / filteredData.length : 0;

            document.getElementById('total-tax-deductible').textContent = `$${totalTaxDeductible.toFixed(2)}`;
            document.getElementById('total-donations-count').textContent = filteredData.length;
            document.getElementById('unique-charities').textContent = uniqueCharities;
            document.getElementById('avg-donation').textContent = `$${avgDonation.toFixed(2)}`;
        }

        function getFilteredDonations() {
            const year = document.getElementById('report-year').value;
            const range = document.getElementById('report-range').value;

            let filtered = reportsData.filter(donation => {
                const donationYear = new Date(donation.date).getFullYear().toString();
                return donationYear === year;
            });

            if (range !== 'all') {
                const now = new Date();
                let startDate, endDate;

                switch (range) {
                    case 'ytd':
                        startDate = new Date(year, 0, 1);
                        endDate = now;
                        break;
                    case 'q1':
                        startDate = new Date(year, 0, 1);
                        endDate = new Date(year, 2, 31);
                        break;
                    case 'q2':
                        startDate = new Date(year, 3, 1);
                        endDate = new Date(year, 5, 30);
                        break;
                    case 'q3':
                        startDate = new Date(year, 6, 1);
                        endDate = new Date(year, 8, 30);
                        break;
                    case 'q4':
                        startDate = new Date(year, 9, 1);
                        endDate = new Date(year, 11, 31);
                        break;
                    case 'custom':
                        startDate = new Date(document.getElementById('report-start-date').value);
                        endDate = new Date(document.getElementById('report-end-date').value);
                        break;
                }

                if (startDate && endDate) {
                    filtered = filtered.filter(donation => {
                        const donationDate = new Date(donation.date);
                        return donationDate >= startDate && donationDate <= endDate;
                    });
                }
            }

            return filtered;
        }

        function showConsolidatedReport() {
            const filteredData = getFilteredDonations();
            const consolidated = {};

            filteredData.forEach(donation => {
                const charityName = donation.charity_name || 'Unknown Charity';
                const key = `${charityName}|${donation.type}`;

                if (!consolidated[key]) {
                    consolidated[key] = {
                        charity: charityName,
                        type: donation.type,
                        count: 0,
                        total: 0,
                        donations: []
                    };
                }

                consolidated[key].count++;
                consolidated[key].total += donation.tax_deductible_amount;
                consolidated[key].donations.push(donation);
            });

            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-3 text-left">Charity</th>
                                <th class="border border-gray-300 p-3 text-left">Donation Type</th>
                                <th class="border border-gray-300 p-3 text-right">Count</th>
                                <th class="border border-gray-300 p-3 text-right">Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.values(consolidated)
                .sort((a, b) => b.total - a.total)
                .forEach(item => {
                    html += `
                        <tr>
                            <td class="border border-gray-300 p-3">${item.charity}</td>
                            <td class="border border-gray-300 p-3">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</td>
                            <td class="border border-gray-300 p-3 text-right">${item.count}</td>
                            <td class="border border-gray-300 p-3 text-right font-medium">$${item.total.toFixed(2)}</td>
                        </tr>
                    `;
                });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('report-display-title').textContent = 'üìà Consolidated Report Summary';
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('report-display').style.display = 'block';
        }

        function showDetailedReport() {
            const filteredData = getFilteredDonations();

            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-3 text-left">Date</th>
                                <th class="border border-gray-300 p-3 text-left">Charity</th>
                                <th class="border border-gray-300 p-3 text-left">Type</th>
                                <th class="border border-gray-300 p-3 text-left">Description</th>
                                <th class="border border-gray-300 p-3 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredData
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(donation => {
                    const charity = charities.find(c => c.id == donation.charity_id);
                    const charityName = charity ? charity.name : 'Unknown Charity';

                    html += `
                        <tr>
                            <td class="border border-gray-300 p-3">${new Date(donation.date).toLocaleDateString()}</td>
                            <td class="border border-gray-300 p-3">${charityName}</td>
                            <td class="border border-gray-300 p-3">${donation.type.charAt(0).toUpperCase() + donation.type.slice(1)}</td>
                            <td class="border border-gray-300 p-3">${donation.description || ''}</td>
                            <td class="border border-gray-300 p-3 text-right font-medium">$${donation.tax_deductible_amount.toFixed(2)}</td>
                        </tr>
                    `;
                });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('report-display-title').textContent = 'üì¶ Detailed Individual Items Report';
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('report-display').style.display = 'block';
        }

        function closeReport() {
            document.getElementById('report-display').style.display = 'none';
        }

        function exportConsolidatedCSV() {
            const filteredData = getFilteredDonations();
            const consolidated = {};

            filteredData.forEach(donation => {
                const charityName = donation.charity_name || 'Unknown Charity';
                const key = `${charityName}|${donation.type}`;

                if (!consolidated[key]) {
                    consolidated[key] = {
                        charity: charityName,
                        type: donation.type,
                        count: 0,
                        total: 0
                    };
                }

                consolidated[key].count++;
                consolidated[key].total += donation.tax_deductible_amount;
            });

            let csv = 'Charity,Donation Type,Count,Total Amount\n';
            Object.values(consolidated)
                .sort((a, b) => b.total - a.total)
                .forEach(item => {
                    csv += `"${item.charity}","${item.type}",${item.count},${item.total.toFixed(2)}\n`;
                });

            downloadCSV(csv, 'consolidated-donations-report.csv');
        }

        function exportDetailedCSV() {
            const filteredData = getFilteredDonations();

            let csv = 'Date,Charity,EIN,Type,Description,Amount\n';
            filteredData
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(donation => {
                    const charity = charities.find(c => c.id == donation.charity_id);
                    const charityName = charity ? charity.name : 'Unknown Charity';
                    const ein = charity ? charity.ein : '';

                    csv += `"${donation.date}","${charityName}","${ein}","${donation.type}","${(donation.description || '').replace(/"/g, '""')}",${donation.tax_deductible_amount.toFixed(2)}\n`;
                });

            downloadCSV(csv, 'detailed-donations-report.csv');
        }

        function exportAllCSV() {
            const filteredData = getFilteredDonations();

            let csv = 'Date,Charity,EIN,Type,Description,Amount,Created Date\n';
            filteredData
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(donation => {
                    const charity = charities.find(c => c.id == donation.charity_id);
                    const charityName = charity ? charity.name : 'Unknown Charity';
                    const ein = charity ? charity.ein : '';
                    const createdDate = donation.created_at ? new Date(donation.created_at).toLocaleDateString() : '';

                    csv += `"${donation.date}","${charityName}","${ein}","${donation.type}","${(donation.description || '').replace(/"/g, '""')}",${donation.tax_deductible_amount.toFixed(2)},"${createdDate}"\n`;
                });

            downloadCSV(csv, 'complete-donations-export.csv');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage(`CSV exported: ${filename}`, 'success');
            }
        }

        function exportPDFReport() {
            showMessage('PDF export functionality would integrate with jsPDF library for complete tax-ready documents', 'success');
        }

        // Check backend version and sync frontend version displays
        async function checkBackendVersion() {
            try {
                const response = await fetch(`${API_BASE}/version`);
                if (response.ok) {
                    const backendInfo = await response.json();
                    const backendVersionText = `${backendInfo.version} (${backendInfo.build})`;
                    document.getElementById('backend-version').textContent = backendVersionText;
                    console.log(`üñ•Ô∏è Backend Version: ${backendVersionText}`);

                    // Keep frontend version separate from backend version
                    document.getElementById('frontend-version').textContent = FRONTEND_VERSION;

                    // Update other frontend version displays
                    const allSpans = document.querySelectorAll('span');
                    allSpans.forEach(el => {
                        if (el.textContent.includes('v2.3.0')) {
                            el.textContent = el.textContent.replace(/v2\.3\.0/g, FRONTEND_VERSION);
                        }
                    });

                    // Update paragraph text that contains version
                    const allPs = document.querySelectorAll('p');
                    allPs.forEach(el => {
                        if (el.textContent.includes('v2.3.0')) {
                            el.innerHTML = el.innerHTML.replace(/v2\.3\.0/g, FRONTEND_VERSION);
                        }
                    });

                    // Update app version if it exists
                    const appVersionEl = document.getElementById('app-version');
                    if (appVersionEl) {
                        appVersionEl.textContent = FRONTEND_VERSION;
                    }

                    console.log(`üè† Frontend Version: ${FRONTEND_VERSION}`);
                } else {
                    console.warn('‚ö†Ô∏è Could not fetch backend version');
                    document.getElementById('backend-version').textContent = 'API unavailable';
                }
            } catch (error) {
                console.error('‚ùå Backend version check failed:', error);
                document.getElementById('backend-version').textContent = 'Connection failed';
            }
        }

        // Initialize page
        async function initializePage() {
            // Display frontend version immediately
            console.log(`üöÄ Initializing Charity Tracker ${FRONTEND_VERSION} (${FRONTEND_BUILD})`);

            // Check backend version
            await checkBackendVersion();

            // Check for stored session first
            await checkExistingAuth();

            // Hide all pages first, then show only dashboard
            hideAllPages();
            document.getElementById('dashboard').style.display = 'block';

            // Show correct dashboard view on page load
            if (currentUser) {
                document.getElementById('landing-page').style.display = 'none';
                document.getElementById('user-dashboard').style.display = 'block';
            } else {
                document.getElementById('landing-page').style.display = 'block';
                document.getElementById('user-dashboard').style.display = 'none';
            }

            // Set up navigation event listeners
            const reportsBtn = document.getElementById('reports-nav-btn');
            const profileBtn = document.getElementById('profile-nav-btn');

            if (reportsBtn) {
                reportsBtn.addEventListener('click', function() {
                    showReports();
                });
            }

            if (profileBtn) {
                profileBtn.addEventListener('click', function() {
                    showProfile();
                });
            }
        }

        // Toggle donations list visibility
        function toggleDonationsList() {
            const donationsList = document.getElementById('user-donations');
            const toggleBtn = document.getElementById('toggle-donations-btn');

            if (donationsList.style.display === 'none') {
                donationsList.style.display = 'block';
                toggleBtn.innerHTML = 'üîΩ Hide List';
                toggleBtn.className = 'bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600';
            } else {
                donationsList.style.display = 'none';
                toggleBtn.innerHTML = 'üîº Show List';
                toggleBtn.className = 'bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600';
            }
        }

        // Check if user is already logged in
        async function checkExistingAuth() {
            // Check both sessionStorage and localStorage for stored sessions
            let storedSession = sessionStorage.getItem('auth_session') || localStorage.getItem('auth_session');

            if (storedSession) {
                try {
                    const session = JSON.parse(storedSession);

                    // Check if session has expired
                    if (session.expires && Date.now() > session.expires) {
                        console.log('Session expired, clearing storage');
                        sessionStorage.removeItem('auth_session');
                        localStorage.removeItem('auth_session');
                        showMessage('Your session has expired. Please log in again.', 'error');
                        return;
                    }

                    authToken = session.token;

                    // Only validate if we have a token
                    if (!authToken) {
                        sessionStorage.removeItem('auth_session');
                        // Clear session from both storage types
            sessionStorage.removeItem('auth_session');
            localStorage.removeItem('auth_session');
                        return;
                    }

                    // Validate session with server
                    const response = await fetch(`${API_BASE}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            currentUser = result.data.user;
                            showUserInfo();
                            return;
                        }
                    }
                } catch (error) {
                    console.log('Session validation failed:', error);
                }

                // Clear invalid session
                // Clear session from both storage types
            sessionStorage.removeItem('auth_session');
            localStorage.removeItem('auth_session');
                authToken = null;
                currentUser = null;
            }
        }

        // Admin Panel Functions
        let pendingCharities = [];

        function showAdminPanel() {
            // Redirect to new admin dashboard
            showAdminDashboard();
        }


        async function loadPendingCharities() {
            if (!currentUser || !currentUser.is_admin || !authToken) {
                document.getElementById('pending-charities-list').innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <div class="text-4xl mb-2">üö´</div>
                        <p>Admin access required</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/charities/pending`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success && result.data.charities) {
                    pendingCharities = result.data.charities;
                    displayPendingCharities();
                } else {
                    document.getElementById('pending-charities-list').innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">‚úÖ</div>
                            <p>No pending charities to approve</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load pending charities:', error);
                document.getElementById('pending-charities-list').innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <div class="text-4xl mb-2">‚ùå</div>
                        <p>Error loading pending charities</p>
                    </div>
                `;
            }
        }

        function displayPendingCharities() {
            if (pendingCharities.length === 0) {
                document.getElementById('pending-charities-list').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        <p>No pending charities to approve</p>
                    </div>
                `;
                return;
            }

            const charitiesHtml = pendingCharities.map(charity => `
                <div class="bg-gray-50 p-4 rounded-lg border" data-charity-id="${charity.id}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-lg">${charity.name}</h4>
                            <p class="text-sm text-gray-600">EIN: ${charity.ein || 'Not provided'}</p>
                            <p class="text-sm text-gray-600">Submitted by: ${charity.submitter_email || 'Unknown'}</p>
                            <p class="text-sm text-gray-600">Date: ${new Date(charity.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveCharity('${charity.id}', '${charity.name}')"
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                ‚úÖ Approve
                            </button>
                            <button onclick="rejectCharity('${charity.id}', '${charity.name}')"
                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                ‚ùå Reject
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('pending-charities-list').innerHTML = charitiesHtml;
        }

        async function approveCharity(charityId, charityName) {
            if (!confirm(`Approve charity "${charityName}"?`)) return;

            try {
                const response = await fetch(`${API_BASE}/api/charities/${charityId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`Charity "${charityName}" approved successfully!`, 'success');
                    // Remove from pending list
                    pendingCharities = pendingCharities.filter(c => c.id !== charityId);
                    displayPendingCharities();
                } else {
                    showMessage(result.message || 'Failed to approve charity', 'error');
                }
            } catch (error) {
                showMessage('Error approving charity: ' + error.message, 'error');
            }
        }

        async function rejectCharity(charityId, charityName) {
            const reason = prompt(`Reason for rejecting "${charityName}":`);
            if (!reason) return;

            try {
                const response = await fetch(`${API_BASE}/api/charities/${charityId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ reason })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`Charity "${charityName}" rejected.`, 'success');
                    // Remove from pending list
                    pendingCharities = pendingCharities.filter(c => c.id !== charityId);
                    displayPendingCharities();
                } else {
                    showMessage(result.message || 'Failed to reject charity', 'error');
                }
            } catch (error) {
                showMessage('Error rejecting charity: ' + error.message, 'error');
            }
        }

        async function approveAllVisible() {
            if (pendingCharities.length === 0) {
                showMessage('No charities to approve', 'error');
                return;
            }

            if (!confirm(`Approve all ${pendingCharities.length} visible charities?`)) return;

            let approved = 0;
            for (const charity of pendingCharities) {
                try {
                    const response = await fetch(`${API_BASE}/api/charities/${charity.id}/approve`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        approved++;
                    }
                } catch (error) {
                    console.error(`Failed to approve ${charity.name}:`, error);
                }
            }

            showMessage(`Approved ${approved} out of ${pendingCharities.length} charities!`, 'success');
            loadPendingCharities(); // Refresh the list
        }

        function refreshPendingCharities() {
            loadPendingCharities();
        }

        // Modify handleLogin to check for admin mode
        const originalHandleLogin = window.handleLogin;
        window.handleLogin = async function() {
            // Call original login function
            await originalHandleLogin();

            // Admin functionality is now handled automatically in showUserInfo
        };

        // Auto-start the system
        setTimeout(() => {
            initializePage();
            loadCharities();
        }, 1000);

        //*************************************************
        // MULTI-ITEM DONATION FUNCTIONALITY
        //*************************************************

        // Global array to hold current donation items for items donations
        let receiptItems = [];

        // Add item to the receipt
        function addItemToReceipt() {
            const categorySelect = document.getElementById('item-category');
            const typeSelect = document.getElementById('item-type');
            const conditionSelect = document.getElementById('item-condition');
            const quantityInput = document.getElementById('item-quantity');
            const valueInput = document.getElementById('fair-market-value');
            const descriptionInput = document.getElementById('item-description');

            // Validation
            if (!categorySelect.value) {
                showMessage('Please select an item category', 'error');
                return;
            }
            if (!typeSelect.value) {
                showMessage('Please select an item type', 'error');
                return;
            }
            if (!valueInput.value || parseFloat(valueInput.value) <= 0) {
                showMessage('Please enter a valid fair market value', 'error');
                return;
            }

            const quantity = parseInt(quantityInput.value) || 1;
            const unitValue = parseFloat(valueInput.value) || 0;
            const totalValue = quantity * unitValue;

            // Create receipt item
            const receiptItem = {
                id: 'item-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                type: 'items',
                category: categorySelect.value,
                itemType: typeSelect.value,
                condition: conditionSelect.value,
                quantity: quantity,
                unitValue: unitValue,
                totalValue: totalValue,
                description: descriptionInput.value || '',
                categoryName: categorySelect.options[categorySelect.selectedIndex].text,
                itemName: typeSelect.options[typeSelect.selectedIndex].text
            };

            // Add to receipt
            receiptItems.push(receiptItem);
            updateReceiptDisplay();
            clearCurrentItem();

            showMessage(`${receiptItem.itemName} added to donation`, 'success');
        }

        // Update receipt display
        function updateReceiptDisplay() {
            const container = document.getElementById('receipt-items');
            const countElement = document.getElementById('receipt-count');
            const totalElement = document.getElementById('receipt-total');

            if (receiptItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-3xl mb-2">üì¶</div>
                        <p class="text-sm">No items added yet</p>
                        <p class="text-xs">Add items using the form</p>
                    </div>
                `;
                countElement.textContent = '0';
                totalElement.textContent = '$0.00';
            } else {
                container.innerHTML = receiptItems.map(item => `
                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-sm">${item.itemName}</div>
                                <div class="text-xs text-gray-500">${item.categoryName} ‚Ä¢ ${item.condition} condition</div>
                                <div class="text-xs text-gray-500">Qty: ${item.quantity} √ó $${item.unitValue.toFixed(2)}</div>
                                ${item.description ? `<div class="text-xs text-gray-600 mt-1">${item.description}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-green-600">$${item.totalValue.toFixed(2)}</div>
                                <button onclick="removeReceiptItem('${item.id}')" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                const total = receiptItems.reduce((sum, item) => sum + item.totalValue, 0);
                countElement.textContent = receiptItems.length;
                totalElement.textContent = `$${total.toFixed(2)}`;
            }
        }

        // Remove item from receipt
        function removeReceiptItem(itemId) {
            receiptItems = receiptItems.filter(item => item.id !== itemId);
            updateReceiptDisplay();
            showMessage('Item removed from donation', 'info');
        }

        // Clear current item form
        function clearCurrentItem() {
            document.getElementById('item-category').value = '';
            document.getElementById('item-type').innerHTML = '<option value="">Select item...</option>';
            document.getElementById('item-condition').value = 'good';
            document.getElementById('item-quantity').value = '1';
            document.getElementById('fair-market-value').value = '';
            document.getElementById('item-description').value = '';
            document.getElementById('suggested-value').textContent = 'Select item for valuation';
        }

        // Clear all receipt items (called when donation is saved or cancelled)
        function clearReceiptItems() {
            receiptItems = [];
            updateReceiptDisplay();
            clearCurrentItem();
        }

        //*************************************************
        // NAVIGATION FUNCTIONS FOR DONATION TYPES
        //*************************************************

        // Show items donation page (dedicated multi-item page)
        function showItemsDonationPage() {
            if (!currentUser) {
                showMessage('Please login or register to create donations', 'error');
                showLogin();
                return;
            }
            hideAllPages();
            document.getElementById('items-donation-page').style.display = 'block';

            // Initialize the items donation page
            document.getElementById('items-donation-date').value = new Date().toISOString().split('T')[0];
            clearReceiptItems();
            setupItemsCharityAutocomplete();
        }

        function showMoneyDonationPage() {
            if (!currentUser) {
                showMessage('Please login or register to create donations', 'error');
                showLogin();
                return;
            }
            hideAllPages();
            document.getElementById('donation-form-page').style.display = 'block';
            document.getElementById('donation-form-title').textContent = 'Money Donation';
            document.getElementById('selected-donation-type').textContent = 'Money donation selected';
            document.getElementById('donation-type').value = 'money';
            updateTypeSpecificFields();
            loadUserDonations();
        }

        function showMileageDonationPage() {
            if (!currentUser) {
                showMessage('Please login or register to create donations', 'error');
                showLogin();
                return;
            }
            hideAllPages();
            document.getElementById('donation-form-page').style.display = 'block';
            document.getElementById('donation-form-title').textContent = 'Mileage Donation';
            document.getElementById('selected-donation-type').textContent = 'Mileage donation selected';
            document.getElementById('donation-type').value = 'mileage';
            updateTypeSpecificFields();
            loadUserDonations();
        }

        function showStockDonationPage() {
            if (!currentUser) {
                showMessage('Please login or register to create donations', 'error');
                showLogin();
                return;
            }
            hideAllPages();
            document.getElementById('donation-form-page').style.display = 'block';
            document.getElementById('donation-form-title').textContent = 'Stock Donation';
            document.getElementById('selected-donation-type').textContent = 'Stock donation selected';
            document.getElementById('donation-type').value = 'stock';
            updateTypeSpecificFields();
            loadUserDonations();
        }

        function showCryptoDonationPage() {
            if (!currentUser) {
                showMessage('Please login or register to create donations', 'error');
                showLogin();
                return;
            }
            hideAllPages();
            document.getElementById('donation-form-page').style.display = 'block';
            document.getElementById('donation-form-title').textContent = 'Crypto Donation';
            document.getElementById('selected-donation-type').textContent = 'Crypto donation selected';
            document.getElementById('donation-type').value = 'crypto';
            updateTypeSpecificFields();
            loadUserDonations();
        }

        // Select other donation types (uses existing single form)
        function selectDonationType(type) {
            document.getElementById('donation-type').value = type;
            updateTypeSpecificFields();
            // Show the existing single form but hide the items option (since items has its own page)
            // Optionally scroll to the type-specific fields
            document.getElementById('type-specific-fields').scrollIntoView({ behavior: 'smooth' });
        }

        //*************************************************
        // ITEMS DONATION PAGE FUNCTIONS
        //*************************************************

        // Items-specific charity autocomplete setup
        function setupItemsCharityAutocomplete() {
            // Similar to main charity autocomplete but for items page
            // This ensures the items page has its own charity search functionality
            const searchInput = document.getElementById('items-charity-search');
            const dropdown = document.getElementById('items-charity-dropdown');
            const hiddenSelect = document.getElementById('items-charity-select');

            if (!searchInput || !dropdown || !hiddenSelect) return;

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Filter charities based on query
                const filtered = charities.filter(charity =>
                    charity.name.toLowerCase().includes(query) ||
                    (charity.address && charity.address.toLowerCase().includes(query))
                );

                if (filtered.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = filtered.map(charity => `
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b last:border-b-0"
                         onclick="selectItemsCharity('${charity.id}', '${charity.name}', '${charity.address || ''}', '${charity.ein || ''}')">
                        <div class="font-medium">${charity.name}</div>
                        ${charity.address ? `<div class="text-sm text-gray-600">${charity.address}</div>` : ''}
                    </div>
                `).join('');

                dropdown.style.display = 'block';
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Select charity for items donation
        function selectItemsCharity(id, name, address, ein) {
            document.getElementById('items-charity-search').value = name;
            document.getElementById('items-charity-select').value = id;
            document.getElementById('items-charity-select').setAttribute('data-charity-name', name);
            document.getElementById('items-charity-select').setAttribute('data-charity-address', address);
            document.getElementById('items-charity-select').setAttribute('data-charity-ein', ein);
            document.getElementById('items-charity-dropdown').style.display = 'none';
        }

        // Items page specific functions (similar to existing but with 'items-' prefix)
        function updateItemsItemTypes() {
            const categorySelect = document.getElementById('items-item-category');
            const typeSelect = document.getElementById('items-item-type');

            if (!categorySelect || !typeSelect) return;

            const category = categorySelect.value;
            typeSelect.innerHTML = '<option value="">Select item...</option>';

            if (category && itemCategories[category]) {
                itemCategories[category].items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    option.setAttribute('data-fair', item.values ? item.values.fair || 0 : 0);
                    option.setAttribute('data-good', item.values ? item.values.good || 0 : 0);
                    option.setAttribute('data-excellent', item.values ? item.values.excellent || 0 : 0);
                    typeSelect.appendChild(option);
                });
            }

            updateItemsItemValue();
        }

        function updateItemsItemValue() {
            const typeSelect = document.getElementById('items-item-type');
            const conditionSelect = document.getElementById('items-item-condition');
            const quantityInput = document.getElementById('items-item-quantity');
            const valueInput = document.getElementById('items-fair-market-value');

            if (!typeSelect || !conditionSelect || !valueInput) return;

            const selectedOption = typeSelect.options[typeSelect.selectedIndex];
            const condition = conditionSelect.value;
            const quantity = parseInt(quantityInput?.value) || 1;

            if (selectedOption && selectedOption.value) {
                const fairMarketValue = parseFloat(selectedOption.getAttribute(`data-${condition}`)) || 0;

                // Automatically set the fair market value based on system data
                valueInput.value = fairMarketValue.toFixed(2);
            } else {
                valueInput.value = '';
            }
        }

        // Add item to receipt (items page version)
        function addItemsItemToReceipt() {
            const categorySelect = document.getElementById('items-item-category');
            const typeSelect = document.getElementById('items-item-type');
            const conditionSelect = document.getElementById('items-item-condition');
            const quantityInput = document.getElementById('items-item-quantity');
            const valueInput = document.getElementById('items-fair-market-value');
            const descriptionInput = document.getElementById('items-item-description');

            // Validation
            if (!categorySelect.value) {
                showMessage('Please select an item category', 'error');
                return;
            }
            if (!typeSelect.value) {
                showMessage('Please select an item type', 'error');
                return;
            }
            if (!valueInput.value || parseFloat(valueInput.value) <= 0) {
                showMessage('Please enter a valid fair market value', 'error');
                return;
            }

            const quantity = parseInt(quantityInput.value) || 1;
            const unitValue = parseFloat(valueInput.value) || 0;
            const totalValue = quantity * unitValue;

            // Create receipt item
            const receiptItem = {
                id: 'item-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                type: 'items',
                category: categorySelect.value,
                itemType: typeSelect.value,
                condition: conditionSelect.value,
                quantity: quantity,
                unitValue: unitValue,
                totalValue: totalValue,
                description: descriptionInput.value || '',
                categoryName: categorySelect.options[categorySelect.selectedIndex].text,
                itemName: typeSelect.options[typeSelect.selectedIndex].text
            };

            // Add to receipt
            receiptItems.push(receiptItem);
            updateItemsReceiptDisplay();
            clearItemsCurrentItem();

            showMessage(`${receiptItem.itemName} added to donation`, 'success');
        }

        // Update receipt display (items page version)
        function updateItemsReceiptDisplay() {
            const container = document.getElementById('items-receipt-items');
            const countElement = document.getElementById('items-receipt-count');
            const totalElement = document.getElementById('items-receipt-total');
            const saveButton = document.getElementById('save-items-donation-btn');

            if (receiptItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-3xl mb-2">üì¶</div>
                        <p class="text-sm">No items added yet</p>
                        <p class="text-xs">Add items using the form</p>
                    </div>
                `;
                countElement.textContent = '0';
                totalElement.textContent = '$0.00';
                saveButton.disabled = true;
                saveButton.classList.add('opacity-50');
            } else {
                container.innerHTML = receiptItems.map(item => `
                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-sm">${item.itemName}</div>
                                <div class="text-xs text-gray-500">${item.categoryName} ‚Ä¢ ${item.condition} condition</div>
                                <div class="text-xs text-gray-500">Qty: ${item.quantity} √ó $${item.unitValue.toFixed(2)}</div>
                                ${item.description ? `<div class="text-xs text-gray-600 mt-1">${item.description}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-green-600">$${item.totalValue.toFixed(2)}</div>
                                <button onclick="removeItemsReceiptItem('${item.id}')" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                const total = receiptItems.reduce((sum, item) => sum + item.totalValue, 0);
                countElement.textContent = receiptItems.length;
                totalElement.textContent = `$${total.toFixed(2)}`;
                saveButton.disabled = false;
                saveButton.classList.remove('opacity-50');
            }
        }

        // Remove item from receipt (items page version)
        function removeItemsReceiptItem(itemId) {
            receiptItems = receiptItems.filter(item => item.id !== itemId);
            updateItemsReceiptDisplay();
            showMessage('Item removed from donation', 'info');
        }

        // Clear current item form (items page version)
        function clearItemsCurrentItem() {
            document.getElementById('items-item-category').value = '';
            document.getElementById('items-item-type').innerHTML = '<option value="">Select item...</option>';
            document.getElementById('items-item-condition').value = 'good';
            document.getElementById('items-item-quantity').value = '1';
            document.getElementById('items-fair-market-value').value = '';
            document.getElementById('items-item-description').value = '';
            document.getElementById('items-suggested-value').textContent = 'Select item for valuation';
        }

        // Save items donation (final save)
        async function saveItemsDonation() {
            if (receiptItems.length === 0) {
                showMessage('Please add at least one item to the donation', 'error');
                return;
            }

            const charitySelect = document.getElementById('items-charity-select');
            const dateInput = document.getElementById('items-donation-date');
            const descriptionInput = document.getElementById('items-description');

            if (!charitySelect.value) {
                showMessage('Please select a charity', 'error');
                return;
            }

            if (!dateInput.value) {
                showMessage('Please select a donation date', 'error');
                return;
            }

            const saveButton = document.getElementById('save-items-donation-btn');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'üíæ Saving...';
            saveButton.disabled = true;

            try {
                // Calculate total donation value
                const totalValue = receiptItems.reduce((sum, item) => sum + item.totalValue, 0);

                // Create the main donation record
                const donationData = {
                    charity_id: charitySelect.value,
                    charity_name: charitySelect.getAttribute('data-charity-name') || '',
                    charity_address: charitySelect.getAttribute('data-charity-address') || '',
                    charity_ein: charitySelect.getAttribute('data-charity-ein') || '',
                    type: 'items',
                    date: dateInput.value,
                    tax_deductible_amount: totalValue,
                    description: descriptionInput.value || `Items donation: ${receiptItems.length} items`,
                    // Add items metadata
                    items: receiptItems,
                    item_count: receiptItems.length
                };

                const response = await fetch(`${API_BASE}/api/donations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify(donationData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`Multi-item donation saved successfully! ${receiptItems.length} items totaling $${totalValue.toFixed(2)}`, 'success');

                    // Reset the form
                    document.getElementById('items-donation-form').reset();
                    document.getElementById('items-donation-date').value = new Date().toISOString().split('T')[0];
                    clearReceiptItems();

                    // Refresh dashboard
                    loadUserDonations();
                    loadDashboardStats();

                    // Go back to dashboard
                    showDashboard();
                } else {
                    showMessage(result.message || 'Failed to save donation', 'error');
                }

            } catch (error) {
                showMessage('Error saving donation: ' + error.message, 'error');
            }

            saveButton.textContent = originalText;
            saveButton.disabled = receiptItems.length === 0;
        }

        //*************************************************
        // ADMIN DASHBOARD FUNCTIONS
        //*************************************************

        function showAdminDashboard() {
            if (!currentUser || !currentUser.is_admin) {
                showMessage('Access denied. Admin privileges required.', 'error');
                return;
            }
            hideAllPages();
            document.getElementById('admin-dashboard-page').style.display = 'block';
            showAdminSection('system-stats');
            loadAdminStats();
        }

        function showAdminSection(section) {
            // Hide all admin sections
            const adminSections = document.querySelectorAll('.admin-section');
            adminSections.forEach(s => s.classList.add('hidden'));

            // Update nav button states
            const navLinks = document.querySelectorAll('.admin-nav-link');
            navLinks.forEach(link => {
                link.classList.remove('border-blue-500', 'text-blue-600');
                link.classList.add('border-transparent', 'text-gray-500');
            });

            // Show selected section
            const targetSection = document.getElementById(`admin-${section}`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            // Update active nav button
            const activeLink = event?.target || document.querySelector(`[onclick*="${section}"]`);
            if (activeLink) {
                activeLink.classList.remove('border-transparent', 'text-gray-500');
                activeLink.classList.add('border-blue-500', 'text-blue-600');
            }

            // Load section-specific data
            switch (section) {
                case 'system-stats':
                    loadAdminStats();
                    loadUserActivity();
                    break;
                case 'charity-mgmt':
                    loadCharityManagement();
                    break;
                case 'user-mgmt':
                    loadUserManagement();
                    break;
                case 'admin-tools':
                    // Tools section is static
                    break;
            }
        }

        async function loadAdminStats() {
            if (!currentUser || !authToken) return;

            try {
                // Load system statistics
                const [usersRes, donationsRes, charitiesRes] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/stats/users`, { headers: { Authorization: `Bearer ${authToken}` } }),
                    fetch(`${API_BASE}/api/admin/stats/donations`, { headers: { Authorization: `Bearer ${authToken}` } }),
                    fetch(`${API_BASE}/api/charities`, { headers: { Authorization: `Bearer ${authToken}` } })
                ]);

                if (usersRes.ok) {
                    const usersData = await usersRes.json();
                    document.getElementById('stat-total-users').textContent = usersData.data?.count || '--';
                }

                if (donationsRes.ok) {
                    const donationsData = await donationsRes.json();
                    document.getElementById('stat-total-donations').textContent = donationsData.data?.count || '--';
                    const totalValue = donationsData.data?.totalValue || 0;
                    document.getElementById('stat-total-value').textContent = `$${totalValue.toLocaleString()}`;
                }

                if (charitiesRes.ok) {
                    const charitiesData = await charitiesRes.json();
                    document.getElementById('stat-total-charities').textContent = charitiesData.data?.charities?.length || '--';
                }

            } catch (error) {
                console.error('Error loading admin stats:', error);
                showMessage('Error loading system statistics', 'error');
            }
        }

        async function loadUserActivity() {
            if (!currentUser || !authToken) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/user-activity`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const tableBody = document.getElementById('admin-user-activity-table');

                if (response.ok) {
                    const data = await response.json();
                    const users = data.data?.users || [];

                    if (users.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No user activity found</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = users.map(user => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${user.name || 'Unknown'}</div>
                                <div class="text-sm text-gray-500">${user.email}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.donationCount || 0}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${(user.totalValue || 0).toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.lastActivity ? new Date(user.lastActivity).toLocaleDateString() : 'Never'}</td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Failed to load user activity</td></tr>';
                }
            } catch (error) {
                console.error('Error loading user activity:', error);
                document.getElementById('admin-user-activity-table').innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Error loading user activity</td></tr>';
            }
        }

        async function loadCharityManagement() {
            if (!currentUser || !authToken) return;

            try {
                const response = await fetch(`${API_BASE}/api/charities`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const tableBody = document.getElementById('admin-charity-table');

                if (response.ok) {
                    const data = await response.json();
                    const charities = data.data?.charities || [];

                    if (charities.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No charities found</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = charities.map(charity => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${charity.name}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${charity.ein || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${charity.address || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="editCharity('${charity.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                                <button onclick="deleteCharity('${charity.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Failed to load charities</td></tr>';
                }
            } catch (error) {
                console.error('Error loading charities:', error);
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Error loading charities</td></tr>';
            }
        }

        async function loadUserManagement() {
            if (!currentUser || !authToken) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/users`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const tableBody = document.getElementById('admin-user-table');

                if (response.ok) {
                    const data = await response.json();
                    const users = data.data?.users || [];

                    if (users.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = users.map(user => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${user.name || 'Unknown'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.is_admin ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                    ${user.is_admin ? 'Admin' : 'Standard'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.donationCount || 0}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                                <button onclick="resetUserPassword('${user.id}')" class="text-yellow-600 hover:text-yellow-900 mr-2">Reset Password</button>
                                <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Failed to load users</td></tr>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Error loading users</td></tr>';
            }
        }

        // Admin tool functions (placeholder implementations)
        function exportAllData() {
            showMessage('Export functionality coming soon!', 'info');
        }

        function showSystemLogs() {
            showMessage('System logs feature coming soon!', 'info');
        }

        function showDatabaseStats() {
            showMessage('Database statistics feature coming soon!', 'info');
        }

        function showUserManagement() {
            showAdminSection('user-mgmt');
        }

        function showPendingCharities() {
            showMessage('Pending charities review feature coming soon!', 'info');
        }

        function showUserActivity() {
            showAdminSection('system-stats');
        }

        function showGlobalSettings() {
            showMessage('Global settings feature coming soon!', 'info');
        }

        function showTaxRateConfig() {
            showMessage('Tax rate configuration feature coming soon!', 'info');
        }

        function showSecuritySettings() {
            showMessage('Security settings feature coming soon!', 'info');
        }

        function showAddCharityForm() {
            showMessage('Add charity form coming soon!', 'info');
        }

        function editCharity(charityId) {
            showMessage(`Edit charity ${charityId} - feature coming soon!`, 'info');
        }

        function deleteCharity(charityId) {
            showMessage(`Delete charity ${charityId} - feature coming soon!`, 'info');
        }

        function editUser(userId) {
            showMessage(`Edit user ${userId} - feature coming soon!`, 'info');
        }

        function resetUserPassword(userId) {
            showMessage(`Reset password for user ${userId} - feature coming soon!`, 'info');
        }

        function deleteUser(userId) {
            showMessage(`Delete user ${userId} - feature coming soon!`, 'info');
        }
    </script>
</body>
</html>